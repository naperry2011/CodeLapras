<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Inventory Stock Tracker</title>
<link rel="stylesheet" href="src/styles/themes.css">
<link rel="stylesheet" href="src/styles/base.css">
<link rel="stylesheet" href="src/styles/components.css">
<link rel="stylesheet" href="src/styles/tables.css">
<link rel="stylesheet" href="src/styles/forms.css">
<link rel="stylesheet" href="src/styles/responsive.css">
<link rel="stylesheet" href="src/styles/print.css">

<!-- Core JavaScript Modules -->
<script src="src/js/core/utils.js"></script>
<script src="src/js/core/storage.js"></script>
<script src="src/js/core/theme.js"></script>
<script src="src/js/core/initialization.js"></script>

<!-- UI Components -->
<script src="src/js/ui/dialogs.js"></script>
<script src="src/js/ui/notifications.js"></script>
<script src="src/js/ui/forms.js"></script>
<script src="src/js/ui/form-builders.js"></script>
<script src="src/js/ui/tables.js"></script>
<script src="src/js/ui/search.js"></script>
<script src="src/js/ui/pagination.js"></script>
<script src="src/js/ui/filters.js"></script>
<script src="src/js/ui/actions.js"></script>
<script src="src/js/ui/shortcuts.js"></script>
<script src="src/js/ui/context-menu.js"></script>

<!-- Inventory Module -->
<script src="src/js/modules/inventory/products.js"></script>
<script src="src/js/modules/inventory/stock-levels.js"></script>
<script src="src/js/modules/inventory/categories.js"></script>
<script src="src/js/modules/inventory/locations.js"></script>
<script src="src/js/modules/inventory/transfers.js"></script>
<script src="src/js/modules/inventory/product-ui.js"></script>
<script src="src/js/modules/inventory/location-ui.js"></script>
<script src="src/js/modules/inventory/transfer-ui.js"></script>
<script src="src/js/modules/inventory/product-actions.js"></script>
<script src="src/js/modules/inventory/location-actions.js"></script>
<script src="src/js/modules/inventory/transfer-actions.js"></script>

<!-- Sales Module -->
<script src="src/js/modules/sales/line-items.js"></script>
<script src="src/js/modules/sales/orders.js"></script>
<script src="src/js/modules/sales/invoices.js"></script>
<script src="src/js/modules/sales/order-ui.js"></script>
<script src="src/js/modules/sales/order-actions.js"></script>
<script src="src/js/modules/sales/invoice-ui.js"></script>

<!-- Printing Module -->
<script src="src/js/printing/invoice-builder.js"></script>
<script src="src/js/printing/receipt-builder.js"></script>

<!-- Customer Module -->
<script src="src/js/modules/customers/customers.js"></script>
<script src="src/js/modules/customers/contacts.js"></script>
<script src="src/js/modules/customers/accounts.js"></script>
<script src="src/js/modules/customers/customer-ui.js"></script>
<script src="src/js/modules/customers/customer-actions.js"></script>

<!-- XLSX (SheetJS) loader: CDN fallback used only if local files aren't found -->
<script>
  // CDN-backed loader (only used if local files are missing)
  window.__ensureXLSX = (function () {
    let loading = null;
    const urls = [
      'https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.0/xlsx.full.min.js',
      './xlsx.full.min.js',
      './lib/xlsx.full.min.js'
    ];
    function load(u){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = u;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = () => reject(u);
        document.head.appendChild(s);
      });
    }
    return async function ensure(){
      if (window.XLSX) return true;
      if (loading) return loading;
      loading = (async ()=>{
        for (const u of urls){
          try {
            await load(u);
            if (window.XLSX) return true;
          } catch(_) { /* try next */ }
        }
        return false;
      })();
      return loading;
    };
  })();
</script>
</head>
<body>
<header>
  <h1>Inventory Stock Tracker</h1>
  <div class="toolbar">
    <button class="btn accent" id="btnAdd">Add Item</button>
    <label class="pill"><input type="file" id="importFile" accept=".csv,.xlsx,.xls" style="display:none"><button class="btn small" id="btnImport">Import CSV/Excel</button></label>
    <button class="btn" id="btnExport">Export CSV</button>
    <button class="btn" id="btnExportXLSX" type="button">Export Excel</button>
    <button class="btn" id="btnSettings">Settings</button>
    <label class="pill"><input type="checkbox" id="autoExport"> Auto-export on Save</label>
  </div>
  <div class="spacer"></div>
  <div class="toolbar">
    <label class="pill"><span class="muted">Search</span><input id="search" placeholder="Name, SKU, category..."></label>
    <button class="btn" id="btnTheme">Toggle Theme</button>
    <button class="btn warn" id="btnDemo">Load Demo</button>
    <button class="btn danger" id="btnReset">Reset All</button>
    <button class="btn accent" id="btnSaveNow">Save</button>
  </div>
</header>

  <!-- Cards Tab Navigation -->
  <nav id="cardTabs" class="tabs-bar">
    <a href="?view=overview" data-view="overview">Overview</a>
    <a href="?view=inventory" data-view="inventory">Inventory</a>
    <a href="?view=order" data-view="order">Order Estimator</a>
    <a href="?view=reorder" data-view="reorder">Reorder/PO</a>
    <a href="?view=kits" data-view="kits">Kits &amp; Recipes</a>
    <a href="?view=damaged" data-view="damaged">Damaged &amp; Loss</a>
    <a href="?view=invoice" data-view="invoice">Invoice Creator</a>
    <a href="?view=invoices" data-view="invoices">Invoice Tracker</a>
    <a href="?view=calendar" data-view="calendar">Calendar</a>
    <a href="?view=rentals" data-view="rentals">Rentals &amp; Subscriptions</a>
    <a href="?view=schedule" data-view="schedule">Schedule</a>
    <a href="?view=tracking" data-view="tracking">Shipment Tracking</a>
    <a href="?view=management" data-view="management">E-Management</a>
    <a href="?view=taxes" data-view="taxes">Taxes</a>
  </nav>

  <script>
    // NOTE: showDialog() and hideDialog() are now defined in src/js/ui/dialogs.js
    // This provides better animations, keyboard support, and focus management.

    // Tab navigation and single-card view logic
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view') || 'overview';
      // highlight active tab
      document.querySelectorAll('#cardTabs a').forEach(function(el) {
        // toggle active class based on selected view
        if (el.dataset.view === view) {
          el.classList.add('active');
        }
      });

      // Tab visibility: hide navigation links based on settings.tabVisibility
      if (settings) {
        settings.tabVisibility = settings.tabVisibility || {};
        document.querySelectorAll('#cardTabs a').forEach(function(el) {
          const v = el.dataset.view;
          if (v && v !== 'overview') {
            if (settings.tabVisibility[v] === false) {
              el.style.display = 'none';
            } else {
              el.style.display = '';
            }
          }
        });
        // If the current view is hidden via settings, redirect to overview
        if (settings.tabVisibility[view] === false) {
          // fallback to overview
          window.location.search = '?view=overview';
          return;
        }
      }
      // mark body with current view to allow conditional styling (e.g., calendar layout)
      document.body.classList.toggle('overview', view === 'overview');
      if (view !== 'overview') {
        // hide the overview section
        const overview = document.getElementById('overview');
        if (overview) overview.style.display = 'none';
        // hide all other card elements with data-view except selected
        document.querySelectorAll('.card[data-view]').forEach(function(el) {
          if (el.dataset.view === view) {
            el.style.display = '';
          } else {
            el.style.display = 'none';
          }
        });
      }

      // When on the overview page, inject collapse buttons into each card and the overview stats card
      if (view === 'overview') {
        const cardList = [];
        // gather top-level cards in the grid and all other asides with data-view
        document.querySelectorAll('.grid > .card, .card[data-view]').forEach(function(card) {
          // skip if card is inside another card (e.g., calendar side panels)
          if (card.closest('.cal-right')) return;
          cardList.push(card);
        });
        // also include the overview stats section if present
        const statsCard = document.getElementById('overview');
        if (statsCard) cardList.unshift(statsCard);
        cardList.forEach(function(card) {
          const header = card.querySelector('h2');
          if (!header) return;
          // ensure header uses flex so the button can align right
          header.style.display = 'flex';
          header.style.alignItems = 'center';
          // avoid adding multiple collapse buttons on reload
          if (header.querySelector('.collapse-btn')) return;
          const btn = document.createElement('button');
          btn.className = 'btn small collapse-btn';
          btn.textContent = '−';
          btn.title = 'Collapse/Expand';
          btn.style.marginLeft = 'auto';
          btn.addEventListener('click', function() {
            const collapsed = card.classList.toggle('collapsed');
            this.textContent = collapsed ? '+' : '−';
          });
          header.appendChild(btn);
        });
      }

      // When on overview, apply saved ordering of side cards and enable drag-and-drop
      if (view === 'overview') {
        const sideContainer = document.getElementById('sideCards');
        if (sideContainer) {
          // If no saved order, initialize using current order of side cards
          const currentOrder = Array.from(sideContainer.querySelectorAll(':scope > .card[data-view]')).map(function(el){ return el.dataset.view; });
          if (!Array.isArray(settings.sideOrder) || settings.sideOrder.length === 0) {
            settings.sideOrder = currentOrder;
            LS.set('inv.settings', settings);
          }
          // Reorder the DOM to match saved order
          applySideOrder();
          // Enable drag-and-drop behavior on side cards
          initSideCardDrag();
        }
        // Apply overview card visibility settings
        try {
          if (typeof updateOverviewCards === 'function') updateOverviewCards();
        } catch (ex) {}
      }

      // Bind Delete All Invoices button (if present)
      const btnDelAll = document.getElementById('btnDeleteAllInvoices');
      if (btnDelAll) {
        btnDelAll.addEventListener('click', function() {
          if (!Array.isArray(invoices) || invoices.length === 0) {
            alert('No invoices to delete.');
            return;
          }
          if (!confirm('Delete ALL invoices?')) return;
          invoices = [];
          saveAll();
          if (typeof renderInvoiceTracker === 'function') renderInvoiceTracker();
          if (typeof renderStats === 'function') renderStats();
        });
      }
    });
  </script>

  <!-- Calendar and events script -->
  <script>
    /* Calendar with navigation and events */
    let calYear, calMonth, selectedDate = null;
    let calendarEvents = [];
    // notes keyed by date; each date holds array of note strings
    let calendarNotes = {};
    // Employee management arrays
    // Holds all employee records (id, name, contact, compensation, tax info, bank, active)
    let employees = [];
    // Holds employee schedule entries (id, employeeId, date, start, end, type)
    let employeeSchedules = [];
    // Holds payroll period settings
    let payPeriod = { frequency: 'monthly', start: '', end: '' };
    // Holds payroll records for each employee and pay period
    let payrollPeriods = [];
    // Holds deduction entries for employees
    let deductions = [];

    // Holds timesheet entries for employees (id, employeeId, date, start, end)
    let employeeTimesheets = [];
    // Holds task entries for employees (id, employeeId, description, priority, status)
    let employeeTasks = [];

    // Holds rental records
    let rentals = [];
    // Holds subscription records
    let subscriptions = [];
    // Holds shipment tracking records { id, number, carrier, date }
    let shipments = [];
    function initCalendarState() {
      const now = new Date();
      calYear = now.getFullYear();
      calMonth = now.getMonth();
      selectedDate = now.toISOString().slice(0, 10);
    }
    function changeMonth(delta) {
      calMonth += delta;
      while (calMonth < 0) {
        calMonth += 12;
        calYear--;
      }
      while (calMonth > 11) {
        calMonth -= 12;
        calYear++;
      }
      renderCalendar();
    }
    function changeYear(delta) {
      calYear += delta;
      renderCalendar();
    }
    function calendarUID() {
      return 'ev' + Math.random().toString(36).substr(2, 9);
    }
    function renderCalendar() {
      const container = document.getElementById('calendarContainer');
      if (!container) return;
      const year = calYear;
      const month = calMonth;
      const today = new Date();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      let html = '';
      // navigation controls
      html += '<div class="calendar-controls">';
      html += '<button class="btn small" data-action="prev-year">&laquo; Year</button>';
      html += '<button class="btn small" data-action="prev-month">&laquo; Month</button>';
      html += '<span class="cal-label">' + monthNames[month] + ' ' + year + '</span>';
      html += '<button class="btn small" data-action="next-month">Month &raquo;</button>';
      html += '<button class="btn small" data-action="next-year">Year &raquo;</button>';
      // Add Event button allows quick event creation for the current view
      html += '<button class="btn small accent" id="calAddEventBtn" style="margin-left:auto">Add Event</button>';
      html += '</div>';
      // calendar table
      html += '<table class="calendar"><thead><tr>';
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      for (let d = 0; d < 7; d++) {
        html += '<th>' + weekdays[d] + '</th>';
      }
      html += '</tr></thead><tbody>';
      let day = 1;
      // first week
      html += '<tr>';
      for (let i = 0; i < firstDay; i++) {
        html += '<td></td>';
      }
      for (let i = firstDay; i < 7; i++) {
        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        let cls = '';
        if (dateStr === selectedDate) cls += ' selected';
        if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cls += ' today';
        html += '<td data-date="' + dateStr + '" class="' + cls.trim() + '">' + day + '</td>';
        day++;
      }
      html += '</tr>';
      // subsequent weeks
      while (day <= daysInMonth) {
        html += '<tr>';
        for (let i = 0; i < 7; i++) {
          if (day <= daysInMonth) {
            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            let cls = '';
            if (dateStr === selectedDate) cls += ' selected';
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cls += ' today';
            html += '<td data-date="' + dateStr + '" class="' + cls.trim() + '">' + day + '</td>';
            day++;
          } else {
            html += '<td></td>';
          }
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      container.innerHTML = html;
      // attach event handlers for navigation
      const ctrl = container.querySelector('.calendar-controls');
      if (ctrl) {
        const prevYearBtn = ctrl.querySelector('[data-action="prev-year"]');
        const nextYearBtn = ctrl.querySelector('[data-action="next-year"]');
        const prevMonthBtn = ctrl.querySelector('[data-action="prev-month"]');
        const nextMonthBtn = ctrl.querySelector('[data-action="next-month"]');
        if (prevYearBtn) prevYearBtn.addEventListener('click', () => changeYear(-1));
        if (nextYearBtn) nextYearBtn.addEventListener('click', () => changeYear(1));
        if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => changeMonth(-1));
        if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => changeMonth(1));
      }
      // attach event handler for Add Event button
      const addBtn = container.querySelector('#calAddEventBtn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          // use selected date if available, otherwise first day of current month
          const defDate = selectedDate || (year + '-' + String(month + 1).padStart(2, '0') + '-01');
          openEventDialog(defDate);
        });
      }
      // attach event handlers for date cells
      container.querySelectorAll('td[data-date]').forEach(cell => {
        cell.addEventListener('click', () => {
          const date = cell.getAttribute('data-date');
          selectDate(date);
        });
      });
    }
    function selectDate(date) {
      selectedDate = date;
      renderCalendar();
      renderDateDetails();
    }
    function addCalendarEvent(date) {
      const title = prompt('Event title:', '');
      if (!title) return;
      const time = prompt('Time (HH:MM) - optional:', '');
      const notes = prompt('Notes (optional):', '');
      const alert = confirm('Set alert? (OK for yes, Cancel for no)');
      const ev = { id: calendarUID(), date: date, title: title.trim(), time: time ? time.trim() : '', notes: notes ? notes.trim() : '', alert: alert };
      calendarEvents.push(ev);
      renderUpcomingEvents();
      renderReminders();
      renderDateDetails();
    }

    // add a standalone note for a date (not tied to an event)
    function addCalendarNote(date) {
      const note = prompt('Note for ' + date + ':', '');
      if (!note) return;
      if (!calendarNotes[date]) {
        calendarNotes[date] = [];
      }
      calendarNotes[date].push(note.trim());
      renderDateDetails();
    }
    // delete a note at a given index for a date
    function deleteCalendarNote(date, idx) {
      if (!calendarNotes[date]) return;
      calendarNotes[date].splice(idx, 1);
      if (!calendarNotes[date].length) {
        delete calendarNotes[date];
      }
      renderDateDetails();
    }
    function deleteCalendarEvent(id) {
      calendarEvents = calendarEvents.filter(ev => ev.id !== id);
      renderUpcomingEvents();
      renderReminders();
      renderDateDetails();
    }
    function renderUpcomingEvents() {
      const list = document.getElementById('upcomingEvents');
      if (!list) return;
      if (!calendarEvents.length) {
        list.innerHTML = '<div class="muted">No upcoming events.</div>';
        return;
      }
      const sorted = calendarEvents.slice().sort((a, b) => {
        if (a.date === b.date) {
          return (a.time || '').localeCompare(b.time || '');
        }
        return a.date.localeCompare(b.date);
      });
      let html = '<ul style="margin:0;padding-left:16px;list-style-type:disc;">';
      sorted.forEach(ev => {
        html += '<li><strong>' + htmlEsc(ev.date + (ev.time ? ' ' + ev.time : '')) + ':</strong> ' + htmlEsc(ev.title) + '</li>';
      });
      html += '</ul>';
      list.innerHTML = html;
    }
    function renderReminders() {
      const list = document.getElementById('reminderList');
      if (!list) return;
      const reminders = calendarEvents.filter(ev => ev.alert);
      if (!reminders.length) {
        list.innerHTML = '<div class="muted">No reminders.</div>';
        return;
      }
      const sorted = reminders.slice().sort((a, b) => {
        if (a.date === b.date) {
          return (a.time || '').localeCompare(b.time || '');
        }
        return a.date.localeCompare(b.date);
      });
      let html = '<ul style="margin:0;padding-left:16px;list-style-type:disc;">';
      sorted.forEach(ev => {
        html += '<li><strong>' + htmlEsc(ev.date + (ev.time ? ' ' + ev.time : '')) + ':</strong> ' + htmlEsc(ev.title) + '</li>';
      });
      html += '</ul>';
      list.innerHTML = html;
    }
    function renderDateDetails() {
      const panel = document.getElementById('dateDetails');
      if (!panel) return;
      if (!selectedDate) {
        panel.innerHTML = '<div class="muted">Select a date to see details.</div>';
        return;
      }
      let html = '<div><strong>' + htmlEsc(selectedDate) + '</strong></div>';
      // action buttons: add event (opens modal) and note
      html += '<div style="margin:6px 0"><button class="btn small" id="addEventBtn">Add Event</button> <button class="btn small" id="addNoteBtn">Add Note</button></div>';
      // events for this date
      const events = calendarEvents.filter(ev => ev.date === selectedDate);
      if (!events.length) {
        html += '<div class="muted">No events for this date.</div>';
      } else {
        html += '<div><strong>Events:</strong></div>';
        html += '<ul style="margin:0;padding-left:16px;list-style-type:disc;">';
        events.forEach(ev => {
          html += '<li data-event-id="' + ev.id + '"><strong>' + htmlEsc(ev.time ? ev.time + ' - ' + ev.title : ev.title) + '</strong>';
          // badges for recurring and alert flags
          if (ev.recurring) html += ' <span class="badge">Recurring</span>';
          if (ev.alert) html += ' <span class="badge">Alert</span>';
          // optional notes
          if (ev.notes) html += '<br><span class="muted">' + htmlEsc(ev.notes) + '</span>';
          // optional link
          if (ev.link) html += '<br><a href="' + htmlEsc(ev.link) + '" target="_blank" class="muted">' + htmlEsc(ev.link) + '</a>';
          // optional image
          if (ev.image) html += '<br><img src="' + htmlEsc(ev.image) + '" style="max-height:60px; margin-top:4px; border-radius:6px" />';
          html += ' <button class="btn small danger delete-event">Delete</button></li>';
        });
        html += '</ul>';
      }
      // notes for this date
      const notes = calendarNotes[selectedDate] || [];
      if (notes.length) {
        html += '<div style="margin-top:6px;"><strong>Notes:</strong></div>';
        html += '<ul style="margin:0;padding-left:16px;list-style-type:circle;">';
        notes.forEach((note, idx) => {
          html += '<li><span>' + htmlEsc(note) + '</span> <button class="btn small danger delete-note" data-note-index="' + idx + '">Delete</button></li>';
        });
        html += '</ul>';
      } else {
        html += '<div class="muted" style="margin-top:6px;">No notes for this date.</div>';
      }
      panel.innerHTML = html;
      // add event handler (use modal for adding events)
      const addBtn = panel.querySelector('#addEventBtn');
      if (addBtn) {
        addBtn.addEventListener('click', () => {
          openEventDialog(selectedDate);
        });
      }
      // add note handler
      const addNoteBtn = panel.querySelector('#addNoteBtn');
      if (addNoteBtn) {
        addNoteBtn.addEventListener('click', () => {
          addCalendarNote(selectedDate);
        });
      }
      // delete event handlers
      panel.querySelectorAll('.delete-event').forEach(btn => {
        btn.addEventListener('click', () => {
          const li = btn.closest('li');
          const id = li ? li.getAttribute('data-event-id') : null;
          if (id) deleteCalendarEvent(id);
        });
      });
      // delete note handlers
      panel.querySelectorAll('.delete-note').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = parseInt(btn.getAttribute('data-note-index'), 10);
          if (!isNaN(idx)) {
            deleteCalendarNote(selectedDate, idx);
          }
        });
      });
    }

    /* === Calendar Event Dialog === */
    // Open the calendar event dialog for a given date. Initializes with one row.
    function openEventDialog(date) {
      const dlg = document.getElementById('dlgCalEvent');
      const rowsEl = document.getElementById('calEventRows');
      if (!dlg || !rowsEl) return;
      // clear any previous rows
      rowsEl.innerHTML = '';
      // remember the date on the container
      rowsEl.dataset.date = date;
      // set dialog title
      const titleEl = document.getElementById('dlgCalEventTitle');
      if (titleEl) titleEl.textContent = 'Add Events for ' + date;
      // add one empty row by default
      addEventRow();
      // show the dialog via helper
      showDialog(dlg);
    }
    // Add a new event row to the calendar event dialog
    function addEventRow() {
      const rowsEl = document.getElementById('calEventRows');
      if (!rowsEl) return;
      // create container div for row
      const row = document.createElement('div');
      row.className = 'calEventRow';
      row.style.border = '1px solid var(--border)';
      row.style.borderRadius = '12px';
      row.style.padding = '10px';
      row.style.marginBottom = '8px';
      // build inner HTML for the row
      row.innerHTML = `
        <div class="field inline" style="flex-wrap:wrap; gap:8px">
          <label class="field" style="flex:2 2 180px">Title
            <input type="text" class="evTitle" placeholder="Event title" />
          </label>
          <label class="field" style="flex:1 1 120px">Time
            <input type="time" class="evTime" />
          </label>
          <label class="field inline" style="flex:0 0 auto; align-items:center; gap:4px">
            <input type="checkbox" class="evRecurring" /> Recurring
          </label>
          <label class="field inline" style="flex:0 0 auto; align-items:center; gap:4px">
            <input type="checkbox" class="evAlert" /> Alert
          </label>
        </div>
        <div class="field" style="margin-top:8px">
          <label class="field">Notes
            <textarea class="evNotes" placeholder="Notes (optional)" rows="2"></textarea>
          </label>
        </div>
        <div class="field inline" style="margin-top:8px; flex-wrap:wrap; gap:8px">
          <label class="field" style="flex:1 1 200px">Link
            <input type="text" class="evLink" placeholder="https://example.com (optional)" />
          </label>
          <label class="field" style="flex:1 1 200px">Image URL
            <input type="text" class="evImage" placeholder="Image URL (optional)" />
          </label>
          <button type="button" class="btn small danger evRemoveRow" style="height:36px; align-self:end">Remove</button>
        </div>
      `;
      // attach remove handler
      row.querySelector('.evRemoveRow')?.addEventListener('click', () => {
        row.remove();
      });
      rowsEl.appendChild(row);
    }
    // Save all events from the calendar event dialog
    function saveEventDialog() {
      const dlg = document.getElementById('dlgCalEvent');
      const rowsEl = document.getElementById('calEventRows');
      if (!rowsEl) return;
      const date = rowsEl.dataset.date || selectedDate;
      // iterate over rows
      rowsEl.querySelectorAll('.calEventRow').forEach(row => {
        const title = row.querySelector('.evTitle')?.value?.trim() || '';
        if (!title) return; // skip empty rows
        const time = row.querySelector('.evTime')?.value?.trim() || '';
        const notes = row.querySelector('.evNotes')?.value?.trim() || '';
        const link = row.querySelector('.evLink')?.value?.trim() || '';
        const image = row.querySelector('.evImage')?.value?.trim() || '';
        const recurring = row.querySelector('.evRecurring')?.checked || false;
        const alert = row.querySelector('.evAlert')?.checked || false;
        const ev = {
          id: calendarUID(),
          date: date,
          title: title,
          time: time,
          notes: notes,
          link: link,
          image: image,
          recurring: recurring,
          alert: alert
        };
        calendarEvents.push(ev);
      });
      // hide dialog
      hideDialog(dlg);
      // re-render calendar and lists
      renderUpcomingEvents();
      renderReminders();
      renderDateDetails();
    }
    // escape HTML helpers
    function htmlEsc(str) {
      const s = String(str || '');
      return s.replace(/[&<>"']/g, function(c) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;'
        };
        map["'"] = '&#39;';
        return map[c] || c;
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      initCalendarState();
      renderCalendar();
      renderUpcomingEvents();
      renderReminders();
      renderDateDetails();
      // attach handlers for calendar event dialog buttons
      const btnAddRow = document.getElementById('btnCalAddRow');
      if (btnAddRow) btnAddRow.addEventListener('click', addEventRow);
      const btnSaveEv = document.getElementById('btnCalEventSave');
      if (btnSaveEv) btnSaveEv.addEventListener('click', saveEventDialog);
      const btnCancelEv = document.getElementById('btnCalEventCancel');
      if (btnCancelEv) btnCancelEv.addEventListener('click', () => hideDialog(document.getElementById('dlgCalEvent')));
      // render invoice tracker when calendar and invoice systems are ready
      if (typeof renderInvoiceTracker === 'function') {
        renderInvoiceTracker();
      }

      // ===== Initialise employee management and taxes =====
      // Load employees, schedules and payroll period from storage
      if (typeof loadEmployees === 'function') loadEmployees();
      if (typeof loadEmployeeSchedules === 'function') loadEmployeeSchedules();
      if (typeof loadPayPeriod === 'function') loadPayPeriod();
      // Render employees, schedules and taxes tables
      if (typeof renderEmployees === 'function') renderEmployees();
      if (typeof renderEmployeeSchedules === 'function') renderEmployeeSchedules();
      if (typeof renderTaxes === 'function') renderTaxes();
      // Bind buttons for employee and shift dialogs
      const btnAddEmp = document.getElementById('btnAddEmployee');
      if (btnAddEmp) btnAddEmp.addEventListener('click', () => openEmployeeDialog(null));
      const btnSaveEmp = document.getElementById('btnSaveEmployee');
      if (btnSaveEmp) btnSaveEmp.addEventListener('click', saveEmployeeDialog);
      const btnCancelEmp = document.getElementById('btnCancelEmployee');
      if (btnCancelEmp) btnCancelEmp.addEventListener('click', () => hideDialog(document.getElementById('dlgEmployee')));
      const btnAddShift = document.getElementById('btnAddShift');
      if (btnAddShift) btnAddShift.addEventListener('click', () => openShiftDialog(null));
      const btnSaveShift = document.getElementById('btnSaveShift');
      if (btnSaveShift) btnSaveShift.addEventListener('click', saveShiftDialog);
      const btnCancelShift = document.getElementById('btnCancelShift');
      if (btnCancelShift) btnCancelShift.addEventListener('click', () => hideDialog(document.getElementById('dlgShift')));
      const btnPeriod = document.getElementById('btnSetPayPeriod');
      if (btnPeriod) btnPeriod.addEventListener('click', updatePayPeriod);
      // Bind print buttons to call renderTaxes() then trigger window.print()
      const btnPrintBiz = document.getElementById('btnPrintBusinessTax');
      if (btnPrintBiz) btnPrintBiz.addEventListener('click', () => { if (typeof renderTaxes === 'function') renderTaxes(); try { window.print(); } catch (e) {} });
      const btnPrintEmp = document.getElementById('btnPrintEmployeeTaxes');
      if (btnPrintEmp) btnPrintEmp.addEventListener('click', () => { if (typeof renderTaxes === 'function') renderTaxes(); try { window.print(); } catch (e) {} });

      // ===== Initialise payroll and deductions management =====
      if (typeof loadPayrollPeriods === 'function') loadPayrollPeriods();
      if (typeof loadDeductions === 'function') loadDeductions();
      // Render payroll and deductions tables
      if (typeof renderPayroll === 'function') renderPayroll();
      if (typeof renderDeductions === 'function') renderDeductions();
      // Update pay tracker for overview
      if (typeof updatePayTracker === 'function') updatePayTracker();

      // ===== Initialise rentals and subscriptions management =====
      try {
        if (typeof loadRentals === 'function') loadRentals();
        if (typeof loadSubscriptions === 'function') loadSubscriptions();
        if (typeof loadShipments === 'function') loadShipments();
        if (typeof renderRentals === 'function') renderRentals();
        if (typeof renderSubscriptions === 'function') renderSubscriptions();
        if (typeof renderShipments === 'function') renderShipments();
        // Bind sub-tab navigation for rentals/subscriptions
        document.querySelectorAll('#rentalsSubTabs [data-subview]').forEach(function(el){
          el.addEventListener('click', function(){
            const view = this.getAttribute('data-subview');
            if (typeof switchRentalSubView === 'function') switchRentalSubView(view);
          });
        });
        // Set default subview to rentals on load
        if (typeof switchRentalSubView === 'function') switchRentalSubView('rentals');
        // Bind add/edit/save/cancel buttons for rentals and subscriptions
        const btnAddRental = document.getElementById('btnAddRental');
        if (btnAddRental) btnAddRental.addEventListener('click', () => openRentalDialog(null));
        const btnSaveRental = document.getElementById('btnSaveRental');
        if (btnSaveRental) btnSaveRental.addEventListener('click', saveRentalDialog);
        const btnCancelRental = document.getElementById('btnCancelRental');
        if (btnCancelRental) btnCancelRental.addEventListener('click', () => hideDialog(document.getElementById('dlgRental')));
        const btnAddSubscription = document.getElementById('btnAddSubscription');
        if (btnAddSubscription) btnAddSubscription.addEventListener('click', () => openSubscriptionDialog(null));
        const btnSaveSubscription = document.getElementById('btnSaveSubscription');
        if (btnSaveSubscription) btnSaveSubscription.addEventListener('click', saveSubscriptionDialog);
        const btnCancelSubscription = document.getElementById('btnCancelSubscription');
        if (btnCancelSubscription) btnCancelSubscription.addEventListener('click', () => hideDialog(document.getElementById('dlgSubscription')));
      } catch(e) {}
      // Bind buttons for payroll and deductions
      const btnRun = document.getElementById('btnRunPayroll');
      if (btnRun) btnRun.addEventListener('click', runPayroll);
      const btnAddDed = document.getElementById('btnAddDeduction');
      if (btnAddDed) btnAddDed.addEventListener('click', () => openDeductionDialog(null));
      const btnSaveDed = document.getElementById('btnSaveDeduction');
      if (btnSaveDed) btnSaveDed.addEventListener('click', saveDeductionDialog);
      const btnCancelDed = document.getElementById('btnCancelDeduction');
      if (btnCancelDed) btnCancelDed.addEventListener('click', () => hideDialog(document.getElementById('dlgDeduction')));

      // ===== Initialise timesheets and tasks management =====
      if (typeof loadEmployeeTimesheets === 'function') loadEmployeeTimesheets();
      if (typeof loadEmployeeTasks === 'function') loadEmployeeTasks();
      if (typeof renderTimesheets === 'function') renderTimesheets();
      if (typeof renderTasks === 'function') renderTasks();
      if (typeof updateEmpSelects === 'function') updateEmpSelects();
      // Bind buttons for time clock
      const btnCI = document.getElementById('btnClockIn');
      if (btnCI) btnCI.addEventListener('click', clockIn);
      const btnCO = document.getElementById('btnClockOut');
      if (btnCO) btnCO.addEventListener('click', clockOut);
      // Bind buttons for task management
      const btnAddTaskBtn = document.getElementById('btnAddTask');
      if (btnAddTaskBtn) btnAddTaskBtn.addEventListener('click', () => openTaskDialog(null));
      const btnSaveTaskBtn = document.getElementById('btnSaveTask');
      if (btnSaveTaskBtn) btnSaveTaskBtn.addEventListener('click', saveTaskDialog);
      const btnCancelTaskBtn = document.getElementById('btnCancelTask');
      if (btnCancelTaskBtn) btnCancelTaskBtn.addEventListener('click', () => hideDialog(document.getElementById('dlgTask')));

      // Bind button for shipment tracking
      const btnTrackPackageEl = document.getElementById('btnTrackPackage');
      if (btnTrackPackageEl) btnTrackPackageEl.addEventListener('click', trackPackage);

      // ===== Initialise Schedule tab =====
      // Render schedule tables if functions exist
      if (typeof renderScheduleSchedules === 'function') renderScheduleSchedules();
      if (typeof renderScheduleTimesheets === 'function') renderScheduleTimesheets();
      if (typeof renderScheduleTasks === 'function') renderScheduleTasks();
      // Initialize schedule calendar state and initial render
      if (typeof initScheduleCalendarState === 'function') initScheduleCalendarState();
      if (typeof renderScheduleCalendar === 'function') renderScheduleCalendar();
      // Bind buttons for schedule tab
      const btnSchShift = document.getElementById('btnSchAddShift');
      if (btnSchShift) btnSchShift.addEventListener('click', () => openShiftDialog(null));
      const btnSchCI = document.getElementById('btnSchClockIn');
      if (btnSchCI) btnSchCI.addEventListener('click', clockInSchedule);
      const btnSchCO = document.getElementById('btnSchClockOut');
      if (btnSchCO) btnSchCO.addEventListener('click', clockOutSchedule);
      const btnSchTask = document.getElementById('btnSchAddTask');
      if (btnSchTask) btnSchTask.addEventListener('click', () => openTaskDialog(null));

      // Bind export schedules button in schedule tab
      const btnSchExport = document.getElementById('btnSchExport');
      if (btnSchExport) btnSchExport.addEventListener('click', downloadScheduleCSV);
    });

    // Render the invoice tracker table
    function renderInvoiceTracker() {
      const tbody = document.getElementById('invoiceTrackerBody');
      if (!tbody) return;
      if (!Array.isArray(invoices) || invoices.length === 0) {
        // adjust colspan to match number of columns (6: number, date, bill to, total, paid, actions)
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No invoices yet.</td></tr>';
        return;
      }
      let html = '';
      invoices.forEach(inv => {
        const paid = inv.paid ? 'checked' : '';
        const num = inv.number || inv.id || '';
        const bill = inv.billTo || '';
        const total = Number(inv.total) || 0;
        html += '<tr>' +
          '<td>' + htmlEsc(num) + '</td>' +
          '<td>' + htmlEsc(inv.date || '') + '</td>' +
          '<td>' + htmlEsc(bill) + '</td>' +
          '<td class="right">' + fmt(total) + '</td>' +
          '<td class="center"><input type="checkbox" data-inv-id="' + htmlEsc(inv.id) + '" ' + paid + '></td>' +
          '<td class="center"><button class="btn small danger" data-del-id="' + htmlEsc(inv.id) + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      // attach event listeners to checkboxes for updating paid status
      tbody.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', e => {
          const id = e.target.getAttribute('data-inv-id');
          const inv = invoices.find(inv => inv.id === id);
          if (inv) {
            inv.paid = e.target.checked;
            saveAll();
            // update stats when paid status changes
            if (typeof renderStats === 'function') renderStats();
          }
        });
      });
      // attach event listeners to delete buttons
      tbody.querySelectorAll('button[data-del-id]').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.target.getAttribute('data-del-id');
          if (!confirm('Delete this invoice?')) return;
          invoices = invoices.filter(inv => inv.id !== id);
          saveAll();
          if (typeof renderInvoiceTracker === 'function') renderInvoiceTracker();
          if (typeof renderStats === 'function') renderStats();
        });
      });
    }

    // ========= Employee management functions =========

    // Load employees from localStorage
    function loadEmployees() {
      try {
        const saved = LS.get('inv.employees');
        employees = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        employees = [];
      }
    }
    // Save employees to localStorage
    function saveEmployees() {
      LS.set('inv.employees', JSON.stringify(employees));
    }
    // Load employee schedules from localStorage
    function loadEmployeeSchedules() {
      try {
        const saved = LS.get('inv.schedules');
        employeeSchedules = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        employeeSchedules = [];
      }
    }
    // Save employee schedules to localStorage
    function saveEmployeeSchedules() {
      LS.set('inv.schedules', JSON.stringify(employeeSchedules));
    }
    // Load payroll period
    function loadPayPeriod() {
      try {
        const saved = LS.get('inv.payPeriod');
        if (saved) {
          payPeriod = saved;
        }
      } catch (ex) {}
      const freqSel = document.getElementById('payFrequency');
      const startInput = document.getElementById('payPeriodStart');
      const endInput = document.getElementById('payPeriodEnd');
      if (freqSel) freqSel.value = payPeriod.frequency || 'monthly';
      if (startInput) startInput.value = payPeriod.start || '';
      if (endInput) endInput.value = payPeriod.end || '';
    }
    // Update payroll period from inputs and save
    function updatePayPeriod() {
      payPeriod = {
        frequency: document.getElementById('payFrequency')?.value || 'monthly',
        start: document.getElementById('payPeriodStart')?.value || '',
        end: document.getElementById('payPeriodEnd')?.value || ''
      };
      LS.set('inv.payPeriod', payPeriod);
      alert('Payroll period updated.');
    }
    // Render employee list table
    function renderEmployees() {
      const tbody = document.getElementById('employeeTableBody');
      if (!tbody) return;
      if (!Array.isArray(employees) || employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No employees defined.</td></tr>';
        return;
      }
      let html = '';
      employees.forEach(emp => {
        const status = emp.active === false ? 'Inactive' : 'Active';
        html += '<tr>' +
          '<td>' + htmlEsc(emp.id || '') + '</td>' +
          '<td>' + htmlEsc(emp.name || '') + '</td>' +
          '<td>' + htmlEsc(emp.title || '') + '/' + htmlEsc(emp.department || '') + '</td>' +
          '<td class="right">' + fmt(emp.hourlyRate || 0) + '</td>' +
          '<td class="right">' + fmt(emp.salary || 0) + '</td>' +
          '<td>' + status + '</td>' +
          '<td class="center"><button class="btn small" data-act="edit" data-id="' + htmlEsc(emp.id || '') + '">Edit</button> <button class="btn small danger" data-act="del" data-id="' + htmlEsc(emp.id || '') + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      // Attach actions
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'edit') {
            const emp = employees.find(e => e.id === id);
            openEmployeeDialog(emp);
          } else if (act === 'del') {
            delEmployee(id);
          }
        });
      });
    }
    // Open employee dialog for editing or adding
    function openEmployeeDialog(emp) {
      const dlg = document.getElementById('dlgEmployee');
      if (!dlg) return;
      document.getElementById('dlgEmpTitle').textContent = emp ? 'Edit Employee' : 'New Employee';
      // populate fields
      // Hidden original id field and editable custom id
      $('#empId').value = emp?.id || '';
      $('#empCustomId').value = emp?.id || '';
      // Disable editing ID if existing employee? Allow editing but will update references on save
      $('#empName').value = emp?.name || '';
      $('#empEmail').value = emp?.email || '';
      $('#empPhone').value = emp?.phone || '';
      $('#empAddress').value = emp?.address || '';
      $('#empTitle').value = emp?.title || '';
      $('#empDept').value = emp?.department || '';
      $('#empRate').value = emp?.hourlyRate || '';
      $('#empOvertime').value = emp?.overtimeRate || '';
      $('#empSalary').value = emp?.salary || '';
      $('#empCommission').value = emp?.commissionRate || '';
      $('#empTaxStatus').value = emp?.taxStatus || '';
      $('#empAllowances').value = emp?.allowances || '';
      $('#empBank').value = emp?.bank || '';
      document.getElementById('empActive').checked = emp?.active !== false;
      // Render per-employee schedule, timesheet and deduction lists in the dialog
      try {
        const currentId = emp?.id || '';
        if (typeof renderEmployeeDetailSchedules === 'function') renderEmployeeDetailSchedules(currentId);
        if (typeof renderEmployeeDetailTimesheets === 'function') renderEmployeeDetailTimesheets(currentId);
        if (typeof renderEmployeeDetailDeductions === 'function') renderEmployeeDetailDeductions(currentId);
        // Attach add shift and deduction buttons to pre-fill employee ID
        const btnAS = document.getElementById('btnEmpAddShift');
        if (btnAS) {
          btnAS.onclick = function() {
            openShiftDialog({ employeeId: currentId });
          };
        }
        const btnAD = document.getElementById('btnEmpAddDeduction');
        if (btnAD) {
          btnAD.onclick = function() {
            openDeductionDialog({ employeeId: currentId });
          };
        }
      } catch (ex) {}
      showDialog(dlg);
    }
    // Save employee from dialog
    function saveEmployeeDialog() {
      const oldId = $('#empId').value;
      let newId = $('#empCustomId').value.trim() || oldId;
      if (!newId) newId = uid();
      // Check for duplicate id if new id differs
      if (newId !== oldId) {
        if (employees.some(e => e.id === newId)) {
          alert('Employee ID already exists. Please choose a unique ID.');
          return;
        }
      }
      // Update references if ID changed
      if (oldId && newId !== oldId) {
        // Update schedules, deductions, and payroll periods
        employeeSchedules.forEach(s => { if (s.employeeId === oldId) s.employeeId = newId; });
        deductions.forEach(d => { if (d.employeeId === oldId) d.employeeId = newId; });
        payrollPeriods.forEach(p => { if (p.employeeId === oldId) p.employeeId = newId; });
      }
      // Set hidden id field for next edits
      $('#empId').value = newId;
      const emp = {
        id: newId,
        name: $('#empName').value.trim(),
        email: $('#empEmail').value.trim(),
        phone: $('#empPhone').value.trim(),
        address: $('#empAddress').value.trim(),
        title: $('#empTitle').value.trim(),
        department: $('#empDept').value.trim(),
        hourlyRate: +$('#empRate').value || 0,
        overtimeRate: +$('#empOvertime').value || 0,
        salary: +$('#empSalary').value || 0,
        commissionRate: +$('#empCommission').value || 0,
        taxStatus: $('#empTaxStatus').value.trim(),
        allowances: +$('#empAllowances').value || 0,
        bank: $('#empBank').value.trim(),
        active: !!$('#empActive').checked
      };
      if (!emp.name) {
        alert('Name is required.');
        return;
      }
      const idx = employees.findIndex(e => e.id === oldId);
      if (idx >= 0) {
        employees[idx] = emp;
      } else {
        employees.push(emp);
      }
      // update employee selects for timesheets and tasks
      if (typeof updateEmpSelects === 'function') updateEmpSelects();
      saveEmployees();
      renderEmployees();
      hideDialog(document.getElementById('dlgEmployee'));
    }
    // Delete an employee
    function delEmployee(id) {
      const emp = employees.find(e => e.id === id);
      if (!emp) return;
      if (!confirm('Delete employee ' + (emp.name || id) + '?')) return;
      employees = employees.filter(e => e.id !== id);
      saveEmployees();
      renderEmployees();
      if (typeof updateEmpSelects === 'function') updateEmpSelects();
    }
    // Render employee schedules
    function renderEmployeeSchedules() {
      const tbody = document.getElementById('employeeScheduleBody');
      if (!tbody) return;
      if (!Array.isArray(employeeSchedules) || employeeSchedules.length === 0) {
        // Adjust colspan to match number of columns (Date, Employee, Start, End, Type, Role, Note, Actions)
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No shifts defined.</td></tr>';
        return;
      }
      let html = '';
      employeeSchedules.forEach(sh => {
        const emp = employees.find(e => e.id === sh.employeeId);
        const empName = emp ? emp.name : sh.employeeId;
        html += '<tr>' +
          '<td>' + htmlEsc(sh.date || '') + '</td>' +
          '<td>' + htmlEsc(empName || '') + '</td>' +
          '<td>' + htmlEsc(sh.start || '') + '</td>' +
          '<td>' + htmlEsc(sh.end || '') + '</td>' +
          '<td>' + htmlEsc(sh.type || '') + '</td>' +
          '<td style="color:' + htmlEsc(sh.color || '') + '">' + htmlEsc(sh.role || '') + '</td>' +
          '<td>' + htmlEsc(sh.note || '') + '</td>' +
          '<td class="center"><button class="btn small" data-act="editShift" data-id="' + htmlEsc(sh.id || '') + '">Edit</button> <button class="btn small danger" data-act="delShift" data-id="' + htmlEsc(sh.id || '') + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'editShift') {
            const sh = employeeSchedules.find(s => s.id === id);
            openShiftDialog(sh);
          } else if (act === 'delShift') {
            delShift(id);
          }
        });
      });
      // update the schedule tab table as well
      renderScheduleSchedules();
    }
    // Open shift dialog for editing or adding
    function openShiftDialog(sh) {
      const dlg = document.getElementById('dlgShift');
      if (!dlg) return;
      document.getElementById('dlgShiftTitle').textContent = sh ? 'Edit Shift' : 'Add Shift';
      $('#shiftId').value = sh?.id || '';
      // Populate employee options
      const selEmp = document.getElementById('shiftEmployee');
      if (selEmp) {
        selEmp.innerHTML = '';
        // Allow an unassigned (open) shift by adding a blank option at the top
        const optOpen = document.createElement('option');
        optOpen.value = '';
        optOpen.textContent = 'Open (Unassigned)';
        selEmp.appendChild(optOpen);
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          selEmp.appendChild(opt);
        });
        // If editing an existing shift that is open, value will be empty
        selEmp.value = (sh?.employeeId !== undefined ? sh.employeeId : '') || (employees[0] && employees[0].id) || '';
      }
      $('#shiftDate').value = sh?.date || '';
      $('#shiftStart').value = sh?.start || '';
      $('#shiftEnd').value = sh?.end || '';
      $('#shiftType').value = sh?.type || 'shift';
      // Pre-fill new fields for role, colour, notes and recurrence
      $('#shiftRole').value = sh?.role || '';
      $('#shiftColor').value = sh?.color || '#18d47b';
      $('#shiftNotes').value = sh?.note || '';
      $('#shiftRepeatFreq').value = sh?.repeatFreq || '';
      $('#shiftRepeatCount').value = sh?.repeatCount || 1;
      showDialog(dlg);
    }
    // Save shift
    function saveShiftDialog() {
      const id = $('#shiftId').value || uid();
      const schedule = {
        id: id,
        employeeId: $('#shiftEmployee').value,
        date: $('#shiftDate').value,
        start: $('#shiftStart').value,
        end: $('#shiftEnd').value,
        type: $('#shiftType').value || 'shift',
        role: $('#shiftRole').value || '',
        color: $('#shiftColor').value || '#18d47b',
        note: $('#shiftNotes').value || '',
        repeatFreq: $('#shiftRepeatFreq').value || '',
        repeatCount: parseInt($('#shiftRepeatCount').value) || 1
      };
      if (!schedule.date || schedule.employeeId === undefined) {
        alert('Date and employee selection are required.');
        return;
      }
      // Check for overlapping shifts for the same employee (if not open shift)
      if (schedule.employeeId) {
        const conflict = employeeSchedules.some(sh => sh.employeeId === schedule.employeeId && sh.id !== schedule.id && sh.date === schedule.date && sh.start && sh.end && schedule.start && schedule.end && !(schedule.end <= sh.start || schedule.start >= sh.end));
        if (conflict) {
          if (!confirm('This shift overlaps with another shift for the same employee. Save anyway?')) {
            return;
          }
        }
      }
      const idx = employeeSchedules.findIndex(s => s.id === id);
      if (idx >= 0) {
        employeeSchedules[idx] = schedule;
      } else {
        employeeSchedules.push(schedule);
      }
      // Handle recurrence: create additional shifts based on repeat settings
      const freq = schedule.repeatFreq;
      const count = schedule.repeatCount;
      if (freq && count > 1) {
        // parse base date
        const baseDate = schedule.date;
        const startDate = new Date(baseDate);
        for (let i = 1; i < count; i++) {
          let d = new Date(startDate);
          if (freq === 'daily') d.setDate(d.getDate() + i);
          else if (freq === 'weekly') d.setDate(d.getDate() + 7 * i);
          else if (freq === 'monthly') d.setMonth(d.getMonth() + i);
          const isoDate = d.toISOString().slice(0, 10);
          const newSh = { ...schedule, id: uid(), date: isoDate };
          // do not repeat recurrence parameters on generated shifts
          newSh.repeatFreq = '';
          newSh.repeatCount = 1;
          employeeSchedules.push(newSh);
        }
      }
      saveEmployeeSchedules();
      // Refresh global and schedule tables
      renderEmployeeSchedules();
      renderScheduleSchedules();
      // If employee edit dialog is open, update that employee's schedule list
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailSchedules === 'function') {
            renderEmployeeDetailSchedules(currentEmp);
          }
        }
      } catch (ex) {}
      hideDialog(document.getElementById('dlgShift'));
    }
    // Delete shift
    function delShift(id) {
      const s = employeeSchedules.find(e => e.id === id);
      if (!s) return;
      if (!confirm('Delete shift on ' + (s.date || '') + '?')) return;
      employeeSchedules = employeeSchedules.filter(e => e.id !== id);
      saveEmployeeSchedules();
      renderEmployeeSchedules();
      renderScheduleSchedules();
      // Also update employee detail schedules if dialog open
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailSchedules === 'function') {
            renderEmployeeDetailSchedules(currentEmp);
          }
        }
      } catch (ex) {}
    }
    // Render taxes summary
    function renderTaxes() {
      // Business tax summary: actual revenue from paid invoices
      let gross = 0;
      let expenses = 0;
      if (Array.isArray(invoices)) {
        invoices.forEach(inv => {
          if (inv.paid) gross += Number(inv.total) || 0;
        });
      }
      const elGross = document.getElementById('taxGross');
      const elExp = document.getElementById('taxExpenses');
      const elNet = document.getElementById('taxNet');
      if (elGross) elGross.textContent = fmt(gross);
      if (elExp) elExp.textContent = fmt(expenses);
      if (elNet) elNet.textContent = fmt(gross - expenses);
      // Employee tax table: placeholder values
      const tbody = document.getElementById('employeeTaxBody');
      if (tbody) {
        let html = '';
        if (Array.isArray(employees) && employees.length > 0) {
          employees.forEach(emp => {
            html += '<tr><td>' + htmlEsc(emp.name || '') + '</td><td class="right">' + fmt(0) + '</td><td class="right">' + fmt(0) + '</td><td class="right">' + fmt(0) + '</td></tr>';
          });
        } else {
          html = '<tr><td colspan="4" class="muted">No employees.</td></tr>';
        }
        tbody.innerHTML = html;
      }
    }

    /* ========= Timesheets and Tasks helpers ========= */
    // Render timesheets into the timesheet table
    function renderTimesheets() {
      const tbody = document.getElementById('timesheetBody');
      if (!tbody) return;
      if (!Array.isArray(employeeTimesheets) || employeeTimesheets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No timesheets.</td></tr>';
        return;
      }
      let html = '';
      employeeTimesheets.forEach(ts => {
        const emp = employees.find(e => e.id === ts.employeeId) || {};
        let hours = '';
        if (ts.start && ts.end) {
          const tStart = Date.parse('1970-01-01T' + ts.start + 'Z');
          const tEnd = Date.parse('1970-01-01T' + ts.end + 'Z');
          if (tEnd > tStart) {
            hours = ((tEnd - tStart) / 3600000).toFixed(2);
          }
        }
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || ts.employeeId || '') + '</td>' +
          '<td>' + htmlEsc(ts.date || '') + '</td>' +
          '<td>' + htmlEsc(ts.start || '') + '</td>' +
          '<td>' + htmlEsc(ts.end || '') + '</td>' +
          '<td class="right">' + (hours || '') + '</td>' +
          '<td class="center"><button class="btn small danger" data-act="delTS" data-id="' + htmlEsc(ts.id || '') + '">Delete</button></td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
      // attach delete handler
      tbody.querySelectorAll('button[data-act="delTS"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          delTimesheet(id);
        });
      });
      // also update schedule view timesheets
      renderScheduleTimesheets();
    }

    // Delete a timesheet entry
    function delTimesheet(id) {
      const rec = employeeTimesheets.find(t => t.id === id);
      if (!rec) return;
      if (!confirm('Delete timesheet entry?')) return;
      employeeTimesheets = employeeTimesheets.filter(t => t.id !== id);
      saveEmployeeTimesheets();
      // Update global and schedule timesheet tables
      renderTimesheets();
      renderScheduleTimesheets();
      // If employee edit dialog is open, update that employee's timesheet list
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailTimesheets === 'function') {
            renderEmployeeDetailTimesheets(currentEmp);
          }
        }
      } catch (ex) {}
    }

    // Render tasks into the table
    function renderTasks() {
      const tbody = document.getElementById('taskBody');
      if (!tbody) return;
      if (!Array.isArray(employeeTasks) || employeeTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No tasks defined.</td></tr>';
        return;
      }
      let html = '';
      employeeTasks.forEach(task => {
        const emp = employees.find(e => e.id === task.employeeId) || {};
        const statusLabel = task.status === 'done' ? 'Done' : (task.status === 'inprogress' ? 'In Progress' : 'Open');
        const priorityLabel = task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : '';
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || task.employeeId || '') + '</td>' +
          '<td>' + htmlEsc(task.desc || '') + '</td>' +
          '<td>' + htmlEsc(priorityLabel) + '</td>' +
          '<td>' + htmlEsc(statusLabel) + '</td>' +
          '<td class="center"><button class="btn small" data-act="editTask" data-id="' + htmlEsc(task.id || '') + '">Edit</button> <button class="btn small danger" data-act="delTask" data-id="' + htmlEsc(task.id || '') + '">Delete</button></td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'editTask') {
            const t = employeeTasks.find(ts => ts.id === id);
            openTaskDialog(t);
          } else if (act === 'delTask') {
            delTask(id);
          }
        });
      });
      // Also update tasks on the schedule tab
      renderScheduleTasks();
    }

    // Delete a task
    function delTask(id) {
      const rec = employeeTasks.find(t => t.id === id);
      if (!rec) return;
      if (!confirm('Delete task?')) return;
      employeeTasks = employeeTasks.filter(t => t.id !== id);
      saveEmployeeTasks();
      renderTasks();
      // also update the schedule view
      renderScheduleTasks();
    }

    /* ========= Schedule tab rendering functions ========= */
    // Render schedules into the schedule tab table
    function renderScheduleSchedules() {
      const tbody = document.getElementById('schScheduleBody');
      if (!tbody) return;
      if (!Array.isArray(employeeSchedules) || employeeSchedules.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No shifts defined.</td></tr>';
        return;
      }
      let html = '';
      employeeSchedules.forEach(sh => {
        const emp = employees.find(e => e.id === sh.employeeId);
        const empName = emp ? emp.name : (sh.employeeId || 'Open');
        html += '<tr>' +
          '<td>' + htmlEsc(sh.date || '') + '</td>' +
          '<td>' + htmlEsc(empName || '') + '</td>' +
          '<td>' + htmlEsc(sh.start || '') + '</td>' +
          '<td>' + htmlEsc(sh.end || '') + '</td>' +
          '<td>' + htmlEsc(sh.type || '') + '</td>' +
          '<td style="color:' + htmlEsc(sh.color || '') + '">' + htmlEsc(sh.role || '') + '</td>' +
          '<td>' + htmlEsc(sh.note || '') + '</td>' +
          '<td class="center"><button class="btn small" data-act="editShift" data-id="' + htmlEsc(sh.id || '') + '">Edit</button> <button class="btn small danger" data-act="delShift" data-id="' + htmlEsc(sh.id || '') + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'editShift') {
            const sh = employeeSchedules.find(s => s.id === id);
            openShiftDialog(sh);
          } else if (act === 'delShift') {
            delShift(id);
          }
        });
      });
      // update schedule calendar view if available
      if (typeof renderScheduleCalendar === 'function') renderScheduleCalendar();
    }

    // Render timesheets into the schedule tab table
    function renderScheduleTimesheets() {
      const tbody = document.getElementById('schTimesheetBody');
      if (!tbody) return;
      if (!Array.isArray(employeeTimesheets) || employeeTimesheets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No timesheets.</td></tr>';
        return;
      }
      let html = '';
      employeeTimesheets.forEach(ts => {
        const emp = employees.find(e => e.id === ts.employeeId) || {};
        let hours = '';
        if (ts.start && ts.end) {
          const tStart = Date.parse('1970-01-01T' + ts.start + 'Z');
          const tEnd = Date.parse('1970-01-01T' + ts.end + 'Z');
          if (tEnd > tStart) {
            hours = ((tEnd - tStart) / 3600000).toFixed(2);
          }
        }
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || ts.employeeId || '') + '</td>' +
          '<td>' + htmlEsc(ts.date || '') + '</td>' +
          '<td>' + htmlEsc(ts.start || '') + '</td>' +
          '<td>' + htmlEsc(ts.end || '') + '</td>' +
          '<td class="right">' + (hours || '') + '</td>' +
          '<td class="center"><button class="btn small danger" data-act="delTS" data-id="' + htmlEsc(ts.id || '') + '">Delete</button></td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act="delTS"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          delTimesheet(id);
        });
      });
    }

    // Render tasks into the schedule tab table
    function renderScheduleTasks() {
      const tbody = document.getElementById('schTaskBody');
      if (!tbody) return;
      if (!Array.isArray(employeeTasks) || employeeTasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No tasks defined.</td></tr>';
        return;
      }
      let html = '';
      employeeTasks.forEach(task => {
        const emp = employees.find(e => e.id === task.employeeId) || {};
        const statusLabel = task.status === 'done' ? 'Done' : (task.status === 'inprogress' ? 'In Progress' : 'Open');
        const priorityLabel = task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : '';
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || task.employeeId || '') + '</td>' +
          '<td>' + htmlEsc(task.desc || '') + '</td>' +
          '<td>' + htmlEsc(priorityLabel) + '</td>' +
          '<td>' + htmlEsc(statusLabel) + '</td>' +
          '<td class="center"><button class="btn small" data-act="editTask" data-id="' + htmlEsc(task.id || '') + '">Edit</button> <button class="btn small danger" data-act="delTask" data-id="' + htmlEsc(task.id || '') + '">Delete</button></td>' +
          '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'editTask') {
            const t = employeeTasks.find(ts => ts.id === id);
            openTaskDialog(t);
          } else if (act === 'delTask') {
            delTask(id);
          }
        });
      });
    }

    /* ========= Employee detail rendering functions ========= */
    // Render schedules for a specific employee inside the employee edit dialog
    function renderEmployeeDetailSchedules(empId) {
      const tbody = document.getElementById('empScheduleBody');
      if (!tbody) return;
      if (!empId || !Array.isArray(employeeSchedules)) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No shifts defined.</td></tr>';
        return;
      }
      const rows = employeeSchedules.filter(sh => sh.employeeId === empId);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No shifts defined.</td></tr>';
        return;
      }
      let html = '';
      rows.forEach(sh => {
        html += '<tr>' +
          '<td>' + htmlEsc(sh.date || '') + '</td>' +
          '<td>' + htmlEsc(sh.start || '') + '</td>' +
          '<td>' + htmlEsc(sh.end || '') + '</td>' +
          '<td>' + htmlEsc(sh.type || '') + '</td>' +
          '<td style="color:' + htmlEsc(sh.color || '') + '">' + htmlEsc(sh.role || '') + '</td>' +
          '<td>' + htmlEsc(sh.note || '') + '</td>' +
          '<td class="center"><button class="btn small" data-act="editEmpShift" data-id="' + htmlEsc(sh.id || '') + '">Edit</button> <button class="btn small danger" data-act="delEmpShift" data-id="' + htmlEsc(sh.id || '') + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const act = this.getAttribute('data-act');
          if (act === 'editEmpShift') {
            const sh = employeeSchedules.find(s => s.id === id);
            openShiftDialog(sh);
          } else if (act === 'delEmpShift') {
            delShift(id);
          }
        });
      });
    }

    // Render timesheets for a specific employee inside the employee edit dialog
    function renderEmployeeDetailTimesheets(empId) {
      const tbody = document.getElementById('empTimeBody');
      if (!tbody) return;
      if (!empId || !Array.isArray(employeeTimesheets)) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No timesheets.</td></tr>';
        return;
      }
      const rows = employeeTimesheets.filter(ts => ts.employeeId === empId);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No timesheets.</td></tr>';
        return;
      }
      let html = '';
      rows.forEach(ts => {
        let hours = '';
        if (ts.start && ts.end) {
          const tStart = Date.parse('1970-01-01T' + ts.start + 'Z');
          const tEnd = Date.parse('1970-01-01T' + ts.end + 'Z');
          if (tEnd > tStart) {
            hours = ((tEnd - tStart) / 3600000).toFixed(2);
          }
        }
        html += '<tr>' +
          '<td>' + htmlEsc(ts.date || '') + '</td>' +
          '<td>' + htmlEsc(ts.start || '') + '</td>' +
          '<td>' + htmlEsc(ts.end || '') + '</td>' +
          '<td class="right">' + (hours || '') + '</td>' +
          '<td class="center"><button class="btn small danger" data-act="delEmpTS" data-id="' + htmlEsc(ts.id || '') + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act="delEmpTS"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          delTimesheet(id);
        });
      });
    }

    // Render deductions for a specific employee inside the employee edit dialog
    function renderEmployeeDetailDeductions(empId) {
      const tbody = document.getElementById('empDedBody');
      if (!tbody) return;
      if (!empId || !Array.isArray(deductions)) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">No deductions defined.</td></tr>';
        return;
      }
      const rows = deductions.filter(d => d.employeeId === empId);
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">No deductions defined.</td></tr>';
        return;
      }
      let html = '';
      rows.forEach(d => {
        html += '<tr>' +
          '<td>' + htmlEsc(d.name || '') + '</td>' +
          '<td class="right">' + (d.percent ? ((d.amount * 100).toFixed(2) + '%') : fmt(d.amount || 0)) + '</td>' +
          '<td>' + (d.preTax ? 'Yes' : 'No') + '</td>' +
          '<td class="center"><button class="btn small danger" data-act="delEmpDed" data-id="' + d.id + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act="delEmpDed"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          if (!confirm('Delete deduction?')) return;
          deductions = deductions.filter(x => x.id !== id);
          saveDeductions();
          renderDeductions();
          const currentEmp = document.getElementById('empId');
          const empIdVal = currentEmp && currentEmp.value;
          if (empIdVal) renderEmployeeDetailDeductions(empIdVal);
        });
      });
    }

    /* ======== Schedule calendar functions ======== */
    // Variables to store the currently displayed year and month for the schedule calendar
    let schYear, schMonth;

    // Initialize schedule calendar to current month/year
    function initScheduleCalendarState() {
      const now = new Date();
      schYear = now.getFullYear();
      schMonth = now.getMonth();
    }

    // Change the displayed month by the given delta (-1 = previous month, +1 = next month)
    function changeSchMonth(delta) {
      schMonth += delta;
      while (schMonth < 0) {
        schMonth += 12;
        schYear--;
      }
      while (schMonth > 11) {
        schMonth -= 12;
        schYear++;
      }
      renderScheduleCalendar();
    }

    // Change the displayed year by the given delta (-1 = previous year, +1 = next year)
    function changeSchYear(delta) {
      schYear += delta;
      renderScheduleCalendar();
    }

    // Render the schedule calendar into the schedule tab
    function renderScheduleCalendar() {
      const container = document.getElementById('scheduleCalendarContainer');
      if (!container) return;
      const year = schYear;
      const month = schMonth;
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      let html = '';
      // Navigation controls
      html += '<div class="calendar-controls">';
      html += '<button class="btn small" data-act="schPrevYear">&laquo; Year</button>';
      html += '<button class="btn small" data-act="schPrevMonth">&laquo; Month</button>';
      html += '<div class="cal-label">' + monthNames[month] + ' ' + year + '</div>';
      html += '<button class="btn small" data-act="schNextMonth">Month &raquo;</button>';
      html += '<button class="btn small" data-act="schNextYear">Year &raquo;</button>';
      html += '</div>';
      // Table header
      html += '<table class="calendar"><thead><tr>';
      const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      days.forEach(d => { html += '<th>' + d + '</th>'; });
      html += '</tr></thead><tbody>';
      let day = 1;
      for (let row = 0; row < 6; row++) {
        html += '<tr>';
        for (let col = 0; col < 7; col++) {
          if (row === 0 && col < firstDay) {
            html += '<td></td>';
          } else if (day > daysInMonth) {
            html += '<td></td>';
          } else {
            const dateStr = year.toString().padStart(4, '0') + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            // Find all shifts scheduled for this date
            const events = (Array.isArray(employeeSchedules) ? employeeSchedules.filter(s => s.date === dateStr) : []);
            let cellHtml = '<div style="font-size:14px;font-weight:600;margin-bottom:4px">' + day + '</div>';
            events.forEach(ev => {
              const role = ev.role || ev.type || '';
              const color = ev.color || '#18d47b';
              cellHtml += '<div style="font-size:10px; color:' + htmlEsc(color) + '; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + htmlEsc(role) + '</div>';
            });
            html += '<td>' + cellHtml + '</td>';
            day++;
          }
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      container.innerHTML = html;
      // Bind navigation buttons
      container.querySelectorAll('button[data-act]').forEach(btn => {
        btn.addEventListener('click', function() {
          const act = this.getAttribute('data-act');
          if (act === 'schPrevMonth') changeSchMonth(-1);
          else if (act === 'schNextMonth') changeSchMonth(1);
          else if (act === 'schPrevYear') changeSchYear(-1);
          else if (act === 'schNextYear') changeSchYear(1);
        });
      });
    }
    // Clock in for schedule tab
    function clockInSchedule() {
      const sel = document.getElementById('schTimeEmpSelect');
      const empId = sel?.value;
      if (!empId) return alert('Select an employee first.');
      const now = new Date();
      const date = now.toISOString().slice(0, 10);
      const time = now.toISOString().slice(11, 16);
      employeeTimesheets.push({ id: uid(), employeeId: empId, date: date, start: time, end: '' });
      saveEmployeeTimesheets();
      // update both tables
      renderTimesheets();
      renderScheduleTimesheets();
    }

    // Clock out for schedule tab
    function clockOutSchedule() {
      const sel = document.getElementById('schTimeEmpSelect');
      const empId = sel?.value;
      if (!empId) return alert('Select an employee first.');
      // find last timesheet without end for this employee
      const rec = [...employeeTimesheets].reverse().find(t => t.employeeId === empId && !t.end);
      if (!rec) return alert('No active clock-in found for this employee.');
      const now = new Date();
      const time = now.toISOString().slice(11, 16);
      rec.end = time;
      saveEmployeeTimesheets();
      renderTimesheets();
      renderScheduleTimesheets();
    }

    // Populate employee selects for time clock and tasks
    function updateEmpSelects() {
      const timeSel = document.getElementById('timeEmpSelect');
      const taskSel = document.getElementById('taskEmployee');
      const schTimeSel = document.getElementById('schTimeEmpSelect');
      if (timeSel) {
        timeSel.innerHTML = '';
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          timeSel.appendChild(opt);
        });
      }
      if (taskSel) {
        taskSel.innerHTML = '';
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          taskSel.appendChild(opt);
        });
      }
      // Update schedule tab employee select
      if (schTimeSel) {
        schTimeSel.innerHTML = '';
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          schTimeSel.appendChild(opt);
        });
      }
    }

    // Clock in for selected employee
    function clockIn() {
      const sel = document.getElementById('timeEmpSelect');
      const empId = sel?.value;
      if (!empId) return alert('Select an employee first.');
      const now = new Date();
      const date = now.toISOString().slice(0, 10);
      const time = now.toISOString().slice(11, 16);
      employeeTimesheets.push({ id: uid(), employeeId: empId, date: date, start: time, end: '' });
      saveEmployeeTimesheets();
      // Update global and schedule timesheet tables
      renderTimesheets();
      renderScheduleTimesheets();
      // If employee edit dialog is open, update that employee's timesheet list
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailTimesheets === 'function') {
            renderEmployeeDetailTimesheets(currentEmp);
          }
        }
      } catch (ex) {}
    }

    // Clock out for selected employee
    function clockOut() {
      const sel = document.getElementById('timeEmpSelect');
      const empId = sel?.value;
      if (!empId) return alert('Select an employee first.');
      const rec = [...employeeTimesheets].reverse().find(t => t.employeeId === empId && !t.end);
      if (!rec) return alert('No active clock-in found for this employee.');
      const now = new Date();
      const time = now.toISOString().slice(11, 16);
      rec.end = time;
      saveEmployeeTimesheets();
      // Update global and schedule timesheet tables
      renderTimesheets();
      renderScheduleTimesheets();
      // If employee edit dialog is open, update that employee's timesheet list
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailTimesheets === 'function') {
            renderEmployeeDetailTimesheets(currentEmp);
          }
        }
      } catch (ex) {}
    }

    // Open task dialog to add or edit a task
    function openTaskDialog(task) {
      const dlg = document.getElementById('dlgTask');
      if (!dlg) return;
      document.getElementById('dlgTaskTitle').textContent = task ? 'Edit Task' : 'Add Task';
      // Populate employee options
      const selEmp = document.getElementById('taskEmployee');
      if (selEmp) {
        selEmp.innerHTML = '';
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          selEmp.appendChild(opt);
        });
        selEmp.value = task?.employeeId || (employees[0] && employees[0].id) || '';
      }
      $('#taskDesc').value = task?.desc || '';
      $('#taskPriority').value = task?.priority || 'medium';
      $('#taskStatus').value = task?.status || 'open';
      $('#taskId').value = task?.id || '';
      showDialog(dlg);
    }

    // Save task from dialog
    function saveTaskDialog() {
      const id = $('#taskId').value || uid();
      const task = {
        id: id,
        employeeId: $('#taskEmployee').value,
        desc: $('#taskDesc').value.trim(),
        priority: $('#taskPriority').value || 'medium',
        status: $('#taskStatus').value || 'open'
      };
      if (!task.desc) {
        alert('Task description is required.');
        return;
      }
      const idx = employeeTasks.findIndex(t => t.id === id);
      if (idx >= 0) {
        employeeTasks[idx] = task;
      } else {
        employeeTasks.push(task);
      }
      saveEmployeeTasks();
      renderTasks();
      renderScheduleTasks();
      hideDialog(document.getElementById('dlgTask'));
    }

    // ========= Side card drag-and-drop helpers =========
    /**
     * Reorder the side cards inside the #sideCards container based on the
     * order stored in settings.sideOrder. This function appends each
     * matching card to the container in the stored sequence. If the order
     * array is empty or missing, nothing is changed.
     */
    function applySideOrder() {
      try {
        const container = document.getElementById('sideCards');
        if (!container) return;
        const order = (settings && Array.isArray(settings.sideOrder)) ? settings.sideOrder : [];
        if (!order || order.length === 0) return;
        order.forEach(function(view) {
          const el = container.querySelector('.card[data-view="' + view + '"]');
          if (el) {
            container.appendChild(el);
          }
        });
      } catch (ex) {}
    }

    /**
     * Initialise drag-and-drop on side cards in the overview. Each card is
     * made draggable. Dragging a card reorders it within the container.
     * After a drop event, the new order is saved into settings.sideOrder
     * and persisted to localStorage.
     */
    function initSideCardDrag() {
      const container = document.getElementById('sideCards');
      if (!container) return;
      // Add drag properties and listeners to each direct card child
      container.querySelectorAll(':scope > .card[data-view]').forEach(function(card) {
        card.setAttribute('draggable', 'true');
        // On drag start, mark element and set transfer data
        card.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', card.dataset.view);
          e.dataTransfer.effectAllowed = 'move';
          card.classList.add('dragging');
        });
        // Clean up dragging class on dragend
        card.addEventListener('dragend', function() {
          card.classList.remove('dragging');
        });
        // When another card is dragged over this card, reposition based on pointer location
        card.addEventListener('dragover', function(e) {
          e.preventDefault();
          const dragging = container.querySelector('.card.dragging');
          if (!dragging || dragging === card) return;
          const rect = card.getBoundingClientRect();
          const offset = e.clientY - rect.top;
          // If pointer below halfway, insert after; else insert before
          if (offset > rect.height / 2) {
            if (card.nextElementSibling !== dragging) {
              container.insertBefore(dragging, card.nextElementSibling);
            }
          } else {
            if (card.previousElementSibling !== dragging) {
              container.insertBefore(dragging, card);
            }
          }
        });
        // On drop, persist new order
        card.addEventListener('drop', function(e) {
          e.preventDefault();
          const newOrder = Array.from(container.querySelectorAll(':scope > .card[data-view]')).map(function(el){ return el.dataset.view; });
          settings.sideOrder = newOrder;
          LS.set('inv.settings', settings);
        });
      });
    }

    /**
     * Apply visibility settings for overview cards.
     * When on the overview view, cards whose setting.cardVisibility property is false
     * will be hidden. Cards remain visible on their dedicated view.
     */
    function updateOverviewCards() {
      try {
        const params = new URLSearchParams(window.location.search);
        const view = params.get('view') || 'overview';
        if (view !== 'overview') return;
        settings.cardVisibility = settings.cardVisibility || {};
        // Stats card (#overview)
        const statsEl = document.getElementById('overview');
        if (statsEl) {
          const showStats = settings.cardVisibility.stats !== false;
          statsEl.style.display = showStats ? '' : 'none';
        }
        // Handle all cards with data-view attribute (exclude nested calendar right panels)
        document.querySelectorAll('.card[data-view]').forEach(function(el) {
          // skip nested panels inside the calendar card
          if (el.closest('.cal-right')) return;
          const v = el.dataset.view;
          // Always hide management, schedule and taxes cards on the overview tab
          if (v === 'management' || v === 'schedule' || v === 'taxes') {
            el.style.display = 'none';
            return;
          }
          const show = settings.cardVisibility[v] !== false;
          el.style.display = show ? '' : 'none';
        });
      } catch (ex) {}
    }

  </script>

<!-- Overview -->
<section id="overview" class="card stats-card">
  <h2>Overview</h2>
  <div class="stats-toolbar">
    <div class="seg" id="statsSeg">
      <button data-view="value">Inventory Value</button>
      <button data-view="profit">Sales Profit</button>
      <button data-view="mom">MoM Change</button>
      <button data-view="pay">Employee Pay</button>
      <button data-view="all" class="active">View All</button>
    </div>
  </div>
  <div class="stats-wrap">
    <div class="stat" data-k="value"><div class="stat-label">Inventory Value (at cost)</div><div class="stat-num" id="statValue">$0.00</div></div>
    <div class="stat" data-k="profit"><div class="stat-label">Estimated Sales Profit (for sale)</div><div class="stat-num" id="statProfit">$0.00</div></div>
    <div class="stat" data-k="mom"><div class="stat-label">MoM Change (inventory value)</div><div class="stat-num" id="statMoM">$0.00</div></div>
    <div class="stat" data-k="actual"><div class="stat-label">Actual Revenue (after Sales)</div><div class="stat-num" id="statActual">$0.00</div></div>
    <div class="stat" data-k="pay"><div class="stat-label">Employee Pay</div><div class="stat-num" id="statPay">$0.00</div></div>
  </div>
</section>

    <!-- Tab Visibility section has been relocated into the Settings dialog -->

<div id="backupBanner">
  <strong>Backup reminder:</strong> It has been <span id="backupAge">–</span> since your last backup.
  <button class="btn small" id="btnMarkBacked">Mark as Backed Up</button>
  <button class="btn small" id="btnQuickExport">Export CSV</button>
</div>

<section>
  <div class="grid">
  <div class="card" data-view="inventory">
    <h2>Inventory</h2>
    <div class="body" style="overflow:auto; max-height:2000px">
      <table id="tbl">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Name<br><span class="muted">SKU</span></th>
            <th>Category<br><span class="muted">Supplier</span></th>
            <th class="right">Qty<br><span class="muted">Reorder @</span></th>
            <th class="right">Cost<br><span class="muted">Price</span></th>
            <th>Notes</th>
            <th>Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Side column container for secondary cards.  Assign an id to enable drag-and-drop reordering -->
  <div id="sideCards" style="display:flex; flex-direction:column; gap:16px">
    <aside class="card" data-view="order">
      <h2>Order Estimator (Sales)</h2>
      <div class="body">
        <div class="field inline">
          <input id="orderSearch" placeholder="Search items to add to order…">
          <button class="btn small" id="btnClearOrder">Clear</button>
        </div>
        <div id="orderList" class="body" style="padding:8px 0 0 0"></div>
        <hr>
        <div class="totals">
          <div>Items</div><div class="right" id="tItems">0</div>
          <div>Estimated Cost (COGS)</div><div class="right" id="tCost">$0.00</div>
          <div>Estimated Revenue (Price)</div><div class="right" id="tRev">$0.00</div>
          <div><strong>Projected Profit</strong></div><div class="right" id="tProfit"><strong>$0.00</strong></div>
        </div>

        

        <div class="field inline" style="margin-top:8px">
  <button class="btn accent small" id="btnInvFromOrder">Create Invoice from Order</button>
</div>

      </div> <!-- end of Order Estimator body -->
    </aside> <!-- end of Order Estimator card -->

  

    <aside class="card" data-view="reorder">
      <h2>Reorder Suggestions / Purchase Order</h2>
      <div class="body">
        <div class="muted" style="margin-bottom:8px">Items at or below their reorder threshold (or with zero stock).</div>
        <div id="reorderList"></div>
        <hr style="margin:10px 0">
        <div class="field inline" style="gap:8px; flex-wrap:wrap">
          <button class="btn small" id="btnAddAllSuggest">Add All Suggested to PO</button>
          <button class="btn small" id="btnClearPO">Clear PO</button>
          <button class="btn accent small" id="btnPrintPO">Create Printable Purchase Order</button>
        </div>
        <div id="poList" style="margin-top:8px"></div>
      </div>
    </aside>

    <aside class="card" data-view="kits">
  <h2>Kits & Recipes</h2>
  <div class="body">
    <div class="row">
      <label class="field">Kit Name <input id="kitName"></label>
      <label class="field">SKU <input id="kitSku"></label>
    </div>
    <input type="hidden" id="kitId"> <!-- hidden ID for editing -->
    <div id="kitComponents" class="muted" style="margin:8px 0">
      <em>(Default: first few items auto-linked. Editing lets you change later.)</em>
    </div>
    <button class="btn small accent" id="btnAddKit">Save Kit</button>
    <hr>
    <div id="kitList"></div>
  </div>
</aside>


    <!-- Calendar tab content -->
    <!-- Dedicated calendar view (hidden by default; shown when view=calendar) -->
    <!-- Calendar card is visible on the overview and calendar tabs.  It spans the full width of the grid.  Hiding is handled via script based on view. -->
    <aside class="card" data-view="calendar" style="grid-column: 1 / -1;">
      <h2>Calendar</h2>
      <div class="body">
        <!-- Flex container for calendar and side panels. Class names allow layout adjustment based on page view. -->
        <div class="cal-flex">
          <!-- Left: calendar itself -->
          <div class="cal-left">
            <div id="calendarContainer"></div>
          </div>
          <!-- Right: upcoming events, reminders and date details stacked vertically -->
          <div class="cal-right">
            <div class="card" style="margin:0">
              <h3>Upcoming Events</h3>
              <div class="body" id="upcomingEvents"></div>
            </div>
            <div class="card" style="margin:0">
              <h3>Reminders</h3>
              <div class="body" id="reminderList"></div>
            </div>
            <div class="card" style="margin:0">
              <h3>Date Details</h3>
              <div class="body" id="dateDetails"></div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Rentals & Subscriptions tab content -->
    <aside class="card" data-view="rentals">
      <h2>Rentals &amp; Subscriptions</h2>
      <!-- Sub navigation for rentals vs subscriptions -->
      <div class="subtabs" id="rentalsSubTabs" style="margin-bottom:10px">
        <a href="javascript:void(0)" data-subview="rentals" class="subtab active">Rentals</a>
        <a href="javascript:void(0)" data-subview="subscriptions" class="subtab">Subscriptions</a>
      </div>
      <!-- Rentals subview -->
      <div class="body" data-subview="rentals">
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnAddRental">Add Rental</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Equipment</th>
              <th class="right">Qty</th>
              <th>Start</th>
              <th>Due</th>
              <th>Return</th>
              <th class="right">Fee</th>
              <th class="right">Deposit</th>
              <th class="right">Paid</th>
              <th>Status</th>
              <th>Recurring</th>
              <th>Alert</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rentalsBody"></tbody>
        </table>
      </div>
      <!-- Subscriptions subview -->
      <div class="body" data-subview="subscriptions" style="display:none">
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnAddSubscription">Add Subscription</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Plan</th>
              <th class="right">Amount</th>
              <th>Cycle</th>
              <th>Start</th>
              <th>Next Pay</th>
              <th>Prev Pay</th>
              <th>Status</th>
              <th>Recurring</th>
              <th>Alert</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="subsBody"></tbody>
        </table>
      </div>
    </aside>

    <!-- Schedule tab content -->
    <aside class="card" data-view="schedule">
      <h2>Schedule</h2>
      <div class="body">
        <!-- Monthly calendar to visualise shifts -->
        <h3>Calendar</h3>
        <div id="scheduleCalendarContainer"></div>
        <!-- Schedules section -->
        <h3>Schedules</h3>
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnSchAddShift">Add Shift</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Date</th><th>Employee</th><th>Start</th><th>End</th><th>Type</th><th>Role</th><th>Note</th><th>Actions</th></tr></thead>
          <tbody id="schScheduleBody"></tbody>
        </table>

        <!-- Time Clock & Attendance for schedule -->
        <h3 style="margin-top:20px">Time Clock &amp; Attendance</h3>
        <div class="field inline" style="margin-bottom:8px">
          <label class="field">Employee
            <select id="schTimeEmpSelect"></select>
          </label>
          <button class="btn small" id="btnSchClockIn">Clock In</button>
          <button class="btn small" id="btnSchClockOut">Clock Out</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Employee</th><th>Date</th><th>Start</th><th>End</th><th class="right">Hours</th><th>Actions</th></tr></thead>
          <tbody id="schTimesheetBody"></tbody>
        </table>

        <!-- Tasks & Duty Management for schedule -->
        <h3 style="margin-top:20px">Tasks &amp; Duties</h3>
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnSchAddTask">Add Task</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Employee</th><th>Task</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="schTaskBody"></tbody>
        </table>

        <!-- Export schedules -->
        <div class="field inline" style="margin-top:10px">
          <button class="btn small" id="btnSchExport">Export Schedules CSV</button>
        </div>
      </div>
    </aside>

    <!-- Shipment Tracking tab content -->
    <aside class="card" data-view="tracking">
      <h2>Shipment Tracking</h2>
      <div class="body">
        <p>Enter your tracking number below to check the status of a package being sent or received. The system will automatically detect the carrier or let you choose one manually.</p>
        <div class="row">
          <label class="field" style="flex:2"><span>Tracking Number</span>
            <input id="trackNumber" placeholder="Enter tracking number here">
          </label>
          <label class="field" style="flex:1"><span>Carrier</span>
            <select id="trackCarrier">
              <option value="auto">Auto Detect</option>
              <option value="UPS">UPS</option>
              <option value="FedEx">FedEx</option>
              <option value="USPS">USPS</option>
              <option value="DHL">DHL</option>
              <option value="Other">Other</option>
            </select>
          </label>
        </div>
        <div class="field inline" style="margin-top:12px">
          <button class="btn accent" id="btnTrackPackage">Track Package</button>
        </div>
        <div class="muted" style="margin-top:16px">Redirect Reference:</div>
        <table class="small-table" style="width:100%; margin-top:6px">
          <thead><tr><th>Carrier</th><th>URL Template</th><th>Example Format</th></tr></thead>
          <tbody>
            <tr><td>UPS</td><td>https://wwwapps.ups.com/WebTracking/track?track=yes&amp;trackNums=<em>{TRACKING}</em></td><td>1Z999AA10123456784</td></tr>
            <tr><td>FedEx</td><td>https://www.fedex.com/fedextrack/?trknbr=<em>{TRACKING}</em></td><td>999999999999</td></tr>
            <tr><td>USPS</td><td>https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=<em>{TRACKING}</em></td><td>EA123456789US</td></tr>
            <tr><td>DHL</td><td>https://www.dhl.com/en/express/tracking.html?AWB=<em>{TRACKING}</em>&amp;brand=DHL</td><td>1234567890</td></tr>
          </tbody>
        </table>

        <!-- Saved shipments list -->
        <h3 style="margin-top:20px">Saved Shipments</h3>
        <div style="max-height:260px; overflow:auto; margin-top:8px">
          <table class="small-table" style="width:100%">
            <thead><tr><th>Tracking #</th><th>Carrier</th><th>Date Saved</th><th></th></tr></thead>
            <tbody id="shipRows"></tbody>
          </table>
        </div>
      </div>
    </aside>

    <aside class="card" data-view="damaged">
      <h2>Damaged & Loss</h2>
      <div class="body">
        <div class="row">
          <label class="field">Item<select id="damItem"></select></label>
          <label class="field">Qty<input type="number" id="damQty" min="1" step="1" value="1"></label>
        </div>
        <label class="field" style="margin-top:8px">Note <input id="damNote" placeholder="e.g., dented box"></label>
        <div class="field inline" style="margin-top:8px">
          <button class="btn accent small" id="btnDamAdd">Log Damaged</button>
          <button class="btn small" id="btnDamExport">Export CSV</button>
          <button class="btn danger small" id="btnDamClear">Clear All</button>
        </div>
        <div class="muted" style="margin-top:8px">Total Loss: <strong id="damTotal">$0.00</strong></div>
        <div style="max-height:260px; overflow:auto; margin-top:10px">
          <table class="small-table" style="width:100%">
            <thead><tr><th>Date</th><th>Item</th><th class="right">Qty</th><th class="right">Cost</th><th class="right">Loss</th><th>Note</th><th></th></tr></thead>
            <tbody id="damRows"></tbody>
          </table>
        </div>
      </div>
    </aside>

    <aside class="card" data-view="invoice">
  <h2>Invoice Creator</h2>
  <div class="body">
    <div class="row">
      <label class="field">From
        <textarea id="invFrom" placeholder="Your Company&#10;123 Example St&#10;City, ST 00000&#10;email@example.com"></textarea>
      </label>
      <label class="field">Bill To
        <textarea id="invBillTo" placeholder="Client Name&#10;Address&#10;Email"></textarea>
      </label>
    </div>

    <div class="row">
      <label class="field">Tax %
        <input type="number" id="invTax" min="0" step="0.01" value="0">
      </label>
      <label class="field">Discount $
        <input type="number" id="invDiscount" min="0" step="0.01" value="0">
      </label>
    </div>

    <div class="row">
      <label class="field">Discount %
        <input type="number" id="invDiscountPct" min="0" step="0.01" value="0">
      </label>
      <label class="field">Shipping $
        <input type="number" id="invShipping" min="0" step="0.01" value="0">
      </label>
    </div>

    <!-- NEW: Manufacturer Coupon + Taxable Shipping live inside the card -->
    <div class="row">
      <label class="field">Manufacturer Coupon $
        <input type="number" id="invMfrCoupon" min="0" step="0.01" value="0">
      </label>

      <label class="field">Shipping Taxable
        <select id="invShipTaxable">
          <option value="on" selected>Yes</option>
          <option value="off">No</option>
        </select>
      </label>
    </div>

        <div class="row">
      <label class="field">Notes
        <!-- switched to textarea to allow longer notes; increased height for more room -->
        <textarea id="invNotes" placeholder="Optional notes on this invoice" rows="6"></textarea>
      </label>
    </div>
    <!-- Footer customization for invoices -->
    <div class="row">
      <label class="field">Footer Notes
        <textarea id="invFooterNotes" placeholder="Notes for the invoice footer" rows="2"></textarea>
      </label>
      <label class="field">Footer Image
        <!-- allow uploading an optional footer image; will be converted to DataURL on save -->
        <input type="file" id="invFooterImg" accept="image/*">
      </label>
    </div>

    <div class="field inline" style="margin-top:8px">
      <button class="btn accent small" id="btnInvFromOrder2">Create Invoice from Order</button>
      <button class="btn small" id="btnMakeBlankInv">Create Blank Invoice</button>
      <button class="btn small" id="btnViewLastInv">View Last Invoice</button>
    </div>
  </div>
</aside>

    <!-- Invoice Tracker tab content -->
    <aside class="card" data-view="invoices">
      <h2>Invoice Tracker</h2>
      <div class="body">
        <!-- Delete all invoices button -->
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small danger" id="btnDeleteAllInvoices">Delete All Invoices</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead>
            <tr>
              <th>Number</th>
              <th>Date</th>
              <th>Bill To</th>
              <th class="right">Total</th>
              <th>Paid</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="invoiceTrackerBody"></tbody>
        </table>
      </div>
    </aside>

    <!-- E-Management tab content -->
    <!-- Hidden by default; shown only when ?view=management -->
    <aside class="card" data-view="management" style="display:none;">
      <h2>Employee Management</h2>
      <div class="body">
        <!-- Employee list and actions -->
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnAddEmployee">Add Employee</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Title/Dept</th>
              <th class="right">Hourly Rate</th>
              <th class="right">Salary</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="employeeTableBody"></tbody>
        </table>
        <!-- Note: Payroll period, schedules, payroll module, deductions and time clock have been moved to the employee edit dialog or Taxes tab -->

        <!-- Tasks & Duty Management -->
        <div id="employeeTaskSection" style="margin-top:10px">
          <h3>Tasks &amp; Duties</h3>
          <div class="field inline" style="margin-bottom:8px">
            <button class="btn small" id="btnAddTask">Add Task</button>
          </div>
          <table class="small-table" style="width:100%">
            <thead><tr><th>Employee</th><th>Task</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="taskBody"></tbody>
          </table>
        </div>
        </div>
    </aside>

    <!-- Taxes tab content -->
    <!-- Hidden by default; shown only when ?view=taxes -->
    <aside id="taxPrint" class="card" data-view="taxes" style="display:none;">
      <h2>Taxes</h2>
      <div class="body">
        <h3>Business Tax Summary</h3>
        <div class="row">
          <div><strong>Gross Income:</strong> <span id="taxGross">$0.00</span></div>
          <div><strong>Expenses:</strong> <span id="taxExpenses">$0.00</span></div>
          <div><strong>Net Profit:</strong> <span id="taxNet">$0.00</span></div>
        </div>
        <div class="field inline" style="margin-top:8px">
          <button class="btn small" id="btnPrintBusinessTax">Print Business Summary</button>
        </div>
        <h3 style="margin-top:10px">Employee Taxes</h3>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Employee</th><th class="right">Gross Pay</th><th class="right">Taxes</th><th class="right">Net Pay</th></tr></thead>
          <tbody id="employeeTaxBody"></tbody>
        </table>
        <div class="field inline" style="margin-top:8px">
          <button class="btn small" id="btnPrintEmployeeTaxes">Print Employee Tax Summary</button>
        </div>

        <!-- Payroll period and payroll sections moved from Employee Management -->
        <h3 style="margin-top:10px">Payroll Period</h3>
        <div class="row">
          <label class="field">Frequency
            <select id="payFrequency">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="biweekly">Bi-weekly</option>
              <option value="monthly">Monthly</option>
              <option value="annual">Annual</option>
            </select>
          </label>
          <label class="field">Start Date
            <input type="date" id="payPeriodStart">
          </label>
          <label class="field">End Date
            <input type="date" id="payPeriodEnd">
          </label>
          <div class="field inline"><button class="btn small" id="btnSetPayPeriod">Set Period</button></div>
        </div>
        <h3 style="margin-top:10px">Payroll</h3>
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnRunPayroll">Run Payroll</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead>
            <tr><th>Employee</th><th class="right">Gross</th><th class="right">Tax</th><th class="right">Deductions</th><th class="right">Net</th><th class="center">Paid</th><th>Actions</th></tr>
          </thead>
          <tbody id="payrollBody"></tbody>
        </table>
      </div>
    </aside>



      

<!-- Dialog -->
<dialog id="dlg">
  <div class="dlg-head">
    <strong id="dlgTitle">New Item</strong>
    <div class="toolbar"><button class="btn small" id="btnSave">Save</button><button class="btn small" id="btnCancel">Cancel</button></div>
  </div>
  <div class="dlg-grid">
    <section class="card" style="margin:0">
      <h2>Details</h2>
      <div class="body">
        <div class="row"><label class="field">Name<input id="name" required></label><label class="field">SKU<input id="sku"></label></div>
        <div class="row"><label class="field">Category<input id="category"></label><label class="field">Supplier<input id="supplier"></label></div>
        <div class="row"><label class="field">Quantity<input type="number" id="qty" min="0" step="1" value="0"></label><label class="field">Reorder @<input type="number" id="reorderAt" min="0" step="1" value="0"></label></div>
        <div class="row"><label class="field">Cost (per unit)<input type="number" id="cost" min="0" step="0.01" value="0"></label><label class="field">Price (per unit)<input type="number" id="price" min="0" step="0.01" value="0"></label></div>
        <!-- Package & Units per Package -->
<div class="row">
  <label class="field">Package Cost
    <input type="number" id="packageCost" min="0" step="0.01" value="0">
  </label>
  <label class="field">Units per Package
    <input type="number" id="packageQty" min="1" step="1" value="1">
  </label>
</div>
<div id="packHelper" class="muted" style="margin-top:6px">
  Enter package cost &amp; units (Unit Quantity) to auto-calc per-unit cost.
</div>

<!-- Loose Units input (extras outside full packages) -->
<div class="row" style="margin-top:6px">
  <label class="field">Loose Units (extras)
    <input type="number" id="unitsLoose" min="0" step="1" value="0">
  </label>
  <div></div>
</div>
        <div class="row" style="margin-top:10px">
          <label class="pill"><input type="checkbox" id="singleOnly"> Single unit only</label>
          <label class="pill"><input type="checkbox" id="measurable"> Measurable units</label>
          <label class="field">Unit Label<input id="unitLabel" placeholder="ml, oz, g, pcs"></label>
        </div>
        <div id="unitQtyHint" class="muted" style="margin:6px 0 -4px">Tip: <em>Units per Package</em> is your <strong>Unit Quantity per Quantity</strong>.</div>
        <div class="row" style="margin-top:10px"><label class="pill"><input type="checkbox" id="forSale"> For sale</label><label class="pill"><input type="checkbox" id="restockOnly"> Restock only</label></div>
        <label class="field" style="margin-top:10px">Notes<textarea id="notes" placeholder="Anything important to remember…"></textarea></label>

        <!-- NEW: Components / BOM -->
        <label class="field" style="margin-top:10px">Components (BOM)
          <textarea id="components" placeholder="SKU:QTY per 1 unit, one per line&#10;A-123:1&#10;B-456:2"></textarea>
        </label>
      </div>
    </section>
    <section class="card" style="margin:0">
      <h2>Photo</h2>
      <div class="body">
        <div id="photoDrop" class="photoDrop"><div class="muted">Drop an image, click to browse, or paste while this window is open.</div><img id="photoPreview" class="photoPreview" alt="Preview" style="display:none"/></div>
        <div class="row" style="margin-top:10px">
          <label class="field">Image URL<input id="photoUrl" placeholder="https://…"></label>
          <div class="field"><span class="muted">Actions</span><div style="display:flex; gap:8px; flex-wrap:wrap"><button class="btn small" id="btnPhotoUseUrl">Use URL</button><button class="btn small" id="btnPhotoClear">Remove</button></div></div>
        </div>
        <input type="file" id="photoFile" accept="image/*" style="display:none"><input type="hidden" id="photoData">
        <p class="muted" style="margin-top:8px">Tip: JPEG/WEBP are smaller; large images are auto-optimized on import.</p>
      </div>
    </section>
  </div>
  <div class="body" style="display:flex; justify-content:flex-end; gap:8px"><input type="hidden" id="id"></div>
</dialog>

<!-- Rental dialog -->
<dialog id="dlgRental">
  <div class="dlg-head">
    <strong id="rentalTitle">New Rental</strong>
    <div class="toolbar">
      <button class="btn small" id="btnSaveRental">Save</button>
      <button class="btn small" id="btnCancelRental">Cancel</button>
    </div>
  </div>
  <div class="dlg-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
    <section class="card" style="margin:0">
      <h3>Rental Details</h3>
      <div class="body">
        <input type="hidden" id="rentalId">
        <label class="field">Customer
          <input id="rentalCustomer" placeholder="Customer name">
        </label>
        <label class="field">Equipment
          <input id="rentalEquipment" placeholder="Equipment">
        </label>
        <label class="field">Quantity
          <input type="number" id="rentalQty" min="1" step="1" value="1">
        </label>
        <label class="field">Start Date
          <input type="date" id="rentalStart">
        </label>
        <label class="field">Return Due
          <input type="date" id="rentalDue">
        </label>
        <label class="field">Return Date
          <input type="date" id="rentalReturn">
        </label>
        <label class="field">Rental Fee
          <input type="number" id="rentalFee" min="0" step="0.01" value="0">
        </label>
        <label class="field">Deposit
          <input type="number" id="rentalDeposit" min="0" step="0.01" value="0">
        </label>
        <label class="field">Paid Amount
          <input type="number" id="rentalPaid" min="0" step="0.01" value="0">
        </label>
        <label class="field">Payment Date
          <input type="date" id="rentalPayDate">
        </label>
        <label class="field">Notes
          <textarea id="rentalNotes" rows="3"></textarea>
        </label>
      </div>
    </section>
  </div>
</dialog>

<!-- Subscription dialog -->
<dialog id="dlgSubscription">
  <div class="dlg-head">
    <strong id="subTitle">New Subscription</strong>
    <div class="toolbar">
      <button class="btn small" id="btnSaveSubscription">Save</button>
      <button class="btn small" id="btnCancelSubscription">Cancel</button>
    </div>
  </div>
  <div class="dlg-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
    <section class="card" style="margin:0">
      <h3>Subscription Details</h3>
      <div class="body">
        <input type="hidden" id="subId">
        <label class="field">Customer
          <input id="subCustomer" placeholder="Customer name">
        </label>
        <label class="field">Plan
          <input id="subPlan" placeholder="Plan name">
        </label>
        <label class="field">Amount
          <input type="number" id="subAmount" min="0" step="0.01" value="0">
        </label>
        <label class="field">Billing Cycle
          <select id="subCycle">
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="annual">Annual</option>
          </select>
        </label>
        <label class="field">Start Date
          <input type="date" id="subStart">
        </label>
        <label class="field">Next Payment
          <input type="date" id="subNextPay">
        </label>
        <label class="field">Previous Payment
          <input type="date" id="subPrevPay">
        </label>
        <label class="field">Status
          <select id="subStatus">
            <option value="active">Active</option>
            <option value="pending">Pending</option>
            <option value="overdue">Overdue</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </label>
        <label class="pill"><input type="checkbox" id="subAutoRenew" checked> Auto Renew</label>
        <label class="field">Notes
          <textarea id="subNotes" rows="3"></textarea>
        </label>
      </div>
    </section>
  </div>
</dialog>

<!-- Calendar Event Dialog -->
<!-- Employee Edit Dialog -->
<dialog id="dlgEmployee">
  <div class="dlg-head">
    <strong id="dlgEmpTitle">New Employee</strong>
    <div class="toolbar"><button class="btn small" id="btnSaveEmployee">Save</button><button class="btn small" id="btnCancelEmployee">Cancel</button></div>
  </div>
  <div class="dlg-grid">
    <section class="card" style="margin:0">
      <h2>Employee Details</h2>
      <div class="body">
        <div class="row"><label class="field">Employee ID<input id="empCustomId" placeholder="Auto ID or custom"></label></div>
        <div class="row"><label class="field">Name<input id="empName" required></label><label class="field">Email<input id="empEmail"></label></div>
        <div class="row"><label class="field">Phone<input id="empPhone"></label><label class="field">Address<input id="empAddress"></label></div>
        <div class="row"><label class="field">Job Title<input id="empTitle"></label><label class="field">Department<input id="empDept"></label></div>
        <div class="row"><label class="field">Hourly Rate<input type="number" id="empRate" min="0" step="0.01"></label><label class="field">Overtime Rate<input type="number" id="empOvertime" min="0" step="0.01"></label></div>
        <div class="row"><label class="field">Salary<input type="number" id="empSalary" min="0" step="0.01"></label><label class="field">Commission<input type="number" id="empCommission" min="0" step="0.01"></label></div>
        <div class="row"><label class="field">Tax Status<input id="empTaxStatus" placeholder="Single, Married, etc."></label><label class="field">Allowances<input type="number" id="empAllowances" min="0" step="1"></label></div>
        <label class="field">Bank Info<input id="empBank"></label>
        <div class="row"><label class="pill"><input type="checkbox" id="empActive" checked> Active</label></div>
      </div>
    </section>
    <!-- Additional sections for the selected employee: schedules, time & deductions -->
    <section class="card" style="margin:0">
      <h2>Employee Records</h2>
      <div class="body">
        <!-- Per-employee Schedules -->
        <h3>Schedules</h3>
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnEmpAddShift">Add Shift</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Date</th><th>Start</th><th>End</th><th>Type</th><th>Role</th><th>Note</th><th>Actions</th></tr></thead>
          <tbody id="empScheduleBody"></tbody>
        </table>

        <!-- Per-employee Time Clock & Attendance -->
        <h3 style="margin-top:20px">Time Clock &amp; Attendance</h3>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Date</th><th>Start</th><th>End</th><th class="right">Hours</th><th>Actions</th></tr></thead>
          <tbody id="empTimeBody"></tbody>
        </table>

        <!-- Per-employee Deductions -->
        <h3 style="margin-top:20px">Deductions &amp; Withholding</h3>
        <div class="field inline" style="margin-bottom:8px">
          <button class="btn small" id="btnEmpAddDeduction">Add Deduction</button>
        </div>
        <table class="small-table" style="width:100%">
          <thead><tr><th>Type</th><th class="right">Amount</th><th>Pre-tax?</th><th>Actions</th></tr></thead>
          <tbody id="empDedBody"></tbody>
        </table>
      </div>
    </section>
  </div>
  <input type="hidden" id="empId">
</dialog>

<!-- Shift Dialog -->
<dialog id="dlgShift">
  <div class="dlg-head">
    <strong id="dlgShiftTitle">Add Shift</strong>
    <div class="toolbar"><button class="btn small" id="btnSaveShift">Save</button><button class="btn small" id="btnCancelShift">Cancel</button></div>
  </div>
  <div class="body">
    <label class="field">Employee
      <select id="shiftEmployee"></select>
    </label>
    <label class="field">Date<input type="date" id="shiftDate"></label>
    <label class="field">Start Time<input type="time" id="shiftStart"></label>
    <label class="field">End Time<input type="time" id="shiftEnd"></label>
    <label class="field">Type
      <select id="shiftType">
        <option value="shift">Shift</option>
        <option value="pto">PTO</option>
        <option value="uto">Unpaid Time Off</option>
        <option value="holiday">Holiday</option>
        <option value="absence">Absent</option>
      </select>
    </label>
    <!-- Role name allows colour-coding of shifts (e.g., Cashier, Manager) -->
    <label class="field">Role
      <input type="text" id="shiftRole" placeholder="e.g. Cashier">
    </label>
    <!-- Colour associated with the role; defaults to accent colour -->
    <label class="field">Role Color
      <input type="color" id="shiftColor" value="#18d47b">
    </label>
    <!-- Optional note associated with the shift -->
    <label class="field">Notes
      <textarea id="shiftNotes" rows="2" placeholder="Add notes…"></textarea>
    </label>
    <!-- Recurrence controls: frequency and count -->
    <div class="row">
      <label class="field">Repeat
        <select id="shiftRepeatFreq">
          <option value="">None</option>
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </label>
      <label class="field">Times<input type="number" id="shiftRepeatCount" min="1" step="1" value="1"></label>
    </div>
  </div>
  <input type="hidden" id="shiftId">
</dialog>

<!-- Task Dialog -->
<dialog id="dlgTask">
  <div class="dlg-head">
    <strong id="dlgTaskTitle">Add Task</strong>
    <div class="toolbar"><button class="btn small" id="btnSaveTask">Save</button><button class="btn small" id="btnCancelTask">Cancel</button></div>
  </div>
  <div class="body">
    <label class="field">Employee
      <select id="taskEmployee"></select>
    </label>
    <label class="field">Task Description
      <textarea id="taskDesc" rows="2" placeholder="Task details"></textarea>
    </label>
    <label class="field">Priority
      <select id="taskPriority">
        <option value="low">Low</option>
        <option value="medium">Medium</option>
        <option value="high">High</option>
      </select>
    </label>
    <label class="field">Status
      <select id="taskStatus">
        <option value="open">Open</option>
        <option value="inprogress">In Progress</option>
        <option value="done">Done</option>
      </select>
    </label>
  </div>
  <input type="hidden" id="taskId">
</dialog>

<!-- Deduction Dialog -->
<dialog id="dlgDeduction">
  <div class="dlg-head">
    <strong id="dedTitle">New Deduction</strong>
    <div class="toolbar"><button class="btn small" id="btnSaveDeduction">Save</button><button class="btn small" id="btnCancelDeduction">Cancel</button></div>
  </div>
  <div class="body">
    <label class="field">Employee
      <select id="dedEmployee"></select>
    </label>
    <label class="field">Deduction Name
      <input id="dedName">
    </label>
    <label class="field">Amount
      <input type="number" id="dedAmount" min="0" step="0.01">
    </label>
    <label class="field">Amount Type
      <select id="dedAmountType">
        <option value="dollar">Dollar</option>
        <option value="percent">Percent (%)</option>
      </select>
    </label>
    <label class="pill"><input type="checkbox" id="dedPreTax"> Pre-tax</label>
  </div>
  <input type="hidden" id="dedId">
</dialog>

<dialog id="dlgCalEvent">
  <div class="dlg-head">
    <strong id="dlgCalEventTitle">Add Events</strong>
    <div class="toolbar">
      <button class="btn small" id="btnCalEventSave">Save</button>
      <button class="btn small" id="btnCalEventCancel">Cancel</button>
    </div>
  </div>
  <div class="body">
    <div id="calEventRows"></div>
    <div class="field inline" style="margin-top:8px">
      <button class="btn small accent" id="btnCalAddRow">Add Another Event</button>
    </div>
  </div>
</dialog>

<!-- Customer Dialog -->
<dialog id="customerDialog" class="dialog">
  <div class="dialogContent">
    <div class="dialogHeader">
      <h2 id="customerDialogTitle">Add Customer</h2>
      <button class="dialogClose" onclick="hideDialog(customerDialog)">×</button>
    </div>
    <form id="customerForm">
      <fieldset>
        <legend>Basic Information</legend>
        <label class="field">
          Name *
          <input type="text" id="customer_name" required>
        </label>
        <label class="field">
          Company
          <input type="text" id="customer_company">
        </label>
      </fieldset>

      <fieldset>
        <legend>Contact Information</legend>
        <label class="field">
          Email
          <input type="email" id="customer_email">
        </label>
        <label class="field">
          Phone
          <input type="tel" id="customer_phone">
        </label>
        <label class="field">
          Address
          <textarea id="customer_address" rows="3"></textarea>
        </label>
      </fieldset>

      <fieldset>
        <legend>Notes</legend>
        <textarea id="customer_notes" rows="4"></textarea>
      </fieldset>

      <div class="btn-group">
        <button type="button" class="btn" onclick="hideDialog(customerDialog)">Cancel</button>
        <button type="submit" class="btn primary">Save Customer</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Settings -->
<dialog id="dlgSettings">
  <div class="dlg-head">
    <strong>Settings</strong>
    <div class="toolbar"><button class="btn small" id="btnSettingsSave">Save</button><button class="btn small" id="btnSettingsClose">Close</button></div>
  </div>
  <div class="body" style="display:grid; grid-template-columns:1.1fr 1fr; gap:14px">
    <section class="card" style="margin:0">
      <h2>Defaults</h2>
      <div class="row">
  <label class="field">Default Tax % 
    <input type="number" id="setTaxDef" min="0" step="0.01" placeholder="e.g., 7.5">
  </label>
  <label class="field">Invoice Prefix 
    <input id="setInvPrefix" placeholder="INV-">
  </label>
</div>

<div class="row">
  <label class="field">Kit Markup % 
    <input type="number" id="setKitMarkup" min="0" step="1" value="50">
  </label>
</div>

<div class="row">
  <label class="field"><span>High Contrast</span>
    <select id="setHighContrast"><option value="off">Off</option><option value="on">On</option></select>
  </label>
  <label class="field"><span>Backup Reminders</span>
    <select id="setBackupReminders"><option value="off">Off</option><option value="on">On</option></select>
  </label>
</div>
<div class="field inline"><button class="btn small" id="btnMarkBacked2">Mark as Backed Up</button></div>
    </section>

    <section class="card" style="margin:0">
      <h2>Branding (Logo)</h2>
      <div class="body">
        <!-- Logo controls -->
        <div class="field inline">
          <input type="file" id="setLogoFile" accept="image/*" style="display:none">
          <button class="btn small" id="btnPickLogo">Upload Logo</button>
          <button class="btn small" id="btnClearLogo">Clear Logo</button>
        </div>
        <div class="muted" style="margin:8px 0">Used on Invoice and Purchase Order headers.</div>
        <img id="logoPreview" style="max-width:100%; max-height:100px; border:1px solid var(--border); border-radius:8px; display:none" alt="Logo Preview">
        <!-- Footer image & notes -->
        <hr style="border:none; border-top:1px solid var(--border); margin:12px 0" />
        <h3 style="margin:4px 0">Footer Customization</h3>
        <div class="field inline" style="margin-bottom:8px">
          <input type="file" id="setFooterFile" accept="image/*" style="display:none">
          <button class="btn small" id="btnPickFooterImg">Upload Footer Image</button>
          <button class="btn small" id="btnClearFooterImg">Clear Footer Image</button>
        </div>
        <div class="muted" style="margin-bottom:8px">Default image for invoice footers.</div>
        <img id="footerPreview" style="max-width:100%; max-height:80px; border:1px solid var(--border); border-radius:8px; display:none" alt="Footer Preview">
        <label class="field" style="margin-top:8px"><span>Default Footer Notes</span>
          <textarea id="setFooterNotes" rows="2" placeholder="Enter default notes shown in the footer of invoices"></textarea>
        </label>
      </div>
    </section>

    <section class="card" style="margin:0">
      <h2>Appearance & Behavior</h2>
      <div class="body">
        <div class="row">
          <label class="field"><span>Theme Mode</span>
            <select id="setThemeMode">
              <option value="auto">Auto (match system)</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
          <label class="field"><span>Currency</span>
            <select id="setCurrency">
              <option value="USD">USD $</option>
              <option value="EUR">EUR €</option>
              <option value="GBP">GBP £</option>
              <option value="CAD">CAD $</option>
              <option value="AUD">AUD $</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Compact Rows</span>
            <select id="setCompact"><option value="off">Off</option><option value="on">On</option></select>
          </label>
        </div>
      </div>
    </section>

    <section class="card" style="margin:0">
      <h2>Display Options</h2>
      <div class="body">
        <div class="row">
          <label class="field"><span>Show “Reorder @” line</span>
            <select id="setShowReorder"><option value="on">On</option><option value="off">Off</option></select>
          </label>
          <label class="field"><span>Show “Unit Qty” line</span>
            <select id="setShowUnitQty"><option value="on">On</option><option value="off">Off</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Show “Total Units” line</span>
            <select id="setShowTotalUnits"><option value="on">On</option><option value="off">Off</option></select>
          </label>
          <label class="field"><span>Hide lines when value = 0</span>
            <select id="setHideZero"><option value="off">Off</option><option value="on">On</option></select>
          </label>
        </div>
      </div>
    </section>

    <section class="card" style="margin:0">
      <h2>Theme Colors</h2>
      <div class="body">
        <div class="row">
          <label class="field"><span>Edit color set</span>
            <select id="setColorMode">
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="hc">High Contrast</option>
            </select>
          </label>
          <div class="field">
            <span class="muted">Presets</span>
            <div class="toolbar">
              <button class="btn small" id="btnThemeResetSel">Reset Selected</button>
              <button class="btn small" id="btnThemeResetAll">Reset All</button>
            </div>
          </div>
        </div>

        <div class="row">
          <label class="field">Background (--bg)<input type="color" id="setColor_bg"></label>
          <label class="field">Header Background (--bg2)<input type="color" id="setColor_bg2"></label>
        </div>
        <div class="row">
          <label class="field">Title (--text)<input type="color" id="setColor_text"></label>
          <label class="field">Text (--muted)<input type="color" id="setColor_muted"></label>
        </div>
        <div class="row">
          <label class="field">Buttons (--accent)<input type="color" id="setColor_accent"></label>
          <label class="field">Danger (--danger)<input type="color" id="setColor_danger"></label>
        </div>
        <div class="row">
          <label class="field">Warning (--warn)<input type="color" id="setColor_warn"></label>
          <label class="field">Panels (--card)<input type="color" id="setColor_card"></label>
        </div>
        <div class="row">
          <label class="field">Page Borders (--border)<input type="color" id="setColor_border"></label>
        </div>
        <div class="row">
          <label class="field">Shadow (--shadow)<input id="setColor_shadow" placeholder="rgba(0,0,0,.35)"></label>
        </div>
        <div class="muted" style="margin-top:6px">Changes apply immediately. High Contrast values overlay the base mode when enabled.</div>
      </div>
    </section>

    <!-- Insert Tab Visibility controls before Data & Backups -->
    <section class="card" style="margin:0">
      <h2>Tab Visibility</h2>
      <div class="body">
        <!-- Each select corresponds to a navigation tab. "On" shows the tab; "Off" hides it. -->
        <div class="row">
          <label class="field"><span>Inventory</span>
            <select id="setTabInventory"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Order Estimator</span>
            <select id="setTabOrder"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Reorder / PO</span>
            <select id="setTabReorder"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Kits &amp; Recipes</span>
            <select id="setTabKits"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Damaged &amp; Loss</span>
            <select id="setTabDamaged"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Invoice Creator</span>
            <select id="setTabInvoice"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Invoice Tracker</span>
            <select id="setTabInvoices"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Calendar</span>
            <select id="setTabCalendar"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Rentals &amp; Subscriptions</span>
            <select id="setTabRentals"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Schedule</span>
            <select id="setTabSchedule"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Shipment Tracking</span>
            <select id="setTabTracking"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <div class="field"></div>
        </div>

        <!-- Additional tabs for employee management and taxes -->
        <div class="row">
          <label class="field"><span>E-Management</span>
            <select id="setTabManagement"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Taxes</span>
            <select id="setTabTaxes"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
      </div>
    </section>

    <!-- Overview Card Visibility controls -->
    <section class="card" style="margin:0">
      <h2>Overview Card Visibility</h2>
      <div class="body">
        <!-- Controls to show or hide each card on the overview page.
             Selecting "Hide" will collapse the card on the overview tab only.
             These cards remain accessible via their tabs if the tab itself is visible. -->
        <div class="row">
          <label class="field"><span>Overview Stats</span>
            <select id="setCardStats"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Inventory</span>
            <select id="setCardInventory"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Order Estimator</span>
            <select id="setCardOrder"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Reorder / PO</span>
            <select id="setCardReorder"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Kits &amp; Recipes</span>
            <select id="setCardKits"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Calendar</span>
            <select id="setCardCalendar"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Rentals &amp; Subscriptions</span>
            <select id="setCardRentals"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Schedule</span>
            <select id="setCardSchedule"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Shipment Tracking</span>
            <select id="setCardTracking"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Damaged &amp; Loss</span>
            <select id="setCardDamaged"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
        <div class="row">
          <label class="field"><span>Invoice Creator</span>
            <select id="setCardInvoice"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
          <label class="field"><span>Invoice Tracker</span>
            <select id="setCardInvoices"><option value="on">Show</option><option value="off">Hide</option></select>
          </label>
        </div>
      </div>
    </section>

    <section class="card" style="margin:0">
      <h2>Data & Backups</h2>
      <div class="body">
        <div class="row">
          <label class="field"><span>Auto Backups</span>
            <select id="setAutoBackupFreq">
              <option value="off">Off</option>
              <option value="2m">Every 2 minutes</option>
              <option value="5m">Every 5 minutes</option>
              <option value="15m">Every 15 minutes</option>
              <option value="30m">Every 30 minutes</option>
              <option value="60m">Hourly</option>
              <option value="daily">Daily</option>
            </select>
          </label>
          <label class="field"><span>Keep last (count)</span>
            <input type="number" id="setBackupKeep" min="1" step="1" value="5">
          </label>
        </div>

        <div class="field inline" style="gap:8px; flex-wrap:wrap; margin-top:8px">
          <input type="file" id="setRestoreFile" accept="application/json" style="display:none">
          <button class="btn small" id="btnSaveBackup">Save Backup (JSON)</button>
          <button class="btn small" id="btnDownloadLast">Re-download Last Backup</button>
          <button class="btn small" id="btnRestoreBackup">Restore from File</button>
          <button class="btn small" id="btnExportCSV2">Export Inventory CSV</button>
          <button class="btn small" id="btnExportXLSX2">Export Inventory Excel</button>
        </div>
        <div class="muted" style="margin-top:6px">Downloads usually go to your browser’s default <em>Downloads</em> folder. If you can’t find a backup, use “Re-download Last Backup”.</div>

        <div style="margin-top:10px">
          <strong>Backup History</strong>
          <div id="backupList" class="muted" style="margin-top:6px">No backups yet.</div>
        </div>
      </div>
    </section>
  </div>
</dialog>


<dialog id="dlgKit">
  <div class="dlg-head">
    <strong id="dlgKitTitle">Edit Kit</strong>
    <div class="toolbar">
      <button class="btn small" id="btnKitSave">Save</button>
      <button class="btn small" id="btnKitCancel">Cancel</button>
    </div>
  </div>
  <div class="dlg-grid">
    <section class="card" style="margin:0">
      <h2>Kit Details</h2>
      <div class="body">
        <input type="hidden" id="kitEditId">
        <label class="field">Kit Name <input id="kitEditName"></label>
        <label class="field">SKU <input id="kitEditSku"></label>
        <div class="muted" style="margin-top:8px">Select components for this kit:</div>
        <div id="kitEditComponents" style="max-height:260px; overflow:auto; margin-top:8px"></div>
      </div>
    </section>

    <!-- NEW: Kit Photo section -->
    <section class="card" style="margin:0">
      <h2>Kit Photo</h2>
      <div class="body">
        <div id="kitPhotoDrop" class="photoDrop">
          <div class="muted">Drop an image, click to browse, or paste while this window is open.</div>
          <img id="kitPhotoPreview" class="photoPreview" alt="Preview" style="display:none"/>
        </div>
        <div class="row" style="margin-top:10px">
          <label class="field">Image URL<input id="kitEditPhoto" placeholder="https://…"></label>
          <div class="field">
            <span class="muted">Actions</span>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn small" id="btnKitPhotoUseUrl">Use URL</button>
              <button class="btn small" id="btnKitPhotoClear">Remove</button>
            </div>
          </div>
        </div>
        <input type="file" id="kitPhotoFile" accept="image/*" style="display:none">
      </div>
    </section>
  </div>
</dialog>


<script>
/* ============ Utilities & Storage ============ */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const nowISO=()=>new Date().toISOString();
const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
const fmt=n=>Number(n||0).toLocaleString(undefined,{ style:'currency', currency:(settings?.currency||'USD'), maximumFractionDigits:2 });
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const daysAgo=iso=>Math.floor((Date.now()-new Date(iso).getTime())/86400000);
const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));
const LS={ ok(){try{localStorage.setItem('__t','1');localStorage.removeItem('__t');return true}catch{return false}},
  get(k,d){try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}},
  set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}, del(k){try{localStorage.removeItem(k)}catch{}} };

/* ============ App State ============ */
let data=LS.get('inv.data',[]), order=LS.get('inv.order',{}), po=LS.get('inv.po',{}),
    theme=LS.get('inv.theme','dark'), damaged=LS.get('inv.damaged',[]), invoices=LS.get('inv.invoices',[]),
    settings=LS.get('inv.settings',{ taxDefault:0, invPrefix:'INV-', highContrast:false, backupReminders:false, lastBackupAt:null, logo:'', themeMode:'dark', currency:'USD', compactRows:false, autoBackupFreq:'off', lastAutoBackupAt:null, backupKeep:5 }),
    snapshots=LS.get('inv.snapshots',{}), statsView=LS.get('inv.statsView','all'), snaps=LS.get('inv.snaps',[]);
let backups=LS.get('inv.backups',[]);
let dirty=false; const markDirty=()=>dirty=true; function markSaved(){ dirty=false; if($('#autoExport')?.checked) downloadCSV(); }

/* === Theme token defaults & initialization === */
const DEFAULT_TOKENS = {
  dark:  { bg:'#0b0e12', bg2:'#10151c', text:'#e7ecf2', muted:'#aab4c2',
           accent:'#18d47b', danger:'#ff5e6a', warn:'#ffb020', card:'#0f141b',
           border:'#233041', shadow:'rgba(0,0,0,.35)' },
  light: { bg:'#f5f8fc', bg2:'#ffffff', text:'#0f1720', muted:'#4a5a6f',
           accent:'#09e3f3', danger:'#c62828', warn:'#b26a00', card:'#ffffff',
           border:'#d9e3ef', shadow:'rgba(0,0,0,.12)' },
  hc:    { border:'#4aa3ff', muted:'#dfe7f2' }
};
if (!settings.themeTokens) {
  settings.themeTokens = JSON.parse(JSON.stringify(DEFAULT_TOKENS));
  LS.set('inv.settings', settings);
}

    // Export employeeSchedules to CSV
    function downloadScheduleCSV() {
      const lines = [];
      lines.push('Date,Employee,Start,End,Type,Role,Note');
      if (Array.isArray(employeeSchedules)) {
        employeeSchedules.forEach(sh => {
          const emp = employees.find(e => e.id === sh.employeeId);
          const empName = emp ? emp.name : (sh.employeeId || 'Open');
          const row = [
            sh.date || '',
            empName || '',
            sh.start || '',
            sh.end || '',
            sh.type || '',
            sh.role || '',
            sh.note || ''
          ].map(x => '"' + String(x).replace(/"/g, '""') + '"').join(',');
          lines.push(row);
        });
      }
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'schedules.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    /* ========= Payroll and Deductions functions ========= */
    // Load payroll periods from localStorage
    function loadPayrollPeriods() {
      try {
        const saved = LS.get('inv.payrollPeriods');
        payrollPeriods = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        payrollPeriods = [];
      }
    }
    // Save payroll periods to localStorage
    function savePayrollPeriods() {
      LS.set('inv.payrollPeriods', JSON.stringify(payrollPeriods));
    }
    // Load deductions from localStorage
    function loadDeductions() {
      try {
        const saved = LS.get('inv.deductions');
        deductions = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        deductions = [];
      }
    }
    // Save deductions to localStorage
    function saveDeductions() {
      LS.set('inv.deductions', JSON.stringify(deductions));
    }
    // Calculate gross pay for an employee between dates
    function calcGrossPay(empId, start, end) {
      let gross = 0;
      const emp = employees.find(e => e.id === empId);
      if (!emp) return gross;
      // If salary present, pro-rate salary based on payroll frequency
      if (emp.salary && emp.salary > 0) {
        const freq = payPeriod.frequency || 'monthly';
        if (freq === 'annual') {
          gross = emp.salary;
        } else if (freq === 'monthly') {
          gross = emp.salary / 12;
        } else if (freq === 'biweekly') {
          gross = emp.salary / 26;
        } else if (freq === 'weekly') {
          gross = emp.salary / 52;
        } else if (freq === 'daily') {
          gross = emp.salary / 365;
        } else {
          gross = emp.salary / 12;
        }
      } else {
        // compute hours from schedules
        if (Array.isArray(employeeSchedules)) {
          employeeSchedules.forEach(sh => {
            if (sh.employeeId === empId) {
              // check date in range
              if ((start === '' || sh.date >= start) && (end === '' || sh.date <= end)) {
                const st = sh.start;
                const en = sh.end;
                if (st && en) {
                  const tStart = Date.parse('1970-01-01T' + st + 'Z');
                  const tEnd = Date.parse('1970-01-01T' + en + 'Z');
                  if (tEnd > tStart) {
                    const hours = (tEnd - tStart) / 3600000;
                    // Include hours for shift, PTO or holiday; exclude unpaid/absence
                    if (sh.type === 'shift' || sh.type === 'pto' || sh.type === 'holiday') {
                      gross += hours * (emp.hourlyRate || 0);
                    } else if (sh.type === 'overtime') {
                      gross += hours * (emp.overtimeRate || emp.hourlyRate || 0);
                    }
                  }
                }
              }
            }
          });
        }
        // include hours from timesheets (manual clock-in/out)
        if (Array.isArray(employeeTimesheets)) {
          employeeTimesheets.forEach(ts => {
            if (ts.employeeId === empId) {
              if ((start === '' || ts.date >= start) && (end === '' || ts.date <= end)) {
                if (ts.start && ts.end) {
                  const tStart = Date.parse('1970-01-01T' + ts.start + 'Z');
                  const tEnd = Date.parse('1970-01-01T' + ts.end + 'Z');
                  if (tEnd > tStart) {
                    const hrs = (tEnd - tStart) / 3600000;
                    gross += hrs * (emp.hourlyRate || 0);
                  }
                }
              }
            }
          });
        }
      }
      return gross;
    }
    // Calculate withholding taxes using a flat rate stored in settings (default 10%)
    function calcWithholding(empId, gross) {
      const rate = (settings && typeof settings.taxRate === 'number') ? settings.taxRate : 0.10;
      return gross * rate;
    }
    // Calculate employee-specific deductions (sum of defined deductions) for a given gross
    function calcEmployeeDeductions(empId, gross) {
      let total = 0;
      if (Array.isArray(deductions)) {
        deductions.forEach(d => {
          if (d.employeeId === empId) {
            if (d.percent) {
              total += gross * d.amount;
            } else {
              total += Number(d.amount) || 0;
            }
          }
        });
      }
      return total;
    }
    // Calculate net pay (gross, tax, deductions, net) for an employee between dates
    function calcNetPay(empId, start, end) {
      const gross = calcGrossPay(empId, start, end);
      const tax = calcWithholding(empId, gross);
      const ded = calcEmployeeDeductions(empId, gross);
      return { gross: gross, tax: tax, deductions: ded, net: gross - tax - ded };
    }
    // Run payroll for the current pay period for all active employees
    function runPayroll() {
      if (!payPeriod || !payPeriod.start || !payPeriod.end) {
        alert('Please set the payroll period start and end dates before running payroll.');
        return;
      }
      const start = payPeriod.start;
      const end = payPeriod.end;
      // Remove existing records for this period
      payrollPeriods = payrollPeriods.filter(p => p.start !== start || p.end !== end);
      // Generate payroll records for each active employee
      employees.forEach(emp => {
        if (emp.active !== false) {
          const res = calcNetPay(emp.id, start, end);
          payrollPeriods.push({
            id: uid(),
            employeeId: emp.id,
            name: emp.name,
            start: start,
            end: end,
            gross: res.gross,
            tax: res.tax,
            deductions: res.deductions,
            net: res.net,
            paid: false,
            timestamp: ''
          });
        }
      });
      savePayrollPeriods();
      renderPayroll();
      updatePayTracker();
      alert('Payroll calculations completed.');
    }
    // Render payroll table
    function renderPayroll() {
      const tbody = document.getElementById('payrollBody');
      if (!tbody) return;
      if (!Array.isArray(payrollPeriods) || payrollPeriods.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No payroll records.</td></tr>';
        return;
      }
      let html = '';
      payrollPeriods.forEach(pr => {
        const emp = employees.find(e => e.id === pr.employeeId) || {};
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || pr.name || '') + '</td>' +
          '<td class="right">' + fmt(pr.gross || 0) + '</td>' +
          '<td class="right">' + fmt(pr.tax || 0) + '</td>' +
          '<td class="right">' + fmt(pr.deductions || 0) + '</td>' +
          '<td class="right">' + fmt(pr.net || 0) + '</td>' +
          '<td class="center"><input type="checkbox" data-payroll="' + pr.id + '"' + (pr.paid ? ' checked' : '') + '></td>' +
          '<td class="center"><button class="btn small" data-act="stub" data-id="' + pr.id + '">Print Stub</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      // Attach handlers for paid checkbox
      tbody.querySelectorAll('input[type="checkbox"][data-payroll]').forEach(ch => {
        ch.addEventListener('change', function() {
          const id = this.getAttribute('data-payroll');
          const rec = payrollPeriods.find(p => p.id === id);
          if (rec) {
            rec.paid = this.checked;
            rec.timestamp = this.checked ? new Date().toISOString() : '';
            savePayrollPeriods();
            updatePayTracker();
            renderStats();
          }
        });
      });
      // Attach handler for print stub
      tbody.querySelectorAll('button[data-act="stub"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const rec = payrollPeriods.find(p => p.id === id);
          if (rec) generatePayStub(rec);
        });
      });
    }
    // Generate simple pay stub in a new window
    function generatePayStub(rec) {
      const emp = employees.find(e => e.id === rec.employeeId) || {};
      const win = window.open('', '', 'width=480,height=600');
      win.document.write('<html><head><title>Pay Stub</title><style>body{font-family:Arial,sans-serif;padding:20px;} .row{margin-bottom:6px;} h2{text-align:center;}</style></head><body>');
      win.document.write('<h2>Pay Stub</h2>');
      win.document.write('<div class="row"><strong>Employee:</strong> ' + htmlEsc(emp.name || '') + '</div>');
      win.document.write('<div class="row"><strong>Period:</strong> ' + htmlEsc(rec.start || '') + ' to ' + htmlEsc(rec.end || '') + '</div>');
      win.document.write('<div class="row"><strong>Gross Pay:</strong> ' + fmt(rec.gross || 0) + '</div>');
      win.document.write('<div class="row"><strong>Taxes:</strong> ' + fmt(rec.tax || 0) + '</div>');
      win.document.write('<div class="row"><strong>Deductions:</strong> ' + fmt(rec.deductions || 0) + '</div>');
      win.document.write('<div class="row"><strong>Net Pay:</strong> ' + fmt(rec.net || 0) + '</div>');
      win.document.write('</body></html>');
      win.document.close();
      win.focus();
    }
    // Render deduction list
    function renderDeductions() {
      const tbody = document.getElementById('deductionsBody');
      if (!tbody) return;
      if (!Array.isArray(deductions) || deductions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="muted">No deductions defined.</td></tr>';
        return;
      }
      let html = '';
      deductions.forEach(d => {
        const emp = employees.find(e => e.id === d.employeeId) || {};
        html += '<tr>' +
          '<td>' + htmlEsc(emp.name || '') + '</td>' +
          '<td>' + htmlEsc(d.name || '') + '</td>' +
          '<td class="right">' + (d.percent ? (d.amount * 100).toFixed(2) + '%' : fmt(d.amount || 0)) + '</td>' +
          '<td>' + (d.preTax ? 'Yes' : 'No') + '</td>' +
          '<td class="center"><button class="btn small danger" data-act="del" data-id="' + d.id + '">Delete</button></td>' +
        '</tr>';
      });
      tbody.innerHTML = html;
      // Attach delete handler
      tbody.querySelectorAll('button[data-act="del"]').forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          if (!confirm('Delete deduction?')) return;
          deductions = deductions.filter(d => d.id !== id);
          saveDeductions();
          renderDeductions();
          // Update employee detail deductions if dialog is open
          try {
            const dlgEmp = document.getElementById('dlgEmployee');
            if (dlgEmp && dlgEmp.hasAttribute('open')) {
              const empIdField = document.getElementById('empId');
              const currentEmp = empIdField ? empIdField.value : '';
              if (currentEmp && typeof renderEmployeeDetailDeductions === 'function') {
                renderEmployeeDetailDeductions(currentEmp);
              }
            }
          } catch (ex) {}
        });
      });
    }
    // Open deduction dialog for new or edit
    function openDeductionDialog(d) {
      const dlg = document.getElementById('dlgDeduction');
      if (!dlg) return;
      document.getElementById('dedTitle').textContent = d ? 'Edit Deduction' : 'New Deduction';
      $('#dedId').value = d?.id || '';
      // Populate employee options
      const sel = document.getElementById('dedEmployee');
      if (sel) {
        sel.innerHTML = '';
        employees.forEach(emp => {
          const opt = document.createElement('option');
          opt.value = emp.id;
          opt.textContent = emp.name;
          sel.appendChild(opt);
        });
        sel.value = d?.employeeId || (employees[0] && employees[0].id) || '';
      }
      $('#dedName').value = d?.name || '';
      if (d && d.percent) {
        $('#dedAmount').value = (d.amount * 100).toFixed(2);
        $('#dedAmountType').value = 'percent';
      } else {
        $('#dedAmount').value = d?.amount || '';
        $('#dedAmountType').value = 'dollar';
      }
      document.getElementById('dedPreTax').checked = d?.preTax || false;
      showDialog(dlg);
    }
    // Save deduction from dialog
    function saveDeductionDialog() {
      const id = $('#dedId').value || uid();
      const amountType = $('#dedAmountType').value;
      let amountVal = +$('#dedAmount').value || 0;
      const deduction = {
        id: id,
        employeeId: $('#dedEmployee').value,
        name: $('#dedName').value.trim(),
        amount: amountType === 'percent' ? (amountVal / 100) : amountVal,
        percent: (amountType === 'percent'),
        preTax: document.getElementById('dedPreTax').checked
      };
      if (!deduction.name || !deduction.employeeId) {
        alert('Employee and deduction name are required.');
        return;
      }
      const idx = deductions.findIndex(x => x.id === id);
      if (idx >= 0) {
        deductions[idx] = deduction;
      } else {
        deductions.push(deduction);
      }
      saveDeductions();
      renderDeductions();
      // Update employee detail deductions if dialog is open
      try {
        const dlgEmp = document.getElementById('dlgEmployee');
        if (dlgEmp && dlgEmp.hasAttribute('open')) {
          const empIdField = document.getElementById('empId');
          const currentEmp = empIdField ? empIdField.value : '';
          if (currentEmp && typeof renderEmployeeDetailDeductions === 'function') {
            renderEmployeeDetailDeductions(currentEmp);
          }
        }
      } catch (ex) {}
      hideDialog(document.getElementById('dlgDeduction'));
    }
    // Update total employee pay stat on overview
    function updatePayTracker() {
      let total = 0;
      if (Array.isArray(payrollPeriods)) {
        payrollPeriods.forEach(p => {
          if (p.paid) total += Number(p.net) || 0;
        });
      }
      const el = document.getElementById('statPay');
      if (el) el.textContent = fmt(total);
    }

/* === Theme resolver & editor sync helpers === */
function getEffectiveMode(pref = (settings?.themeMode || theme || 'dark')){
  if (pref === 'auto'){
    try { return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'; }
    catch { return 'dark'; }
  }
  return pref;
}

    // Load timesheets from localStorage
    function loadEmployeeTimesheets() {
      try {
        const saved = LS.get('inv.timesheets');
        employeeTimesheets = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        employeeTimesheets = [];
      }
    }
    // Save timesheets to localStorage
    function saveEmployeeTimesheets() {
      LS.set('inv.timesheets', JSON.stringify(employeeTimesheets));
    }
    // Load tasks from localStorage
    function loadEmployeeTasks() {
      try {
        const saved = LS.get('inv.tasks');
        employeeTasks = saved ? JSON.parse(saved) : [];
      } catch (ex) {
        employeeTasks = [];
      }
    }
    // Save tasks to localStorage
    function saveEmployeeTasks() {
      LS.set('inv.tasks', JSON.stringify(employeeTasks));
    }
// Keep Settings → Theme Colors pickers synced with the active palette
function syncThemeEditorUI(){
  const dlg = document.getElementById('dlgSettings');
  if (!dlg?.open) return;
  const selMode  = document.getElementById('setThemeMode');
  const selColor = document.getElementById('setColorMode');
  if (selMode)  selMode.value = settings.themeMode || 'dark';
  const currentPalette = settings.highContrast ? 'hc' : getEffectiveMode();
  if (selColor) selColor.value = currentPalette;
  if (typeof window.fillColorInputs === 'function'){
    window.fillColorInputs(currentPalette);
  }
}

/* Theme & HC + Compact */
function applyTheme(){
  // Resolve actual rendering mode
  let mode = getEffectiveMode(settings.themeMode || theme || 'dark');

  const root = document.documentElement;
  root.classList.toggle('light', mode === 'light');
  root.classList.toggle('dark',  mode !== 'light');
  root.style.colorScheme = (mode === 'light' ? 'light' : 'dark');

  // Merge base + custom tokens
  const base   = DEFAULT_TOKENS[mode] || {};
  const custom = (settings.themeTokens && settings.themeTokens[mode]) || {};
  const tok = Object.assign({}, base, custom);

  // Apply variables
  const setVar = (k, v) => (v != null) && root.style.setProperty('--' + k, String(v));
  ['bg','bg2','text','muted','accent','danger','warn','card','border','shadow'].forEach(k => setVar(k, tok[k]));
  // Keep a secondary accent if your CSS uses it
  root.style.setProperty('--accent-2', tok.accent || base.accent || getComputedStyle(root).getPropertyValue('--accent-2') || '#4fd8f0');

  // High contrast overlay
  root.classList.toggle('hc', !!settings.highContrast);
  if (settings.highContrast){
    const hc = (settings.themeTokens && settings.themeTokens.hc) || {};
    Object.keys(hc).forEach(k => setVar(k, hc[k]));
  }

  // Persist last-effective mode for quick toggle
  LS.set('inv.theme', mode);
}

try{
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener('change', ()=>{
    if ((settings.themeMode || 'dark') === 'auto'){
      applyTheme();
      if (!settings.highContrast) syncThemeEditorUI();
    }
  });
}catch{}
document.documentElement.classList.toggle('hc',!!settings.highContrast);
document.body.classList.toggle('compact', !!settings.compactRows);
applyTheme();
syncThemeEditorUI();

/* Remove old "Overview" card safely */
(function(){ const byId=document.getElementById('dashboard'); if(byId) byId.remove();
  for(const card of document.querySelectorAll('.card')){ const h2=card.querySelector('h2');
    const legacy=h2&&/overview/i.test(h2.textContent)&&card.querySelector('.totals');
    const isNew=card.classList.contains('stats-card')||card.id==='overview'; if(legacy&&!isNew){ card.remove(); break; } }
})();

/* ============ Header Buttons ============ */
$('#btnTheme').addEventListener('click', ()=>{
  const current = LS.get('inv.theme','dark');
  settings.themeMode = (current === 'light') ? 'dark' : 'light';
  LS.set('inv.settings', settings);
  applyTheme();

  // Keep Settings dialog widgets in sync if open
  const dlg = document.getElementById('dlgSettings');
  if (dlg?.open){
    const selMode  = document.getElementById('setThemeMode');
    if (selMode) selMode.value = settings.themeMode;

    if (!settings.highContrast){
      const selColor = document.getElementById('setColorMode');
      const cm = getEffectiveMode();
      if (selColor) selColor.value = cm;
      if (typeof window.fillColorInputs === 'function') window.fillColorInputs(cm);
    } else {
      const selColor = document.getElementById('setColorMode');
      if (selColor) selColor.value = 'hc';
      if (typeof window.fillColorInputs === 'function') window.fillColorInputs('hc');
    }
  }
});

$('#btnDemo').addEventListener('click',()=>{
  if(!confirm('Replace current data with demo items?')) return;
  const t=nowISO();
  data=[
    {id:uid(),name:'Thermal Label Roll',sku:'LBL-4x6-500',category:'Supplies',supplier:'LabelCo',qty:12,reorderAt:20,cost:7.5,price:19.99,packageCost:75,packageQty:100,unitLabel:'pcs',singleOnly:false,measurable:false,forSale:true,restockOnly:false,notes:'4x6 500/roll',photo:'',updated:t,components:''},
    {id:uid(),name:'Black Ink XL',sku:'INK-BK-XL',category:'Consumable',supplier:'InkWorks',qty:4,reorderAt:8,cost:18,price:39,packageCost:180,packageQty:100,unitLabel:'ml',singleOnly:false,measurable:true,forSale:true,restockOnly:false,notes:'~600 pages',photo:'',updated:t,components:''},
    {id:uid(),name:'Thermal Printer',sku:'PRN-TH-200',category:'Hardware',supplier:'AutoPrint',qty:1,reorderAt:2,cost:120,price:209,packageCost:0,packageQty:1,unitLabel:'pcs',singleOnly:true,measurable:false,forSale:false,restockOnly:true,notes:'USB + BT',photo:'',updated:t,components:''},
  ];
  order={}; po={}; damaged=[];
  saveAll(); fullRender();
  const sb = $('#btnSaveNow'); if(sb) sb.style.display='';
});

/* ✨ Unified quick save: JSON backup + optional CSV if toggle is ON */
function quickSave(){
  saveBackup(true);
  if($('#autoExport')?.checked) downloadCSV();
  alert('Backup saved and downloaded.' + ($('#autoExport')?.checked ? ' CSV exported too.' : ''));
}
$('#btnSaveNow').addEventListener('click', quickSave);

$('#btnReset').addEventListener('click',()=>{
  if(prompt('Type RESET to confirm clearing ALL data.')!=='RESET') return alert('Reset cancelled.');
  data=[]; order={}; po={}; damaged=[]; invoices=[]; settings={ taxDefault:0, invPrefix:'INV-', highContrast:false, backupReminders:false, lastBackupAt:null, logo:'', themeMode:'dark', currency:'USD', compactRows:false, autoBackupFreq:'off', lastAutoBackupAt:null, backupKeep:5 }; snaps=[]; backups=[];
  LS.set('inv.backups',backups);
  saveAll(); fullRender();
});

/* Backup banner */
function refreshBackupBanner(){
  const b=$('#backupBanner'); if(!settings.backupReminders) return b.style.display='none';
  const last=settings.lastBackupAt; if(!last){ $('#backupAge').textContent='a while'; return b.style.display='block'; }
  const d=daysAgo(last); if(d>=14){ $('#backupAge').textContent=`${d} days`; b.style.display='block'; } else b.style.display='none';
}
$('#btnMarkBacked').addEventListener('click',()=>{ settings.lastBackupAt=nowISO(); LS.set('inv.settings',settings); refreshBackupBanner(); });
$('#btnQuickExport').addEventListener('click',()=>downloadCSV());

/* ============ Stats ============ */
const monthKey=(d=new Date())=>d.toISOString().slice(0,7);
const monthKeyShift=o=>{ const d=new Date(); d.setDate(1); d.setHours(0,0,0,0); d.setMonth(d.getMonth()+o); return monthKey(d); };
function totalUnits(it){
  const pk = +it.qty || 0;
  const per = +it.packageQty || 0;
  const loose = +it.unitsLoose || 0;
  return (per > 0 ? pk * per : pk) + loose;
}
const calcInventoryValue = () =>
  data.reduce((s, it) => s + totalUnits(it) * (+it.cost || 0), 0);
const calcEstimatedProfit = () =>
  data.reduce((s, it) => {
    const pr = +it.price || 0, c = +it.cost || 0;
    const forSale = (it.forSale === true) || (!it.restockOnly && pr > 0);
    return forSale ? s + totalUnits(it) * (pr - c) : s;
  }, 0);
function snapshotThisMonthOnce(){ const k=monthKey(); if(!(k in snapshots)){ snapshots[k]=calcInventoryValue(); LS.set('inv.snapshots',snapshots); } }
const calcMoMChange=()=>calcInventoryValue()-Number(snapshots[monthKeyShift(-1)]||0);
// Compute actual revenue by summing totals of all paid invoices
function calcActualRevenue() {
  let sum = 0;
  try {
    if (Array.isArray(invoices)) {
      for (const inv of invoices) {
        if (inv && inv.paid) {
          sum += Number(inv.total) || 0;
        }
      }
    }
  } catch (e) {}
  return sum;
}
function setStatsView(v){ statsView=v||'all'; LS.set('inv.statsView',statsView); $$('.stats-wrap .stat').forEach(el=>el.style.display=(statsView==='all'||el.dataset.k===statsView)?'':'none'); $$('#statsSeg button').forEach(b=>b.classList.toggle('active',b.dataset.view===statsView)); }
// Render the statistics on the overview page, including actual revenue
function renderStats(){
  snapshotThisMonthOnce();
  // inventory value at cost
  $('#statValue').textContent = fmt(calcInventoryValue());
  // estimated sales profit for sale items
  $('#statProfit').textContent = fmt(calcEstimatedProfit());
  // month-over-month change of inventory value
  $('#statMoM').textContent = fmt(calcMoMChange());
  // actual revenue from paid invoices
  $('#statActual').textContent = fmt(calcActualRevenue());
  // total employee pay from paid payroll periods
  if (typeof updatePayTracker === 'function') updatePayTracker();
  // apply current stats view filter
  setStatsView(statsView);
}
$('#statsSeg').addEventListener('click',e=>{ const b=e.target.closest('button[data-view]'); if(!b) return; setStatsView(b.dataset.view); renderStats(); });

/* ===== Normalize loose units into full packages ===== */
function normalizeItemUnits(it){
  const per = +it.packageQty || 0;
  if (!(per > 0)) return it;

  let loose = Math.max(0, +it.unitsLoose || 0);
  if (loose >= per){
    const add = Math.floor(loose / per);
    it.qty = (+it.qty || 0) + add;
    it.unitsLoose = loose % per;
  } else {
    it.unitsLoose = loose;
  }
  return it;
}

/* ============ Settings live listeners (Theme Mode & High Contrast) ============ */
document.addEventListener('change', (e)=>{
  const id = e.target && e.target.id;

  if (id === 'setThemeMode'){
    settings.themeMode = e.target.value || 'dark';
    LS.set('inv.settings', settings);
    applyTheme();

    // Target the active palette unless HC is on
    if (!settings.highContrast){
      const cm = getEffectiveMode();
      const selColor = document.getElementById('setColorMode');
      if (selColor) selColor.value = cm;
      if (typeof window.fillColorInputs === 'function') window.fillColorInputs(cm);
    }
  }

  if (id === 'setHighContrast'){
    // Accept checkbox or select "on/off"
    const val = (e.target.type === 'checkbox') ? e.target.checked : (e.target.value === 'on');
    settings.highContrast = !!val;
    LS.set('inv.settings', settings);
    applyTheme();

    const cm = settings.highContrast ? 'hc' : getEffectiveMode();
    const selColor = document.getElementById('setColorMode');
    if (selColor) selColor.value = cm;
    if (typeof window.fillColorInputs === 'function') window.fillColorInputs(cm);
  }
});

/* ============ CSV/Excel Import/Export ============ */
const headers=[
  'name','sku','category','supplier',
  'qty','reorderAt','cost','price',
  'packageCost','packageQty','unitsLoose',
  'singleOnly','measurable','unitLabel','forSale','restockOnly',
  'components', /* NEW */
  'notes','photo','updated','id'
];

function toCSV(){
  const lines=[headers.join(',')];
  for(const it of data){
    const row=headers.map(h=>{
      let v=it[h]??'';
      if(typeof v==='boolean') v=v?'true':'false';
      if(typeof v==='string'){
        if(v.includes('"')) v=v.replace(/"/g,'""');
        if(/[",\n]/.test(v)) v=`"${v}"`;
      }
      return v;
    }).join(',');
    lines.push(row);
  }
  return lines.join('\n');
}
async function downloadCSV(){
  const fileName = 'inventory.csv';
  if (window.desktop?.saveFile) {
    try{
      const base = (await window.desktop.getPath('downloads')) || '';
      const res = await window.desktop.saveFile({
        defaultPath: (base ? (base + '/') : '') + fileName,
        filters: [{ name:'CSV', extensions:['csv']}],
        data: toCSV()
      });
      if (!res.canceled) alert('Saved: ' + res.filePath);
    }catch(err){
      console.error(err);
      const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }
  } else {
    const blob=new Blob([toCSV()],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  }
}

// Build an Array-of-Arrays for Excel
function buildInventoryAOA(){
  const aoa = [headers.slice()];
  for (const it of data){
    aoa.push(headers.map(h=>{
      let v = it[h] ?? '';
      if (typeof v === 'boolean') return v ? 'true' : 'false';
      if (v == null) return '';
      return v;
    }));
  }
  return aoa;
}
function buildDamagedAOA(){
  const dheaders = ['date','name','sku','qty','costPer','loss','note','itemId','id'];
  const aoa = [dheaders.slice()];
  for (const r of damaged){
    aoa.push([r.ts, r.name, r.sku, r.qty, r.costPer, r.loss, r.note || '', r.itemId, r.id]);
  }
  return aoa;
}

// ===== XLSX loader (LOCAL first; no CDN). Safe if file isn't present. =====
async function ensureXLSX(){
  if (window.XLSX) return true;
  if (ensureXLSX._loading) return ensureXLSX._loading;

  const urls = [
    './xlsx.full.min.js',
    './lib/xlsx.full.min.js'
  ];

  const load = (u)=>new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src=u; s.async=true;
    s.onload=()=>resolve(true);
    s.onerror=()=>reject(u);
    document.head.appendChild(s);
  });

  ensureXLSX._loading = (async ()=>{
    for (const u of urls){
      try { await load(u); if (window.XLSX) return true; } catch(_) {}
    }
    return !!window.XLSX; // false if not found locally
  })();

  return ensureXLSX._loading;
}



// Local-first, then CDN, then ESM dynamic import. Returns a boolean. Safe to call many times.
async function ensureXLSXReady(){
  if (window.XLSX) return true;

  // 1) Try local loader
  if (typeof ensureXLSX === 'function'){
    try { if (await ensureXLSX()) return true; } catch(_) {}
  }

  // 2) Try the CDN-backed loader
  if (typeof window.__ensureXLSX === 'function'){
    try { if (await window.__ensureXLSX()) return true; } catch(_) {}
  }

  // 3) Try ESM dynamic import (works under stricter environments)
  const urls = [
    'https://cdn.sheetjs.com/xlsx-0.20.3/package/xlsx.mjs',
    'https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs',
    'https://cdn.jsdelivr.net/npm/xlsx@0.20.3/+esm'
  ];
  for (const u of urls){
    try{
      const mod = await import(/* @vite-ignore */ u);
      if (mod && mod.utils && (mod.read || mod.readFile)){
        window.XLSX = mod; // expose for the rest of the app
        return true;
      }
    }catch(_){}
  }

  return !!window.XLSX;
}

// ===== Excel 2003 XML (SpreadsheetML) fallback — works offline, no libraries =====
function _xmlEsc(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function aoaToSpreadsheetMLSheets(sheets){
  // sheets: [{ name: 'Inventory', aoa: [][] }, ...]
  const ws = sheets.map(({name, aoa})=>{
    const safeName = _xmlEsc(String(name||'Sheet').slice(0,31));
    const rows = (aoa||[]).map(row=>{
      const cells = (row||[]).map(val=>{
        let t = 'String', v = val;
        if (typeof v === 'number' && Number.isFinite(v)) t = 'Number';
        else if (typeof v === 'boolean') { t='String'; v = v ? 'true':'false'; }
        else if (v == null) v = '';
        return `<Cell><Data ss:Type="${t}">${_xmlEsc(String(v))}</Data></Cell>`;
      }).join('');
      return `<Row>${cells}</Row>`;
    }).join('');
    return `<Worksheet ss:Name="${safeName}">
      <Table>${rows}</Table>
    </Worksheet>`;
  }).join('');

  return `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
          xmlns:o="urn:schemas-microsoft-com:office:office"
          xmlns:x="urn:schemas-microsoft-com:office:excel"
          xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
  <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
    <Created>${new Date().toISOString()}</Created>
    <Version>16.00</Version>
  </DocumentProperties>
  <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
    <ProtectStructure>False</ProtectStructure>
    <ProtectWindows>False</ProtectWindows>
  </ExcelWorkbook>
  ${ws}
</Workbook>`;
}

function saveSpreadsheetML(filename, sheets){
  const xml = aoaToSpreadsheetMLSheets(sheets);
  const blob = new Blob([xml], { type: 'application/vnd.ms-excel' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename.endsWith('.xls') ? filename : (filename + '.xls');
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
}
// ===== Excel export (offline-first). Uses XLSX if found; otherwise XML .xls fallback. =====
function _stamp(){
  const d=new Date(), p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}`;
}

async function downloadXLSX(){
  // Build sheets
  const sheets = [];
  try {
    const inv = buildInventoryAOA?.();
    if (Array.isArray(inv) && inv.length) sheets.push({ name: 'Inventory', aoa: inv });
  } catch(e){ console.warn('Inventory AOA failed:', e); }
  try {
    const dam = buildDamagedAOA?.();
    if (Array.isArray(dam) && dam.length) sheets.push({ name: 'Damaged', aoa: dam });
  } catch(e){ console.warn('Damaged AOA failed:', e); }

  if (!sheets.length){
    alert('No data found to export.');
    return;
  }

  const stamp = _stamp();

  // Prefer local XLSX if present (or loaded via CDN/ESM)
  const hasXLSX = await ensureXLSXReady();
  if (hasXLSX && window.XLSX){
    try{
      const wb = XLSX.utils.book_new();
      for (const s of sheets){
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s.aoa), s.name);
      }
      XLSX.writeFile(wb, `inventory-${stamp}.xlsx`);
      return;
    }catch(err){
      console.warn('XLSX write failed, falling back to XML .xls:', err);
    }
  }

  // Fallback: SpreadsheetML .xls (no library needed)
  saveSpreadsheetML(`inventory-${stamp}.xls`, sheets);
}

// CSV → rows[][]
function parseCSV(text){
  // Strip UTF-8 BOM; normalize line endings
  const t = String(text || '')
    .replace(/^\uFEFF/, '')
    .replace(/\r\n?/g, '\n');

  const rows = [];
  let i = 0, f = '', row = [], q = false;

  while (i < t.length){
    const ch = t[i++];
    if (q){
      if (ch === '"'){
        if (t[i] === '"'){ f += '"'; i++; } else { q = false; }
      } else {
        f += ch;
      }
    } else {
      if (ch === ','){ row.push(f); f = ''; }
      else if (ch === '\n'){ row.push(f); rows.push(row); f = ''; row = []; }
      else if (ch === '"'){ q = true; }
      else { f += ch; }
    }
  }
  if (f.length || row.length){ row.push(f); rows.push(row); }
  return rows;
}

// Import helpers
function toBool(v, def=false){
  const s = String(v ?? '').trim().toLowerCase();
  if (!s) return def;
  return /^(true|1|yes|y)$/i.test(v);
}

/* ===== Header aliases (accept flexible column names) ===== */
function _normHeader(s){
  return String(s ?? '').replace(/^\ufeff/, '').trim();
}
function _canonKey(s){
  return _normHeader(s).toLowerCase().replace(/[^a-z0-9]/g,'');
}
const HEADER_ALIASES = {
  name: ['title','item','product'],
  sku: ['code','itemcode'],
  category: ['cat'],
  supplier: ['vendor','suppliername'],

  qty: ['quantity','stock','onhand'],
  reorderAt: ['reorder','reorderpoint','reorder_at','min','minstock'],
  cost: ['unitcost','cogs','purchasecost'],
  price: ['unitprice','sellprice','saleprice','retail'],

  packageCost: ['packcost','casecost','cartoncost'],
  packageQty: ['unitqty','unitsperpackage','unitsperpack','unitspercase','unitquantity','perpack','perpackage'],
  unitsLoose: ['loose','looseunits','openunits'],

  measurable: ['measurableunits'],
  unitLabel: ['unit','uom','unitlabel'],
  singleOnly: ['single','singleunitonly'],

  forSale: ['forsale'],
  restockOnly: ['restockonly','notforsale'],

  components: ['bom','ingredients','componentsbom','components_bom','component'],

  notes: ['note','description','desc','comments'],
  photo: ['image','imageurl','photourl','picture'],
  updated: ['updatedat','lastupdated','dateupdated','modified'],
  id: ['itemid','uuid']
};
function canonicalHeader(h){
  const raw = _normHeader(h);
  const key = _canonKey(raw);
  if (headers.includes(raw)) return raw;
  for (const [canon, vars] of Object.entries(HEADER_ALIASES)){
    if (canon === key || vars.includes(key)) return canon;
  }
  return raw;
}

/* ====== IMPORT CORE: convert AOA to data[] and merge (id → sku → name) ====== */
function importRowsAOA(rows){
  if (!rows?.length) { alert('No rows to import.'); return; }

  // Trim + alias header
  const head = (rows[0] || []).map(h => canonicalHeader(h));
  rows[0] = head;

  // Build header index map based on expected headers[]
  const idx = {};
  head.forEach((h,i)=>{ if (h) idx[h] = i; });
  const map = headers.map(h => (h in idx ? idx[h] : -1));

  let added = 0, updated = 0;

  function findExisting(obj){
    if (obj.id){
      const byId = data.find(x => x.id === obj.id);
      if (byId) return byId;
    }
    const sku = String(obj.sku || '').trim().toLowerCase();
    if (sku){
      const bySku = data.find(x => String(x.sku||'').trim().toLowerCase() === sku);
      if (bySku) return bySku;
    }
    const name = String(obj.name || '').trim().toLowerCase();
    if (name && !sku){
      const byName = data.find(x =>
        !String(x.sku||'').trim() &&
        String(x.name||'').trim().toLowerCase() === name
      );
      if (byName) return byName;
    }
    return null;
  }

  for (let r=1; r<rows.length; r++){
    const cells = rows[r] || [];
    // skip completely empty row
    if (!cells.some(c => String(c ?? '').trim().length)) continue;

    // Map values by expected headers
    const obj = {};
    headers.forEach((h, i) => {
      const c = map[i];
      obj[h] = c >= 0 ? cells[c] : '';
    });

    // Normalize
    if (!obj.id) obj.id = uid();

    Object.assign(obj, {
      qty:+obj.qty||0,
      reorderAt:+obj.reorderAt||0,
      cost:+obj.cost||0,
      price:+obj.price||0,
      packageCost:+obj.packageCost||0,
      packageQty:+obj.packageQty||0,
      unitsLoose:+obj.unitsLoose||0,
      singleOnly:  toBool(obj.singleOnly, false),
      measurable:  toBool(obj.measurable, false),
      forSale:     toBool(obj.forSale, true),   // default to true
      restockOnly: toBool(obj.restockOnly, false),
      unitLabel:   (obj.unitLabel||'').toString(),
      updated:     obj.updated || nowISO(),
      name:        (obj.name||'').toString(),
      sku:         (obj.sku||'').toString(),
      category:    (obj.category||'').toString(),
      supplier:    (obj.supplier||'').toString(),
      notes:       (obj.notes||'').toString(),
      components:  (obj.components||'').toString(), /* NEW */
      photo:       (obj.photo||'').toString()
    });

    if (obj.restockOnly) obj.forSale = false;
    if (obj.singleOnly) obj.packageQty = 1;

    // NEW: normalize imported rows too
    normalizeItemUnits(obj);

    const ex = findExisting(obj);
    if (ex){ Object.assign(ex, obj); updated++; }
    else { data.push(obj); added++; }
  }

  saveAll(); fullRender();
  alert(`Imported ${rows.length-1} rows. Added ${added}, updated ${updated}.`);
}

/* ====== VALIDATION (with aliasing) ====== */
// Warn on missing/extra headers, but don’t block the import
function validateAndCleanRows(rows){
  if (!rows?.length) throw new Error('No rows detected.');
  // Trim header cells + alias
  const head = (rows[0] || []).map(h => canonicalHeader(h));
  rows[0] = head;

  const missing = headers.filter(h => !head.includes(h));
  const extras  = head.filter(h => h && !headers.includes(h));

  if (missing.length || extras.length){
    let msg = '';
    if (missing.length) msg += `Missing header(s): ${missing.join(', ')}.\n`;
    if (extras.length)  msg += `Unknown header(s) ignored: ${extras.join(', ')}.\n`;
    msg += '\nExpected first row:\n' + headers.join(',');
    alert(msg);
  }
  return rows;
}

/* Auto-export toggle */
$('#autoExport').checked=!!LS.get('inv.autoExport',false);
$('#autoExport').addEventListener('change',e=>LS.set('inv.autoExport',e.target.checked));

/* ============ Image helpers ============ */
async function fileToDataURL(file,maxDim=1600,quality=.88){
  try{ const bmp=await createImageBitmap(file); const {width:w,height:h}=bmp; const s=Math.min(1,maxDim/Math.max(w,h)); const tw=Math.max(1,Math.round(w*s)), th=Math.max(1,Math.round(h*s));
    const c=document.createElement('canvas'); c.width=tw; c.height=th; c.getContext('2d').drawImage(bmp,0,0,tw,th); const png=file.type.includes('png'); return c.toDataURL(png?'image/png':'image/webp',quality);
  }catch{ const fr=await new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});
    const img=await new Promise((res,rej)=>{const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=fr;});
    const c=document.createElement('canvas'); const s=Math.min(1,1600/Math.max(img.width,img.height)); c.width=Math.max(1,Math.round(img.width*s)); c.height=Math.max(1,Math.round(img.height*s)); c.getContext('2d').drawImage(img,0,0,c.width,c.height); return c.toDataURL('image/webp',.88);} }
function setPreviewSrc(src){ const img=$('#photoPreview'); if(!img) return; if(src){ img.src=src; img.style.display=''; } else { img.removeAttribute('src'); img.style.display='none'; } }
function clearPhotoUI(){ $('#photoData').value=''; $('#photoUrl').value=''; setPreviewSrc(''); }
const drop=$('#photoDrop'); drop && (drop.style.cursor='pointer');
drop?.addEventListener('click',()=>$('#photoFile')?.click());
$('#photoFile')?.addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ const url=await fileToDataURL(f); $('#photoData').value=url; $('#photoUrl').value=''; setPreviewSrc(url); }catch{ alert('Could not load that image.'); } e.target.value='';
});
$('#btnPhotoUseUrl')?.addEventListener('click',()=>{ const u=$('#photoUrl').value.trim(); if(!u) return alert('Enter a URL first.'); $('#photoData').value=''; setPreviewSrc(u); });
$('#btnPhotoClear')?.addEventListener('click',clearPhotoUI);
['dragenter','dragover'].forEach(ev=>drop?.addEventListener(ev,e=>{ e.preventDefault(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(ev=>drop?.addEventListener(ev,e=>{ e.preventDefault(); if(ev==='dragleave') drop.classList.remove('drag'); }));
drop?.addEventListener('drop',async e=>{ drop.classList.remove('drag'); const f=e.dataTransfer?.files?.[0]; if(!f||!f.type.startsWith('image/')) return alert('Drop an image file.'); try{ const url=await fileToDataURL(f); $('#photoData').value=url; $('#photoUrl').value=''; setPreviewSrc(url);}catch{ alert('Could not load that image.'); }});
$('#dlg')?.addEventListener('paste',async e=>{ const it=[...(e.clipboardData?.items||[])].find(i=>i.type.startsWith('image/')); if(!it) return; const file=it.getAsFile(); if(!file) return; try{ const url=await fileToDataURL(file); $('#photoData').value=url; $('#photoUrl').value=''; setPreviewSrc(url);}catch{ alert('Could not paste that image.'); }});

/* ===== Kit Photo Helpers ===== */
function setKitPreview(src){
  const img = $("#kitPhotoPreview");
  if (!img) return;
  if (src){
    img.src = src;
    img.style.display = "";
  } else {
    img.removeAttribute("src");
    img.style.display = "none";
  }
}
function clearKitPhotoUI(){
  $("#kitEditPhoto").value = "";
  setKitPreview("");
}

const kitDrop = $("#kitPhotoDrop");
kitDrop && (kitDrop.style.cursor = "pointer");
kitDrop?.addEventListener("click", () => $("#kitPhotoFile")?.click());

$("#kitPhotoFile")?.addEventListener("change", async e=>{
  const f = e.target.files?.[0];
  if (!f) return;
  try {
    const url = await fileToDataURL(f);
    $("#kitEditPhoto").value = url;
    setKitPreview(url);
  } catch {
    alert("Could not load that image.");
  }
  e.target.value = "";
});

$("#btnKitPhotoUseUrl")?.addEventListener("click", ()=>{
  const u = $("#kitEditPhoto").value.trim();
  if (!u) return alert("Enter a URL first.");
  setKitPreview(u);
});
$("#btnKitPhotoClear")?.addEventListener("click", clearKitPhotoUI);

["dragenter","dragover"].forEach(ev=>kitDrop?.addEventListener(ev,e=>{
  e.preventDefault(); kitDrop.classList.add("drag");
}));
["dragleave","drop"].forEach(ev=>kitDrop?.addEventListener(ev,e=>{
  e.preventDefault(); if(ev==="dragleave") kitDrop.classList.remove("drag");
}));
kitDrop?.addEventListener("drop", async e=>{
  kitDrop.classList.remove("drag");
  const f = e.dataTransfer?.files?.[0];
  if(!f || !f.type.startsWith("image/")) return alert("Drop an image file.");
  try {
    const url = await fileToDataURL(f);
    $("#kitEditPhoto").value = url;
    setKitPreview(url);
  } catch {
    alert("Could not load that image.");
  }
});

$("#dlgKit")?.addEventListener("paste", async e=>{
  const it = [...(e.clipboardData?.items||[])].find(i=>i.type.startsWith("image/"));
  if(!it) return;
  const file = it.getAsFile();
  if(!file) return;
  try {
    const url = await fileToDataURL(file);
    $("#kitEditPhoto").value = url;
    setKitPreview(url);
  } catch {
    alert("Could not paste that image.");
  }
});


/* ============ Package helper & form glue ============ */
function updatePackHelper(){
  const pc=+$('#packageCost').value||0, pq=+$('#packageQty').value||0, ph=$('#packHelper');
  if(pc>0&&pq>0){ const per=pc/pq; ph.innerHTML=`Package = <strong>${fmt(pc)}</strong> for <strong>${pq}</strong> units → Per-unit = <strong>${fmt(per)}</strong> <button class="btn small" id="btnApplyPackCost">Apply to Cost</button>`;
    $('#btnApplyPackCost').onclick=()=>$('#cost').value=per.toFixed(2);
  }else ph.textContent='Enter package cost & units (Unit Quantity) to auto-calc per-unit cost.';
}
function autoApplyPerUnit(){ const c=+$('#packageCost').value||0,q=+$('#packageQty').value||0; if(c>0&&q>0&&!+$('#cost').value) $('#cost').value=(c/q).toFixed(2); }
$('#packageCost').addEventListener('input',()=>{ updatePackHelper(); autoApplyPerUnit(); });
$('#packageQty').addEventListener('input',()=>{ updatePackHelper(); autoApplyPerUnit(); });
$('#singleOnly').addEventListener('change',()=>{ const pq=$('#packageQty'); if($('#singleOnly').checked){ pq.value=1; pq.disabled=true; } else pq.disabled=false; updatePackHelper(); });
$('#measurable').addEventListener('change',()=>$('#qty').step=$('#measurable').checked?'0.01':'1');

/* ============ CRUD & Persistence ============ */
function saveAll(){
  // normalize items before persisting
  try { for (const it of data) normalizeItemUnits(it); } catch(e) {}

  LS.set('inv.data', data);
  LS.set('inv.order', order);
  LS.set('inv.po', po);
  LS.set('inv.theme', LS.get('inv.theme','dark'));
  LS.set('inv.damaged', damaged);
  LS.set('inv.invoices', invoices);
  LS.set('inv.settings', settings);
  LS.set('inv.snapshots', snapshots);
  LS.set('inv.statsView', statsView);
  LS.set('inv.kits', kits);   // ✅ now kits are persisted

  markSaved();
  refreshBackupBanner();
  snapshotThisMonthOnce();
  renderStats();
}
/* ============ Backups (JSON) ============ */
function backupPayload(){
  return { ts: nowISO(), version: 1,
    data, order, po, damaged, invoices, settings, snapshots, snaps, kits
  };
}
async function downloadJSON(fileName,obj){
  const json=JSON.stringify(obj,null,2);
  if (window.desktop?.saveFile) {
    try{
      const base = (await window.desktop.getPath('downloads')) || '';
      const res = await window.desktop.saveFile({
        defaultPath: (base ? (base + '/') : '') + fileName,
        filters: [{ name:'JSON', extensions:['json']}],
        data: json
      });
      if (!res.canceled) alert('Saved: ' + res.filePath);
    }catch(err){
      console.error(err);
      const blob=new Blob([json],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }
  } else {
    const blob=new Blob([json],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fileName;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
  }
}
function saveBackup(manual = true){
  const stamp  = _stamp(); // e.g. 20250827-1234
  const name   = `inv-backup-${stamp}.json`;
  const payload = backupPayload();

  backups.push({ ts: payload.ts, name, data: payload });
  const keep = Math.max(1, Number(settings.backupKeep || 5));
  if (backups.length > keep) backups = backups.slice(-keep);

  LS.set('inv.backups', backups);
  renderBackupsList();

  if (manual) downloadJSON(name, payload);
}
function restoreFromObject(obj){
  if(!obj || !obj.data) return alert('Invalid backup file.');
  ({ data, order, po, damaged, invoices, settings, snapshots, snaps, kits = [] } = obj);
  settings = Object.assign({
    taxDefault:0,
    invPrefix:'INV-',
    highContrast:false,
    backupReminders:false,
    lastBackupAt:null,
    logo:'',
    footerImage:'',
    footerNotes:'',
    themeMode:'dark',
    currency:'USD',
    compactRows:false,
    autoBackupFreq:'off',
    lastAutoBackupAt:null,
    backupKeep:5
  }, settings||{});
  // Ensure new settings keys exist
  settings.tabVisibility = settings.tabVisibility || {};
  settings.sideOrder = settings.sideOrder || [];
  LS.set('inv.settings',settings);
  applyTheme(); document.body.classList.toggle('compact', !!settings.compactRows);
  saveAll(); fullRender();
}
function renderBackupsList(){
  const box = $('#backupList');
  if(!backups.length){ box.innerHTML='No backups yet.'; return; }
  box.innerHTML = backups.map((b,i)=>`
    <div style="display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:4px 0;border-bottom:1px solid var(--border)">
      <div><strong>${esc(b.name)}</strong><br><span class="muted">${new Date(b.ts).toLocaleString()}</span></div>
      <button class="btn small" onclick="(function(){ const p=LS.get('inv.backups',[])[${i}]; if(p) downloadJSON(p.name,p.data) })()">Download</button>
      <button class="btn small warn" onclick="(function(){ const p=LS.get('inv.backups',[])[${i}]; if(p && confirm('Restore this backup? Current data will be replaced.')) restoreFromObject(p.data) })()">Restore</button>
    </div>
  `).join('');
}

/* NEW: Auto-backup frequency logic */
function freqMs(code){
  switch(code){
    case '2m': return 2*60*1000;
    case '5m': return 5*60*1000;
    case '15m': return 15*60*1000;
    case '30m': return 30*60*1000;
    case '60m': return 60*60*1000;
    case 'daily': return 24*60*60*1000;
    default: return 0;
  }
}
function maybeAutoBackup(){
  const ms = freqMs(settings.autoBackupFreq||'off'); if(!ms) return;
  const last = settings.lastAutoBackupAt ? new Date(settings.lastAutoBackupAt).getTime() : 0;
  if(Date.now() - last >= ms){
    saveBackup(false);
    settings.lastAutoBackupAt = nowISO();
    LS.set('inv.settings', settings);
    renderBackupsList();
  }
}
setInterval(maybeAutoBackup, 60*1000); // check every minute

/* Settings open/save */
$('#btnSettings').addEventListener('click',()=>{ applySettingsToUI(); showDialog($('#dlgSettings')); });
$('#btnSettingsClose').addEventListener('click',()=>hideDialog($('#dlgSettings')));
$('#btnSettingsSave').addEventListener('click',saveSettings);
$('#btnPickLogo').addEventListener('click',()=>$('#setLogoFile').click());
$('#btnClearLogo').addEventListener('click',()=>{ settings.logo=''; applySettingsToUI(); LS.set('inv.settings',settings); });
$('#setLogoFile').addEventListener('change',async e=>{ const f=e.target.files?.[0]; if(!f) return; try{ settings.logo=await fileToDataURL(f,800,.9); applySettingsToUI(); LS.set('inv.settings',settings);}catch{ alert('Could not load logo.'); } e.target.value=''; });
// Footer image pick/clear
$('#btnPickFooterImg')?.addEventListener('click',()=>$('#setFooterFile')?.click());
$('#btnClearFooterImg')?.addEventListener('click',()=>{ settings.footerImage=''; applySettingsToUI(); LS.set('inv.settings', settings); });
$('#setFooterFile')?.addEventListener('change', async e => {
  const f = e.target.files?.[0]; if(!f) return;
  try{
    settings.footerImage = await fileToDataURL(f, 800, .9);
    applySettingsToUI();
    LS.set('inv.settings', settings);
  } catch {
    alert('Could not load footer image.');
  }
  e.target.value = '';
});
$('#btnMarkBacked2').addEventListener('click',()=>{ settings.lastBackupAt=nowISO(); LS.set('inv.settings',settings); refreshBackupBanner(); });

/* === Theme Editor helpers & wiring === */
const COLOR_KEYS = ['bg','bg2','text','muted','accent','danger','warn','card','border','shadow'];
function fillColorInputs(mode){
  const merged = Object.assign({}, DEFAULT_TOKENS[mode]||{}, settings.themeTokens[mode]||{});
  $('#setColor_bg').value     = merged.bg     || '#000000';
  $('#setColor_bg2').value    = merged.bg2    || '#000000';
  $('#setColor_text').value   = merged.text   || '#ffffff';
  $('#setColor_muted').value  = merged.muted  || '#888888';
  $('#setColor_accent').value = merged.accent || '#00ff99';
  $('#setColor_danger').value = merged.danger || '#ff5e6a';
  $('#setColor_warn').value   = merged.warn   || '#ffb020';
  $('#setColor_card').value   = merged.card   || '#101010';
  $('#setColor_border').value = merged.border || '#223344';
  $('#setColor_shadow').value = merged.shadow || 'rgba(0,0,0,.35)';
}
function pushColorChange(mode, key, value){
  settings.themeTokens[mode] = Object.assign({}, settings.themeTokens[mode]||{});
  settings.themeTokens[mode][key] = value;
  LS.set('inv.settings', settings);
  applyTheme();
}
$('#setColorMode')?.addEventListener('change', e => fillColorInputs(e.target.value || 'dark'));
COLOR_KEYS.forEach(k=>{
  const id = (k==='shadow') ? '#setColor_shadow' : '#setColor_'+k;
  const el = document.querySelector(id);
  if (!el) return;
  el.addEventListener('input', e=>{
    const mode = $('#setColorMode').value || 'dark';
    pushColorChange(mode, k, e.target.value);
  });
});
$('#btnThemeResetSel')?.addEventListener('click', ()=>{
  const mode = $('#setColorMode').value || 'dark';
  settings.themeTokens[mode] = JSON.parse(JSON.stringify(DEFAULT_TOKENS[mode] || {}));
  LS.set('inv.settings', settings);
  fillColorInputs(mode);
  applyTheme();
});
$('#btnThemeResetAll')?.addEventListener('click', ()=>{
  if (!confirm('Reset ALL theme colors to defaults?')) return;
  settings.themeTokens = JSON.parse(JSON.stringify(DEFAULT_TOKENS));
  LS.set('inv.settings', settings);
  fillColorInputs($('#setColorMode').value || 'dark');
  applyTheme();
});

function applySettingsToUI(){
  $('#setTaxDef').value=settings.taxDefault ?? 0;
  $('#setInvPrefix').value=settings.invPrefix ?? 'INV-';
  $('#setKitMarkup').value = settings.kitMarkup ?? 50;
  $('#setHighContrast').value=settings.highContrast ? 'on' : 'off';
  $('#setBackupReminders').value=settings.backupReminders ? 'on' : 'off';
  $('#setThemeMode').value=settings.themeMode || 'dark';
  $('#setCurrency').value=settings.currency || 'USD';
  $('#setCompact').value=settings.compactRows ? 'on' : 'off';
  $('#setAutoBackupFreq').value=settings.autoBackupFreq || 'off';
  $('#setBackupKeep').value= settings.backupKeep || 5;

  settings.display = settings.display || {};
  $('#setShowReorder').value      = (settings.display.showReorderLine===false)?'off':'on';
  $('#setShowUnitQty').value      = (settings.display.showUnitQtyLine===false)?'off':'on';
  $('#setShowTotalUnits').value   = (settings.display.showTotalUnitsLine===false)?'off':'on';
  $('#setHideZero').value         = settings.display.hideZeroValues ? 'on' : 'off';

  // Tab visibility defaults: if setting object missing, default to showing all tabs
  settings.tabVisibility = settings.tabVisibility || {};
  // Set each tab select based on saved visibility (undefined treated as on)
  const tabMap = {
    Inventory: 'inventory',
    Order: 'order',
    Reorder: 'reorder',
    Kits: 'kits',
    Damaged: 'damaged',
    Invoice: 'invoice',
    Invoices: 'invoices',
    Calendar: 'calendar',
    Rentals: 'rentals',
    Schedule: 'schedule',
    Tracking: 'tracking',
    Management: 'management',
    Taxes: 'taxes'
  };
  Object.entries(tabMap).forEach(([key, view]) => {
    const el = document.getElementById('setTab' + key.charAt(0).toUpperCase() + key.slice(1));
    if (el) {
      el.value = (settings.tabVisibility[view] === false) ? 'off' : 'on';
    }
  });

  // Card visibility defaults: ensure cardVisibility object exists
  settings.cardVisibility = settings.cardVisibility || {};
  // Mapping of display labels to card view keys
  const cardMap = {
    Stats: 'stats',
    Inventory: 'inventory',
    Order: 'order',
    Reorder: 'reorder',
    Kits: 'kits',
    Calendar: 'calendar',
    Rentals: 'rentals',
    Schedule: 'schedule',
    Tracking: 'tracking',
    Damaged: 'damaged',
    Invoice: 'invoice',
    Invoices: 'invoices'
  };
  Object.entries(cardMap).forEach(([key, view]) => {
    const el = document.getElementById('setCard' + key);
    if (el) {
      el.value = (settings.cardVisibility[view] === false) ? 'off' : 'on';
    }
  });

  const activePalette = settings.highContrast ? 'hc' : getEffectiveMode(settings.themeMode || 'dark');
  $('#setColorMode').value = activePalette;
  fillColorInputs(activePalette);

  const lp=$('#logoPreview'); if(settings.logo){ lp.src=settings.logo; lp.style.display=''; } else { lp.removeAttribute('src'); lp.style.display='none'; }

  // Apply footer image and notes
  const fp = document.getElementById('footerPreview');
  if(fp){
    if(settings.footerImage){ fp.src = settings.footerImage; fp.style.display = ''; }
    else { fp.removeAttribute('src'); fp.style.display = 'none'; }
  }
  const fnEl = document.getElementById('setFooterNotes');
  if(fnEl){ fnEl.value = settings.footerNotes || ''; }
  document.documentElement.classList.toggle('hc', !!settings.highContrast);
  document.body.classList.toggle('compact', !!settings.compactRows);
  if(!$('#invTax').value) $('#invTax').value = settings.taxDefault || 0;
  renderBackupsList();
  refreshBackupBanner();
}
function saveSettings(){
  settings.taxDefault = +$('#setTaxDef').value||0;
  settings.invPrefix   = ($('#setInvPrefix').value||'INV-').trim() || 'INV-';
  settings.highContrast = ($('#setHighContrast').value==='on');
  settings.backupReminders = ($('#setBackupReminders').value==='on');
  settings.themeMode = $('#setThemeMode').value;
  settings.currency = $('#setCurrency').value || 'USD';
  settings.compactRows = ($('#setCompact').value==='on');
  settings.autoBackupFreq = $('#setAutoBackupFreq').value || 'off';
  settings.backupKeep = Math.max(1, +$('#setBackupKeep').value||5);
  // Save footer notes
  const fnEl = document.getElementById('setFooterNotes');
  if(fnEl) settings.footerNotes = fnEl.value.trim();
settings.kitMarkup = Math.max(0, +$('#setKitMarkup').value||0);

  settings.display = settings.display || {};
  settings.display.showReorderLine    = ($('#setShowReorder').value!=='off');
  settings.display.showUnitQtyLine    = ($('#setShowUnitQty').value!=='off');
  settings.display.showTotalUnitsLine = ($('#setShowTotalUnits').value!=='off');
  settings.display.hideZeroValues     = ($('#setHideZero').value==='on');

  // Save tab visibility selections (undefined treated as true)
  settings.tabVisibility = settings.tabVisibility || {};
  settings.tabVisibility.inventory = ($('#setTabInventory')?.value !== 'off');
  settings.tabVisibility.order     = ($('#setTabOrder')?.value !== 'off');
  settings.tabVisibility.reorder   = ($('#setTabReorder')?.value !== 'off');
  settings.tabVisibility.kits      = ($('#setTabKits')?.value !== 'off');
  settings.tabVisibility.damaged   = ($('#setTabDamaged')?.value !== 'off');
  settings.tabVisibility.invoice   = ($('#setTabInvoice')?.value !== 'off');
  settings.tabVisibility.invoices  = ($('#setTabInvoices')?.value !== 'off');
  settings.tabVisibility.calendar  = ($('#setTabCalendar')?.value !== 'off');
  settings.tabVisibility.rentals   = ($('#setTabRentals')?.value !== 'off');
  settings.tabVisibility.schedule  = ($('#setTabSchedule')?.value !== 'off');
  settings.tabVisibility.tracking  = ($('#setTabTracking')?.value !== 'off');

  // Additional tabs for employee management and taxes
  settings.tabVisibility.management = ($('#setTabManagement')?.value !== 'off');
  settings.tabVisibility.taxes     = ($('#setTabTaxes')?.value !== 'off');

  // Save card visibility selections (undefined treated as true)
  settings.cardVisibility = settings.cardVisibility || {};
  settings.cardVisibility.stats     = ($('#setCardStats')?.value !== 'off');
  settings.cardVisibility.inventory = ($('#setCardInventory')?.value !== 'off');
  settings.cardVisibility.order     = ($('#setCardOrder')?.value !== 'off');
  settings.cardVisibility.reorder   = ($('#setCardReorder')?.value !== 'off');
  settings.cardVisibility.kits      = ($('#setCardKits')?.value !== 'off');
  settings.cardVisibility.calendar  = ($('#setCardCalendar')?.value !== 'off');
  settings.cardVisibility.rentals   = ($('#setCardRentals')?.value !== 'off');
  settings.cardVisibility.schedule  = ($('#setCardSchedule')?.value !== 'off');
  settings.cardVisibility.tracking  = ($('#setCardTracking')?.value !== 'off');
  settings.cardVisibility.damaged   = ($('#setCardDamaged')?.value !== 'off');
  settings.cardVisibility.invoice   = ($('#setCardInvoice')?.value !== 'off');
  settings.cardVisibility.invoices  = ($('#setCardInvoices')?.value !== 'off');

  LS.set('inv.settings', settings);
  document.documentElement.classList.toggle('hc', !!settings.highContrast);
  document.body.classList.toggle('compact', !!settings.compactRows);
  applyTheme();
  hideDialog($('#dlgSettings'));
  refreshBackupBanner();
  // Update navigation visibility based on new tab settings without full reload
  document.querySelectorAll('#cardTabs a').forEach(function(el) {
    const v = el.dataset.view;
    if (v && v !== 'overview') {
      if (settings.tabVisibility && settings.tabVisibility[v] === false) {
        el.style.display = 'none';
      } else {
        el.style.display = '';
      }
    }
  });
  // If the current view is now hidden, fallback to overview
  try {
    const params = new URLSearchParams(window.location.search);
    const curView = params.get('view') || 'overview';
    if (settings.tabVisibility && settings.tabVisibility[curView] === false) {
      window.location.search = '?view=overview';
    }
  } catch {}
  // After updating settings, update visibility of cards on the overview (if applicable)
  try {
    if (typeof updateOverviewCards === 'function') updateOverviewCards();
  } catch {}
  render();
}

/* Data & Backups buttons */
$('#btnSaveBackup').addEventListener('click',()=>{ saveBackup(true); alert('Backup saved and downloaded.'); });
$('#btnDownloadLast').addEventListener('click',()=>{
  if(!backups.length) return alert('No backups yet.');
  const b = backups[backups.length-1]; downloadJSON(b.name, b.data);
});
$('#btnRestoreBackup').addEventListener('click',()=>$('#setRestoreFile').click());
$('#setRestoreFile').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{
      const obj=JSON.parse(String(r.result||''));
      if(confirm('Restore this backup? Current data will be replaced.')) restoreFromObject(obj);
    }catch{ alert('Not a valid backup JSON.'); }
    e.target.value='';
  };
  r.readAsText(f);
});
$('#btnExportCSV2').addEventListener('click', downloadCSV);
$('#btnExportXLSX2').addEventListener('click', downloadXLSX);

/* ============ Inventory Render (delegation) ============ */
function rowHTML(it){
  const warn=(+it.qty||0)<= (+it.reorderAt||0);
  const d=new Date(it.updated||Date.now());
  const disp = settings.display || {};

  const pq = +it.packageQty || 0;
  const totUnits = totalUnits(it);

  const showRe = disp.showReorderLine!==false && (!disp.hideZeroValues || (+it.reorderAt||0)!==0);
  const showUQ = disp.showUnitQtyLine!==false && pq>0 && (!disp.hideZeroValues || pq!==0);
  const showTU = disp.showTotalUnitsLine!==false && pq>0 && (!disp.hideZeroValues || totUnits!==0);

  return `
  <tr>
    <td>${it.photo?`<img class="photoThumb" src="${esc(it.photo)}" alt="">`:`<div class="photoThumb" style="background:#0001"></div>`}</td>
    <td><strong>${esc(it.name)}</strong><br><span class="muted">${esc(it.sku||'')}</span></td>
    <td>${esc(it.category||'')}<br><span class="muted">${esc(it.supplier||'')}</span></td>
    <td class="right">
      <div class="qtychip">
        <button class="qbtn" data-act="dec" data-id="${it.id}">−</button>
        <strong class="${warn?'warn-text':''}">${+it.qty||0}</strong>
        <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
      </div>
      ${showRe ? `<div class="muted">Reorder @ ${+it.reorderAt||0}</div>` : ''}
      ${showUQ ? `<div class="muted">Unit Qty: ${pq} ${esc(it.unitLabel||'units')} per Qty</div>` : ''}
      ${showTU ? `<div class="muted">Total Units: ${totUnits} ${esc(it.unitLabel||'units')}</div>` : ''}
    </td>
    <td class="right">${fmt(it.cost)}<br><span class="muted">${fmt(it.price)}</span></td>
    <td>${esc(it.notes||'')}</td>
    <td><span class="muted">${d.toLocaleString()}</span></td>
    <td class="row-actions">
      <button class="btn small" data-act="edit" data-id="${it.id}">Edit</button>
      <button class="btn small" data-act="dup"  data-id="${it.id}">Duplicate</button>
      <button class="btn small danger" data-act="del" data-id="${it.id}">Delete</button>
      <button class="btn small accent" data-act="add" data-id="${it.id}">Add to Order</button>
      ${it.measurable?`<button class="btn small" data-act="use" data-id="${it.id}">Use Units</button>`:''}
    </td>
  </tr>`;
}
function render(){
  const q=$('#search').value.trim().toLowerCase();
  const rows=data.filter(it=>!q || [it.name,it.sku,it.category,it.supplier,it.notes].some(v=>String(v||'').toLowerCase().includes(q)));
  $('#rows').innerHTML=rows.map(rowHTML).join('');
  populateDamSelect(); renderOrderSearch(); renderReorder(); renderPO(); renderStats(); renderDashboard();
}
$('#rows').addEventListener('click',e=>{
  const btn=e.target.closest('[data-act]'); if(!btn) return; const id=btn.dataset.id, act=btn.dataset.act;
  if(act==='inc') return adjQty(id,1);
  if(act==='dec') return adjQty(id,-1);
  if(act==='edit') return editItem(id);
  if(act==='dup') return duplicateItem(id);
  if(act==='del') return delItem(id);
  if(act==='add') return addToOrder(id,1);
  if(act==='use') return useUnits(id);
});

/* CRUD helpers */
function openDialog(it){
  $('#dlgTitle').textContent=it?'Edit Item':'New Item';
  const F=['id','name','sku','category','supplier','qty','reorderAt','cost','price','packageCost','packageQty','unitsLoose','notes','components']; /* UPDATED */
  F.forEach(k=>{ const el=$('#'+k); if(!el) return; const v=it?.[k]; el.value=(v ?? (['qty','reorderAt','cost','price','packageCost','packageQty','unitsLoose'].includes(k)?0:'')); });
  $('#singleOnly').checked=!!it?.singleOnly; $('#measurable').checked=!!it?.measurable; $('#unitLabel').value=it?.unitLabel||'';
  const pq=$('#packageQty'); pq.disabled=$('#singleOnly').checked; if($('#singleOnly').checked) pq.value=1; $('#qty').step=$('#measurable').checked?'0.01':'1';
  const fs=$('#forSale'), ro=$('#restockOnly'); fs.checked=it? (it.forSale!==false&&!it.restockOnly) : true; ro.checked=!!it?.restockOnly; fs.onchange=()=>{ if(fs.checked) ro.checked=false; }; ro.onchange=()=>{ if(ro.checked) fs.checked=false; };
  $('#photoData').value=''; $('#photoUrl').value=''; setPreviewSrc(''); if(it?.photo){ if(/^data:image\//.test(it.photo)){ $('#photoData').value=it.photo; setPreviewSrc(it.photo);} else { $('#photoUrl').value=it.photo; setPreviewSrc(it.photo);} }
  showDialog($('#dlg')); updatePackHelper();
}
function upsertFromForm(){
  const id=$('#id').value||uid(), get=i=>document.getElementById(i).value, getC=i=>document.getElementById(i).checked;
  const item={
    id,
    name:get('name').trim(), sku:get('sku').trim(), category:get('category').trim(), supplier:get('supplier').trim(),
    qty:+get('qty')||0, reorderAt:+get('reorderAt')||0, cost:+get('cost')||0, price:+get('price')||0,
    packageCost:+get('packageCost')||0, packageQty:+get('packageQty')||0,
    unitsLoose:+get('unitsLoose')||0,
    singleOnly:getC('singleOnly'), measurable:getC('measurable'),
    unitLabel:get('unitLabel').trim(), forSale:!!getC('forSale'), restockOnly:!!getC('restockOnly'),
    notes:get('notes').trim(),
    components:get('components'),            /* NEW */
    photo:($('#photoData').value||$('#photoUrl').value||'').trim(),
    updated:nowISO()
  };
  if(!item.name) return alert('Name is required.');
  if(item.singleOnly) item.packageQty=1;
  if(item.restockOnly) item.forSale=false;

  // NEW: carry loose units into full packages when possible
  normalizeItemUnits(item);

  const ex=data.find(x=>x.id===id); ex?Object.assign(ex,item):data.unshift(item);
  saveAll(); fullRender(); hideDialog($('#dlg'));
}
function delItem(id){ const it=data.find(x=>x.id===id); const label=it?`${it.name} — ${it.sku||'no SKU'}`:'this item'; if(!confirm(`Delete ${label}?`)) return; data=data.filter(x=>x.id!==id); delete order[id]; delete po[id]; saveAll(); fullRender(); }
function adjQty(id,delta){ const it=data.find(x=>x.id===id); if(!it) return; it.qty=Math.max(0,(+it.qty||0)+(+delta||0)); it.updated=nowISO(); saveAll(); fullRender(); }
function editItem(id){ const it=data.find(x=>x.id===id); if(it){ openDialog(it); $('#id').value=it.id; } }
function uniqueNameCopy(n){ const base=String(n||'Untitled'), names=new Set(data.map(x=>String(x.name||''))); let cand=`${base} (copy)`,i=2; while(names.has(cand)) cand=`${base} (copy ${i++})`; return cand; }
function uniqueSkuCopy(s){ if(!s) return ''; const set=new Set(data.map(x=>String(x.sku||''))); let base=`${s}-COPY`,cand=base,i=2; while(set.has(cand)) cand=`${base}${i++}`; return cand; }
function duplicateItem(id){
  const o = data.find(x => x.id === id);
  if (!o) return;
  const c = Object.assign({}, o, {
    id: uid(),
    name: uniqueNameCopy(o.name || ''),
    sku: uniqueSkuCopy(o.sku || ''),
    qty: 0,
    unitsLoose: 0,
    updated: nowISO()
  });
  data.unshift(c);
  saveAll();
  fullRender();
}

/* Measurable units use */
function useUnits(id){
  const it=data.find(x=>x.id===id); if(!it) return;
  if(!it.measurable) return alert('This item is not marked as measurable.');

  const per = +it.packageQty || 0;
  if (!(per > 0)) return alert('Units per Package is 0.');

  const label = it.unitLabel || 'units';
  const availableUnits = Math.floor(((+it.qty||0) * per) + (+it.unitsLoose||0));
  const amt = +prompt(`Use how many ${label}? (available ≈ ${availableUnits} ${label})`, '0') || 0;
  if (!(amt > 0)) return;

  if (amt >= availableUnits){
    if(!confirm(`That will use all available ${label}. Set Quantity and Loose Units to 0?`)) return;
    it.qty = 0;
    it.unitsLoose = 0;
    it.updated = nowISO();
    saveAll(); fullRender();
    return;
  }

  // Consume loose units first
  let loose = +it.unitsLoose || 0;
  let leftToUse = amt;
  if (loose >= leftToUse){
    it.unitsLoose = loose - leftToUse;
    leftToUse = 0;
  } else {
    leftToUse -= loose;
    it.unitsLoose = 0;
  }

  // If still need more, open packages
  if (leftToUse > 0){
    const fullPkgs = Math.floor(leftToUse / per);
    const remUnits = leftToUse % per;

    // remove full packages
    it.qty = Math.max(0, (+it.qty||0) - fullPkgs);

    if (remUnits > 0){
      // open one additional package
      it.qty = Math.max(0, (+it.qty||0) - 1);
      // leftover from that opened package becomes new loose units
      it.unitsLoose = (per - remUnits);
    }
  }

  it.updated = nowISO();
  saveAll();
  fullRender();
}

/* ============ Assemblies / BOM (kitting) ============ */
/* Parse lines like:
   A-123:1
   B-456:2
   (also accepts "SKU x 2" or "SKU * 2") */
function parseBOM(str){
  const parts = String(str||'')
    .split(/\r?\n|;|,/)
    .map(s=>s.trim())
    .filter(Boolean);
  const out=[];
  for(const line of parts){
    const m = line.match(/^(.+?)[\s*:x×*]\s*(\d+(?:\.\d+)?)$/i);
    if(m){ out.push({ key:m[1].trim(), qty:+m[2] }); }
  }
  return out;
}
function findItemByKey(key){
  const k = String(key||'').trim().toLowerCase();
  if(!k) return null;
  return data.find(it => String(it.sku||'').trim().toLowerCase()===k)
      || data.find(it => String(it.name||'').trim().toLowerCase()===k);
}

/* Consume "units" from an item, respecting packageQty + unitsLoose.
   If packageQty=0, treat 1 unit == 1 qty (simple decrement). */
function consumeUnitsByUnits(it, units){
  const want = Math.max(0, Math.floor(+units||0));
  if (!want) return 0;

  const per = +it.packageQty || 0;

  // Simple: no unit granularity defined
  if (!(per > 0)){
    const had = +it.qty || 0;
    const use = Math.min(had, want);
    it.qty = had - use;
    it.updated = nowISO();
    return use;
  }

  // Unit-aware
  const totalUnits = Math.floor(((+it.qty||0) * per) + (+it.unitsLoose||0));
  const use = Math.min(totalUnits, want);
  let left = use;

  // use loose first
  const loose = +it.unitsLoose || 0;
  if (loose >= left){
    it.unitsLoose = loose - left;
    left = 0;
  } else {
    left -= loose;
    it.unitsLoose = 0;
  }

  if (left > 0){
    const pkgsToOpen = Math.ceil(left / per);
    it.qty = Math.max(0, (+it.qty||0) - pkgsToOpen);
    const rem = pkgsToOpen*per - left;
    it.unitsLoose = rem;
  }

  it.updated = nowISO();
  return use;
}

/* Apply a sale to finished items + linked components.
   map is { itemId: soldUnits } */
function applySaleFromMap(map){
  const warnings=[];
  for (const [id, soldUnits] of Object.entries(map)){
    const finished = data.find(x=>x.id===id); if(!finished) continue;
    const n = Math.max(0, +soldUnits||0); if(!n) continue;

    // 1) Deduct finished goods themselves
    const usedFinished = consumeUnitsByUnits(finished, n);
    if (usedFinished < n){
      warnings.push(`Short ${n-usedFinished} unit(s) of finished: ${finished.name||finished.sku}`);
    }

    // 2) Deduct components per BOM
    const bom = parseBOM(finished.components||'');
    for (const comp of bom){
      const compItem = findItemByKey(comp.key);
      if (!compItem){ warnings.push(`Missing component "${comp.key}"`); continue; }
      const need = Math.floor(n * (+comp.qty||0));
      if (!need) continue;
      const used = consumeUnitsByUnits(compItem, need);
      if (used < need){
        warnings.push(`Short ${need-used} unit(s) of ${compItem.name || compItem.sku}`);
      }
    }
  }
  saveAll(); fullRender();
  if (warnings.length) alert('Sale applied with warnings:\n' + warnings.join('\n'));
  else alert('Sale applied: stock deducted for finished items and components.');
}

/* Convenience: apply to current order and clear it */
function applySaleFromOrder(){
  if(!Object.keys(order).length) return alert('Your order is empty.');
  if(!confirm('Deduct inventory for this order (finished goods + components)?')) return;
  applySaleFromMap(order);
  clearOrder();
}

/* ============ Order Estimator ============ */
function addToOrder(id,qty=1){ const it=data.find(x=>x.id===id); if(!it) return; order[id]=(order[id]||0)+(+qty||0); order[id]=clamp(order[id],0,999999); saveAll(); renderOrderSearch(); }
function setOrderQty(id,qty){ order[id]=Math.max(0,+qty||0); if(order[id]===0) delete order[id]; saveAll(); renderOrderSearch(); }
function remFromOrder(id){ delete order[id]; saveAll(); renderOrderSearch(); }
function clearOrder(){ order={}; saveAll(); renderOrderSearch(); }
$('#btnClearOrder').addEventListener('click',clearOrder);
$('#btnInvFromOrder').addEventListener('click',makeInvoiceFromOrder);
$('#btnInvFromOrder2').addEventListener('click',makeInvoiceFromOrder);
/* NEW: kitting button */
document.getElementById('btnApplySale')?.addEventListener('click', applySaleFromOrder);

async function makeInvoiceFromOrder(){
  if(!Object.keys(order).length) return alert('Your order is empty.');
  // gather footer information; fallback to settings
  let footerNotes = $('#invFooterNotes')?.value.trim() || '';
  let footerImage = '';
  const imgInput = document.getElementById('invFooterImg');
  if (imgInput && imgInput.files && imgInput.files[0]) {
    try {
      footerImage = await fileToDataURL(imgInput.files[0], 800, 0.9);
    } catch (err) {
      console.warn('Could not process footer image', err);
    }
  }
  // use defaults from settings if nothing provided
  if (!footerNotes) footerNotes = settings.footerNotes || '';
  if (!footerImage) footerImage = settings.footerImage || '';
  const inv = buildInvoiceFromOrder({
    from: $('#invFrom').value.trim(),
    billTo: $('#invBillTo').value.trim(),
    taxRate: (+$('#invTax').value || settings.taxDefault || 0) / 100,
    discount: +($('#invDiscount').value || 0),
    discountPct: +($('#invDiscountPct').value || 0),
    shipping: +($('#invShipping').value || 0),
    shipTaxable: ($('#invShipTaxable').value === 'on'),
    mfrCoupon: +($('#invMfrCoupon').value || 0),
    notes: $('#invNotes').value.trim(),
    footerNotes: footerNotes,
    footerImage: footerImage
  });
  // mark the new invoice as unpaid by default
  inv.paid = false;
  invoices.push(inv);
  saveAll();
  // update tracker and stats after creating invoice
  if (typeof renderInvoiceTracker === 'function') renderInvoiceTracker();
  if (typeof renderStats === 'function') renderStats();
  openInvoiceWindow(inv);

  /* OPTIONAL: prompt to deduct inventory immediately after creating invoice */
  if (confirm('Deduct inventory now (finished goods + components)?')){
    applySaleFromMap(order);
    clearOrder();
  }
}
function renderOrderSearch(){
  const q=$('#orderSearch').value.trim().toLowerCase(), box=$('#orderList'); const picks=Object.keys(order).length;
  const list=(q? data.filter(it=>[it.name,it.sku,it.category].some(v=>String(v||'').toLowerCase().includes(q))) : []).slice(0,6);
  const rows=[];
  if(q){ rows.push(`<div class="muted" style="margin:4px 0 8px">Search results (${list.length}). Click “+” to add.</div>`); }
  else if(!picks){ rows.push(`<div class="muted">No items in order. Search above to add items.</div>`); }
  for (const it of list){
    const thumb = it.photo
      ? `<img class="photoThumb" src="${esc(it.photo)}" alt="">`
      : `<div class="photoThumb" style="background:#0001"></div>`;
    rows.push(`<div style="display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px;padding:6px 0">
      ${thumb}<div><strong>${esc(it.name)}</strong><br><span class="muted">${esc(it.sku||'')}</span></div>
      <button class="btn small accent" onclick="addToOrder('${it.id}',1)">+</button></div>`);
  }

  if(picks){
    rows.push('<hr style="border:0;border-top:1px solid var(--border);margin:8px 0 6px">');
    for(const [id,qty] of Object.entries(order)){
      const it=data.find(x=>x.id===id); if(!it) continue;
      rows.push(`<div style="display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:8px;padding:6px 0">
        <div><strong>${esc(it.name)}</strong> <span class="muted">(${esc(it.sku||'')})</span><br><span class="muted">${fmt(it.cost)} cost · ${fmt(it.price)} price</span></div>
        <input type="number" min="0" step="1" value="${qty}" style="width:120px" onchange="setOrderQty('${id}',this.value)">
        <button class="btn small" onclick="addToOrder('${id}',1)">+1</button>
        <button class="btn small danger" onclick="remFromOrder('${id}')">Remove</button></div>`);
    }
  }
  box.innerHTML=rows.join('');
  let items=0,cost=0,rev=0; for(const [id,qy] of Object.entries(order)){ const it=data.find(x=>x.id===id); if(!it) continue; const n=+qy||0; items+=n; cost+=n*(+it.cost||0); rev+=n*(+it.price||0); }
  $('#tItems').textContent=items; $('#tCost').textContent=fmt(cost); $('#tRev').textContent=fmt(rev); $('#tProfit').textContent=fmt(rev-cost);
}
$('#orderSearch').addEventListener('input',renderOrderSearch);

/* ============ Purchase Order (package-based) ============ */
const ensurePOTotalsContainer=()=>{ const parent=$('#poList')?.parentElement; if(!parent||$('#poTotals')) return;
  parent.insertAdjacentHTML('beforeend',`<hr style="border:0;border-top:1px solid var(--border);margin:10px 0 0"><div id="poTotals" style="display:grid;grid-template-columns:1fr auto;gap:6px;margin-top:8px">
    <div>Lines</div><div class="right" id="poLines">0</div><div>Units</div><div class="right" id="poUnits">0</div><div><strong>Estimated PO Cost</strong></div><div class="right" id="poCost"><strong>$0.00</strong></div></div>`); };
const calcPOTotals=()=>{ let lines=0,units=0,cost=0; for(const [id,qty] of Object.entries(po)){ const it=data.find(x=>x.id===id); if(!it) continue; const n=+qty||0; if(n>0){ lines++; units+=n; const pq=+it.packageQty||0, pc=+it.packageCost||0; if(pq>0&&pc>0){ const pkgs=Math.ceil(n/pq); cost+=pkgs*pc; } } } return {lines,units,cost}; };
function updatePOTotalsUI(){ const {lines,units,cost}=calcPOTotals(); if(!$('#poTotals')) return; $('#poLines').textContent=lines; $('#poUnits').textContent=units; $('#poCost').textContent=fmt(cost); }
function suggestedQty(it){
  const q=+it.qty||0, ro=+it.reorderAt||0;
  if(q===0 && ro===0) return 1;
  if(ro<=0) return 0;
  return Math.max(1, ro*2 - q);
}
const reorderItems=()=>data.filter(it=>{
  const q=+it.qty||0, ro=+it.reorderAt||0;
  return (ro>0 && q<=ro) || q===0;
});
function renderReorder(){
  const box=$('#reorderList'); const items=reorderItems(); if(!items.length) return box.innerHTML='<div class="muted">Nothing to reorder right now.</div>';
  box.innerHTML=items.map(it=>`<div style="display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:8px;padding:6px 0">
    <div><strong>${esc(it.name)}</strong> <span class="muted">(${esc(it.sku||'')})</span><br><span class="muted">Supplier: ${esc(it.supplier||'-')} · In stock: ${it.qty} · Reorder @ ${it.reorderAt||0}</span></div>
    <input type="number" min="0" step="1" value="${Math.max(suggestedQty(it),1)}" style="width:120px" oninput="this.dataset.v=this.value">
    <button class="btn small accent" onclick="addToPO('${it.id}',+(this.previousElementSibling.dataset.v||this.previousElementSibling.value||0))">Add to PO</button>
    <button class="btn small" onclick="addToPO('${it.id}',1)">+1</button></div>`).join('');
}
function addToPO(id,qty=1){ if(qty<=0) return; po[id]=(po[id]||0)+(+qty||0); po[id]=clamp(po[id],0,999999); saveAll(); renderPO(); }
function setPOQty(id,qty){ po[id]=Math.max(0,+qty||0); if(po[id]===0) delete po[id]; saveAll(); renderPO(); }
function remFromPO(id){ delete po[id]; saveAll(); renderPO(); }
function clearPO(){ po={}; saveAll(); renderPO(); }
$('#btnClearPO').addEventListener('click',clearPO);
$('#btnAddAllSuggest').addEventListener('click',()=>{ const items=reorderItems(); if(!items.length) return alert('No suggestions.'); for(const it of items){ const q=Math.max(suggestedQty(it),1); po[it.id]=(po[it.id]||0)+q; } saveAll(); renderPO(); });
function renderPO(){
  const box=$('#poList'); if(!Object.keys(po).length){ box.innerHTML='<div class="muted">PO is empty.</div>'; const t=$('#poTotals'); if(t) t.style.display='none'; return; }
  const rows=[]; for(const [id,qty] of Object.entries(po)){ const it=data.find(x=>x.id===id); if(!it) continue; const n=+qty||0, pq=+it.packageQty||0, pc=+it.packageCost||0; const pkgs=(pq>0)?Math.ceil(n/pq):0; const line=(pq>0&&pc>0)?pkgs*pc:0;
    rows.push(`<div style="display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:8px;padding:6px 0">
      <div><strong>${esc(it.name)}</strong> <span class="muted">(${esc(it.sku||'')})</span><br><span class="muted">Supplier: ${esc(it.supplier||'-')} · Pkg: ${fmt(pc)} for ${pq||'?'} · Est line: ${fmt(line)}${pkgs?` · ${pkgs} pkg${pkgs>1?'s':''}`:''}</span></div>
      <input type="number" min="0" step="1" value="${n}" style="width:90px" oninput="setPOQty('${id}',this.value)">
      <button class="btn small danger" onclick="remFromPO('${id}')">Remove</button></div>`);
  }
  box.innerHTML=rows.join(''); ensurePOTotalsContainer(); $('#poTotals').style.display=''; updatePOTotalsUI();
}
$('#btnPrintPO').addEventListener('click',()=>{ if(!Object.keys(po).length) return alert('PO is empty.'); openPOWindow(); });

/* Group helpers + PO/Invoice windows */
function groupBySupplier(entries){ const out={}; for(const [id,qty] of entries){ const it=data.find(x=>x.id===id); if(!it) continue; const s=it.supplier||'Unspecified'; (out[s]||(out[s]=[])).push({it,qty}); } return out; }
function openPOWindow(){ const w=window.open('','_blank','width=920,height=900'); if(!w) return alert('Popup blocked.'); const today=new Date(), ymd=today.toISOString().slice(0,10), poNumber=`PO-${ymd.replace(/-/g,'')}-${Math.random().toString(36).slice(2,7).toUpperCase()}`;
  const grouped=groupBySupplier(Object.entries(po)); const css=`body{font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111;padding:24px;background:#fff} h1,h2,h3{margin:0 0 8px}.row{display:flex;gap:24px;align-items:flex-start;margin-bottom:12px}.col{flex:1} table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border:1px solid #ddd;padding:8px;text-align:left} th{background:#f3f6fa}.right{text-align:right}.muted{color:#666}.section{margin:18px 0}.printbar{position:sticky;top:0;background:#fff;padding-bottom:8px;margin-bottom:8px}.btn{border:1px solid #ccc;padding:6px 10px;border-radius:6px;background:#fafafa;cursor:pointer}.logo{height:48px;object-fit:contain}@media print {.printbar{display:none}}`;
  let sections='', grandLines=0,grandUnits=0,grandCost=0;
  for(const [supplier,lines] of Object.entries(grouped)){ let subUnits=0,subCost=0, i=0, rows='';
    for(const {it,qty} of lines){ const n=+qty||0, pq=+it.packageQty||0, pc=+it.packageCost||0, pkgs=(pq>0)?Math.ceil(n/pq):0, line=(pq>0&&pc>0)?pkgs*pc:0; subUnits+=n; subCost+=line;
      rows+=`<tr><td><input type="checkbox"></td><td>${++i}</td><td>${esc(it.name)}</td><td>${esc(it.sku||'')}</td><td class="right">${n}</td><td class="right">${fmt(pc)}</td><td class="right">${fmt(line)}</td></tr>`; }
    grandLines+=lines.length; grandUnits+=subUnits; grandCost+=subCost;
    sections+=`<div class="section"><h3>Supplier: ${esc(supplier)}</h3><table><thead><tr><th>Ordered</th><th>#</th><th>Item</th><th>SKU</th><th class="right">Qty</th><th class="right">Package Cost</th><th class="right">Line Total</th></tr></thead><tbody>${rows||'<tr><td colspan="7" class="muted">No lines.</td></tr>'}</tbody></table><div class="right" style="margin-top:6px"><strong>Supplier Subtotal:</strong> ${subUnits} units · ${fmt(subCost)}</div></div>`;
  }
  const logoTag=settings.logo?`<img class="logo" src="${settings.logo}" alt="Logo">`:''; const summary=`<div class="section"><h3>Summary</h3><table><tbody><tr><td>Suppliers</td><td class="right">${Object.keys(grouped).length}</td></tr><tr><td>Total Lines</td><td class="right">${grandLines}</td></tr><tr><td>Total Units</td><td class="right">${grandUnits}</td></tr><tr><td><strong>Estimated PO Cost</strong></td><td class="right"><strong>${fmt(grandCost)}</strong></td></tr></tbody></table></div>`;
  const html=`<html><head><meta charset="utf-8"><title>${poNumber}</title><style>${css}</style></head><body><div class="printbar"><button class="btn" onclick="window.print()">Print / Save as PDF</button></div><div class="row"><div class="col" style="display:flex;align-items:center;gap:12px">${logoTag}<div><h1>Purchase Order</h1><div class="muted">${poNumber}</div></div></div><div class="col" style="text-align:right"><div><strong>Date:</strong> ${today.toLocaleString()}</div></div></div>${sections||'<p class="muted">No lines.</p>'}${summary}</body></html>`;
  const doc=w.document; doc.open(); doc.write(html); doc.close(); try{ w.document.title=`${poNumber}.pdf`; }catch{} }

/* ============ Damaged & Loss ============ */
function populateDamSelect(){ const sel=$('#damItem'); if(!sel) return; const current=sel.value; const sorted=[...data].sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''))); sel.innerHTML=sorted.map(d=>`<option value="${d.id}">${esc(d.name)} — ${esc(d.sku||'')}</option>`).join(''); if(current) sel.value=current; }
function addDamaged(){
  const id=$('#damItem').value, qtyWanted=Math.max(1,+$('#damQty').value||1), note=$('#damNote').value.trim(), it=data.find(x=>x.id===id); if(!it) return alert('Item not found.');
  const avail=+it.qty||0; let qty=qtyWanted; if(qty>avail){ if(!confirm(`You only have ${avail} in stock. Log ${qtyWanted} damaged anyway?`)) return; qty=avail; } it.qty=Math.max(0,avail-qty); it.updated=nowISO();
  damaged.unshift({id:uid(),itemId:it.id,name:it.name,sku:it.sku||'',qty:+qty,costPer:+it.cost||0,loss:(+qty)*(+it.cost||0),note,ts:nowISO()});
  saveAll(); fullRender(); $('#damQty').value=1; $('#damNote').value='';
}
function renderDamaged(){
  const tb=$('#damRows'); tb.innerHTML=''; let total=0;
  for(const r of damaged){ total+=+r.loss||0; tb.insertAdjacentHTML('beforeend',`<tr><td>${new Date(r.ts).toLocaleString()}</td><td><strong>${esc(r.name)}</strong><br><span class="muted">${esc(r.sku)}</span></td><td class="right">${r.qty}</td><td class="right">${fmt(r.costPer)}</td><td class="right">${fmt(r.loss)}</td><td>${esc(r.note||'')}</td><td><button class="btn small" onclick="restoreDamaged('${r.id}')">Restore</button> <button class="btn small danger" onclick="delDamaged('${r.id}')">Delete</button></td></tr>`); }
  $('#damTotal').textContent=fmt(total);
}
function delDamaged(did){ const row=damaged.find(x=>x.id===did); if(!row) return; if(!confirm('Delete this damaged log entry? (Stock will NOT be restored)')) return; damaged=damaged.filter(x=>x.id!==did); saveAll(); renderDamaged(); }
function restoreDamaged(did){ const row=damaged.find(x=>x.id===did); if(!row) return; const it=data.find(x=>x.id===row.itemId); if(!it) return alert('Original item not found.'); if(!confirm(`Restore ${row.qty} back into stock for ${it.name}?`)) return; it.qty=(+it.qty||0)+(+row.qty||0); it.updated=nowISO(); damaged=damaged.filter(x=>x.id!==did); saveAll(); fullRender(); }
$('#btnDamAdd').addEventListener('click',addDamaged);
$('#btnDamExport').addEventListener('click',()=>{ const headers=['date','name','sku','qty','costPer','loss','note','itemId','id'], lines=[headers.join(',')]; for(const r of damaged){ const vals=[r.ts,r.name,r.sku,r.qty,r.costPer,r.loss,r.note||'',r.itemId,r.id].map(v=>{let s=String(v??''); if(s.includes('"')) s=s.replace(/\"/g,'""'); if(/[",\n]/.test(s)) s=`"${s}"`; return s;}); lines.push(vals.join(',')); } const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='damaged.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); });
$('#btnDamClear').addEventListener('click',()=>{ if(!damaged.length) return alert('No entries.'); if(!confirm('Clear ALL damaged entries? This cannot be undone.')) return; damaged=[]; saveAll(); renderDamaged(); });

/* ============ Invoice (with % discount + blank + view last) ============ */
function buildInvoiceFromOrder(opts){
const items = [];
for (const [id,q] of Object.entries(order)){
const it = data.find(x=>x.id===id);
if(!it) continue;
const qty = +q || 0;
const price = +it.price || 0;
items.push({ name: it.name, sku: it.sku||'', qty, price, total: qty*price });
}
return buildInvoice(Object.assign({}, opts, { items }));
}
function buildInvoice({
    from,
    billTo,
    items,
    taxRate = 0, // e.g., 0.07 for 7%
    discount = 0, // seller $ discount (pre‑tax)
    discountPct = 0, // seller % discount (pre‑tax, 0–100)
    shipping = 0, // shipping $
    shipTaxable = true, // include shipping in tax base?
    mfrCoupon = 0, // manufacturer/3rd‑party coupon $ (post‑tax)
    notes = '',
    footerNotes = '', // custom footer notes
    footerImage = '' // DataURL for footer image
  }){
// Normalize
taxRate = +taxRate || 0;
discount = Math.max(0, +discount || 0);
discountPct = Math.max(0, +discountPct || 0);
shipping = Math.max(0, +shipping || 0);
mfrCoupon = Math.max(0, +mfrCoupon || 0);
shipTaxable = !!shipTaxable;
const round2 = n => Math.round((n + Number.EPSILON) * 100) / 100;

const prefix = settings.invPrefix || 'INV-';
const number = prefix + new Date().toISOString().slice(0,10).replace(/-/g,'')
+ '-' + Math.random().toString(36).slice(2,7).toUpperCase();


// 1) Price (items subtotal)
const subtotal = (items||[]).reduce((s,it)=>{
const qty = +it.qty || 0;
const price = +it.price || 0;
return s + (it.total ?? qty*price);
}, 0);


// 2) minus seller discounts (fixed + %), capped at subtotal
const sellerPctAmt = round2(subtotal * (discountPct/100));
const sellerFixedAmt = round2(Math.min(discount, Math.max(0, subtotal - sellerPctAmt)));
const sellerDiscTot = round2(Math.min(subtotal, sellerPctAmt + sellerFixedAmt));
const afterSeller = round2(Math.max(0, subtotal - sellerDiscTot));


// 3) plus taxable shipping (if applicable)
const taxBase = round2(afterSeller + (shipTaxable ? shipping : 0));


// 4) compute tax % on that amount
const tax = round2(taxBase * taxRate);


// 5) subtract manufacturer coupons (post‑tax)
// 6) Total (if shipping NOT taxable, add after tax)
const total = round2(Math.max(0,
taxBase // after seller disc + (taxable) shipping
+ tax
+ (shipTaxable ? 0 : shipping)
- mfrCoupon
));


return {
    id: uid(),
    number,
    date: new Date().toLocaleString(),
    from: from||'',
    billTo: billTo||'',
    items: items||[],
    notes,
    footerNotes,
    footerImage,
    // invoices start unpaid; status toggled in Invoice Tracker
    paid: false,


// For display
subtotal,
sellerDiscountPct: discountPct,
sellerDiscountPctAmt: sellerPctAmt,
sellerDiscountFixed: sellerFixedAmt,
sellerDiscountTotal: sellerDiscTot,


shipping,
shipTaxable,


taxRate,
taxBase,
tax,


mfrCoupon,
total
    ,
    // custom footer fields
    footerNotes,
    footerImage
};
}

/* NEW: Blank invoice + View last invoice */
$('#btnMakeBlankInv').addEventListener('click', async () => {
  // gather footer information
  const footerNotes = $('#invFooterNotes')?.value.trim() || '';
  let footerImage = '';
  const imgInput = document.getElementById('invFooterImg');
  if (imgInput && imgInput.files && imgInput.files[0]) {
    try {
      footerImage = await fileToDataURL(imgInput.files[0], 800, 0.9);
    } catch (err) {
      console.warn('Could not process footer image', err);
    }
  }
  const inv = buildInvoice({
    from: $('#invFrom').value.trim(),
    billTo: $('#invBillTo').value.trim(),
    items: [],
    taxRate: (+$('#invTax').value || settings.taxDefault || 0) / 100,
    discount: +($('#invDiscount').value || 0),
    discountPct: +($('#invDiscountPct').value || 0),
    shipping: +($('#invShipping').value || 0),
    shipTaxable: ($('#invShipTaxable').value === 'on'),
    mfrCoupon: +($('#invMfrCoupon').value || 0),
    notes: $('#invNotes').value.trim(),
    footerNotes: footerNotes,
    footerImage: footerImage
  });
  // mark the blank invoice as unpaid by default
  inv.paid = false;
  invoices.push(inv);
  saveAll();
  if (typeof renderInvoiceTracker === 'function') renderInvoiceTracker();
  if (typeof renderStats === 'function') renderStats();
  openInvoiceWindow(inv);
});
$('#btnViewLastInv').addEventListener('click',()=>{
  if(!invoices.length) return alert('No invoices yet.');
  const inv = invoices[invoices.length-1];
  openInvoiceWindow(inv);
});
function openInvoiceWindow(inv){
  const cur = settings?.currency || 'USD';
  const fmt2 = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:cur,maximumFractionDigits:2});
  const pct = n => (Number(n||0)).toFixed(2) + '%';

  const logoTag = settings.logo ? `<img class="logo" src="${settings.logo}" alt="Logo">` : '';
  const itemsRows = (inv.items && inv.items.length)
    ? inv.items.map((it,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${esc(it.name||'')}</td>
          <td>${esc(it.sku||'')}</td>
          <td class="right">${it.qty||0}</td>
          <td class="right">${fmt2(it.price||0)}</td>
          <td class="right">${fmt2((it.total!=null?it.total:(it.qty||0)*(it.price||0))||0)}</td>
        </tr>`).join('')
    : `<tr><td colspan="6" class="muted">No items.</td></tr>`;

  const shipTaxableNote = inv.shipTaxable ? 'Yes' : 'No';
  const taxRatePct = pct((inv.taxRate||0)*100);

  const css = `
    body{font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#111;background:#fff;padding:24px}
    h1,h2,h3{margin:0 0 8px}
    .row{display:flex;gap:24px;align-items:flex-start;margin-bottom:12px}
    .col{flex:1}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f3f6fa}
    .right{text-align:right}
    .muted{color:#666}
    .printbar{position:sticky;top:0;background:#fff;padding-bottom:8px;margin-bottom:8px}
    .btn{border:1px solid #ccc;padding:6px 10px;border-radius:6px;background:#fafafa;cursor:pointer}
    .logo{height:48px;object-fit:contain}
    @media print {.printbar{display:none}}
  `;

  const totals = `
    <table>
      <tbody>
        <tr><td>Subtotal (items)</td><td class="right">${fmt2(inv.subtotal)}</td></tr>
        ${
          (inv.sellerDiscountTotal||0) > 0
          ? `<tr><td>Seller Discount (${pct(inv.sellerDiscountPct||0)} + ${fmt2(inv.sellerDiscountFixed||0)})</td><td class="right">-${fmt2(inv.sellerDiscountTotal||0)}</td></tr>`
          : ''
        }
        <tr><td>Shipping</td><td class="right">${fmt2(inv.shipping||0)} <span class="muted">(${shipTaxableNote})</span></td></tr>
        <tr><td class="muted">Tax Base (after seller discount${inv.shipTaxable? ' + shipping' : ''})</td><td class="right muted">${fmt2(inv.taxBase||0)}</td></tr>
        <tr><td>Tax (${taxRatePct})</td><td class="right">${fmt2(inv.tax||0)}</td></tr>
        ${
          (inv.mfrCoupon||0) > 0
          ? `<tr><td>Manufacturer Coupon</td><td class="right">-${fmt2(inv.mfrCoupon||0)}</td></tr>`
          : ''
        }
        <tr><td><strong>Total</strong></td><td class="right"><strong>${fmt2(inv.total||0)}</strong></td></tr>
      </tbody>
    </table>
  `;

  const hdrRight = `
    <div class="col" style="text-align:right">
      <div><strong>Invoice #:</strong> ${esc(inv.number||'')}</div>
      <div><strong>Date:</strong> ${esc(inv.date||new Date().toLocaleString())}</div>
    </div>
  `;

  const parties = `
    <div class="row">
      <div class="col">
        <h3>From</h3>
        <pre style="white-space:pre-wrap;margin:0">${esc(inv.from||'')}</pre>
      </div>
      <div class="col">
        <h3>Bill To</h3>
        <pre style="white-space:pre-wrap;margin:0">${esc(inv.billTo||'')}</pre>
      </div>
    </div>
  `;

  const itemsTbl = `
    <h3>Line Items</h3>
    <table>
      <thead><tr>
        <th>#</th><th>Item</th><th>SKU</th>
        <th class="right">Qty</th><th class="right">Price</th><th class="right">Line Total</th>
      </tr></thead>
      <tbody>${itemsRows}</tbody>
    </table>
  `;

  const notes = inv.notes ? `
    <div style="margin-top:10px">
      <h3>Notes</h3>
      <div class="muted" style="white-space:pre-wrap">${esc(inv.notes)}</div>
    </div>` : '';
  const footer = (inv.footerNotes || inv.footerImage) ? `
    <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px">
      ${inv.footerImage ? `<div style="text-align:center;margin-bottom:6px;"><img src="${inv.footerImage}" style="max-width:200px; max-height:100px;"></div>` : ''}
      ${inv.footerNotes ? `<div class="muted" style="white-space:pre-wrap">${esc(inv.footerNotes)}</div>` : ''}
    </div>` : '';

  const w = window.open('','_blank','width=980,height=900');
  if(!w) return alert('Popup blocked.');
  const html = `
    <html>
      <head>
        <meta charset="utf-8">
        <title>${esc(inv.number||'Invoice')}</title>
        <style>${css}</style>
      </head>
      <body>
        <div class="printbar">
          <button class="btn" onclick="window.print()">Print / Save as PDF</button>
        </div>

        <div class="row">
          <div class="col" style="display:flex;align-items:center;gap:12px">
            ${logoTag}
            <div>
              <h1>Invoice</h1>
              <div class="muted">${esc(inv.number||'')}</div>
            </div>
          </div>
          ${hdrRight}
        </div>

        ${parties}
        ${itemsTbl}

        <div style="margin-top:14px">
          <h3>Totals</h3>
          ${totals}
        </div>

        ${notes}
        ${footer}
      </body>
    </html>
  `;
  w.document.open();
  w.document.write(html);
  w.document.close();
}


/* Dashboard (for MoM coloring only) */
function ymKey(d=new Date()){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`; }
function computeMetrics(){
  let invCost = 0, saleRev = 0, saleCost = 0;
  for (const it of data){
    const units = totalUnits(it);
    const c = +it.cost || 0, p = +it.price || 0;
    invCost += units * c;
    const sale = (it?.forSale !== false && !it?.restockOnly);
    if (sale){ saleRev += units * p; saleCost += units * c; }
  }
  const saleProfit = saleRev - saleCost;
  const saleMargin = saleRev > 0 ? (saleProfit / saleRev) : 0;
  return { invCost, saleProfit, saleMargin };
}
let snapsInitOnce=false;
function ensureMonthSnapshot(){ if(snapsInitOnce) return; try{ const cur=ymKey(); if(!Array.isArray(snaps)) snaps=[]; if(!snaps.some(s=>s.month===cur)){ const m=computeMetrics(); snaps.push({month:cur,invCost:m.invCost,saleProfit:m.saleProfit,ts:nowISO()}); LS.set('inv.snaps',snaps); } snapsInitOnce=true; }catch{} }
function renderDashboard(){ const m=computeMetrics(); const momEl=document.getElementById('dashMoM'); try{ const prevKey=ymKey(new Date(new Date().getFullYear(), new Date().getMonth()-1,1)); const snap=(Array.isArray(snaps)?snaps:[]).find(s=>s.month===prevKey); if(momEl){ if(snap){ const delta=m.invCost-Number(snap.invCost||0); momEl.textContent=`${delta>0?'+':''}${fmt(delta)}`; momEl.style.color=delta>=0?'var(--accent)':'var(--danger)'; } else { momEl.textContent='No snapshot'; momEl.style.color='var(--muted)'; } } }catch{ if(momEl) momEl.textContent='—'; } }

/* ====== Import button wiring (friendlier Excel alert) ====== */
$('#btnExport').addEventListener('click',downloadCSV);
$('#btnExportXLSX').addEventListener('click',downloadXLSX);
$('#btnImport').addEventListener('click',()=>$('#importFile').click());

document.getElementById('importFile')?.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  try {
    // Excel path
    if (/\.(xlsx|xls)$/i.test(file.name)) {
      const ok = await ensureXLSXReady();
      if (!ok) {
        alert('Could not load Excel parser. You can:\n• Place xlsx.full.min.js next to this HTML (or in ./lib/),\n• OR allow CDN (temporary),\n• OR save the sheet as CSV and re-import.');
        e.target.value = '';
        return;
      }

      const buf   = await file.arrayBuffer();
      const wb    = XLSX.read(buf, { type: 'array' });
      const name  = wb.SheetNames && wb.SheetNames[0];
      if (!name) throw new Error('No worksheet found.');
      const sheet = wb.Sheets[name];
      let rows    = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false });

      // Filter out empty lines
      rows = rows.filter(r => Array.isArray(r) && r.some(c => String(c ?? '').trim().length));

      // Validate and warn on header issues (continues import)
      rows = validateAndCleanRows(rows);

      importRowsAOA(rows);
    }
    // CSV path
    else {
      const text = await file.text();
      let rows = parseCSV(String(text || ''))
        .filter(r => Array.isArray(r) && r.some(c => String(c ?? '').trim().length));
      rows = validateAndCleanRows(rows);
      importRowsAOA(rows);
    }
  } catch (err) {
    console.error(err);
    alert(
      'Could not import that file.\n\n' +
      (err?.message || '') +
      '\n\nMake sure the first row has these headers:\n' + headers.join(',')
    );
  } finally {
    e.target.value = ''; // allow re-selecting the same file
  }
});

/* Search, dialog & save hooks */
$('#search').addEventListener('input',render);
$('#btnAdd').addEventListener('click',()=>openDialog());
$('#btnCancel').addEventListener('click',()=>{
  // Close the item dialog using helper; confirm discard if dirty
  if(dirty && !confirm('Discard changes?')) return;
  hideDialog($('#dlg'));
});
$('#btnSave').addEventListener('click',upsertFromForm);

/* Mark dialog edits as "dirty" so unload/cancel warns appropriately */
$('#dlg')?.addEventListener('input', markDirty);
$('#dlg')?.addEventListener('change', markDirty);

/* Init */
function fullRender(){
  render();
  renderDamaged();
  renderOrderSearch();
  renderReorder();
  renderPO();
  renderStats();
  ensureMonthSnapshot();
  renderDashboard();
  populateDamSelect();
  if (typeof renderInvoiceTracker === 'function') renderInvoiceTracker();
  // Also render employees, schedules and taxes when doing a full render
  try {
    if (typeof loadEmployees === 'function') loadEmployees();
    if (typeof loadEmployeeSchedules === 'function') loadEmployeeSchedules();
    if (typeof loadPayPeriod === 'function') loadPayPeriod();
    if (typeof renderEmployees === 'function') renderEmployees();
    if (typeof renderEmployeeSchedules === 'function') renderEmployeeSchedules();
    if (typeof renderTaxes === 'function') renderTaxes();
    // Load and render payroll and deductions, update pay tracker
    if (typeof loadPayrollPeriods === 'function') loadPayrollPeriods();
    if (typeof loadDeductions === 'function') loadDeductions();
    if (typeof renderPayroll === 'function') renderPayroll();
    if (typeof renderDeductions === 'function') renderDeductions();
    if (typeof updatePayTracker === 'function') updatePayTracker();
    // Load and render rentals and subscriptions
    if (typeof loadRentals === 'function') loadRentals();
    if (typeof loadSubscriptions === 'function') loadSubscriptions();
    if (typeof renderRentals === 'function') renderRentals();
    if (typeof renderSubscriptions === 'function') renderSubscriptions();
  } catch {}
}
if(!Array.isArray(data)) data=[];
if(!$('#invTax').value) $('#invTax').value=settings.taxDefault||0;
refreshBackupBanner(); fullRender();

/* Keyboard shortcuts: Save & Export */
document.addEventListener('keydown', (e)=>{
  const key = e.key?.toLowerCase?.() || '';
  const isInput = /^(input|textarea|select)$/i.test(e.target?.tagName || '');
  if ((e.ctrlKey || e.metaKey) && key==='s' && !e.shiftKey){
    e.preventDefault();
    quickSave();
  }
  if ((e.ctrlKey || e.metaKey) && key==='s' && e.shiftKey){
    e.preventDefault();
    downloadCSV();
  }
});

/* Unload guard */
window.addEventListener('beforeunload',e=>{ if(dirty){ e.preventDefault(); e.returnValue=''; } });



/* ======== KITS SYSTEM ======== */
let kits = LS.get("inv.kits", []);

/* Save or Update Kit (quick form adds starter kit with first few items) */
function saveKit() {
  const id = $("#kitId").value || uid();
  const name = $("#kitName").value.trim();
  const sku = $("#kitSku").value.trim();
  if (!name) return alert("Kit name required.");

  const allIds = data.map(d => d.id);
  if (!allIds.length) return alert("No items in inventory to make kits.");

  const compCount = Math.min(5, allIds.length);
  const comp = allIds.slice(0, compCount).map(id => ({ id, qty: 1 }));

  // Auto-calc cost
  let totalCost = 0;
  comp.forEach(c => {
    const it = data.find(d => d.id === c.id);
    if (it) totalCost += (+it.cost || 0) * c.qty;
  });

  const existing = kits.find(k => k.id === id);
  if (existing) {
    existing.name = name;
    existing.sku = sku;
    existing.components = comp;
    existing.cost = totalCost;
  } else {
    kits.push({ id, name, sku, components: comp, photo: "", cost: totalCost });
  }

  saveAll();
  renderKits();

  $("#kitName").value = "";
  $("#kitSku").value = "";
  $("#kitId").value = "";
}

/* Render Kits with Edit */
function renderKits() {
  const box = $("#kitList");
  if (!kits.length) {
    box.innerHTML = "<div class='muted'>No kits defined yet.</div>";
    return;
  }
  box.innerHTML = kits.map(k => {
    const comps = k.components.map(c => {
      const it = data.find(d => d.id === c.id);
      return it ? `${esc(it.name)} x${c.qty}` : "Missing item";
    }).join(", ");
    const photo = k.photo ? `<img src="${esc(k.photo)}" class="photoThumb" style="margin-right:6px;vertical-align:middle">` : "";
    return `<div style="margin:6px 0; padding:6px; border:1px solid var(--border); border-radius:8px">
      ${photo}<strong>${esc(k.name)}</strong> (${esc(k.sku||"")})<br>
      <span class="muted">${comps}</span><br>
      <button class="btn small" onclick="editKit('${k.id}')">Edit</button>
      <button class="btn small accent" onclick="craftKit('${k.id}')">Craft</button>
      <button class="btn small" onclick="addKitToOrder('${k.id}')">Add to Order</button>
      <button class="btn small danger" onclick="delKit('${k.id}')">Delete</button>
    </div>`;
  }).join("");
}

/* Edit Kit */
function editKit(id) {
  const k = kits.find(x => x.id === id);
  if (!k) return;

  $("#kitEditId").value = k.id;
  $("#kitEditName").value = k.name;
  $("#kitEditSku").value = k.sku;
  $("#kitEditPhoto").value = k.photo || "";
  if (k.photo) {
  $("#kitPhotoPreview").src = k.photo;
  $("#kitPhotoPreview").style.display = "";
} else {
  $("#kitPhotoPreview").style.display = "none";
}


  const box = $("#kitEditComponents");
  box.innerHTML = data.map(it => {
    const comp = k.components.find(c => c.id === it.id);
    const qty = comp ? comp.qty : 1;
    return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
      <input type="checkbox" data-id="${it.id}" ${comp ? "checked" : ""}>
      <label style="flex:1">${esc(it.name)} (${esc(it.sku||"")})</label>
      <input type="number" min="1" step="1" value="${qty}" style="width:60px" ${comp ? "" : "disabled"}>
    </div>`;
  }).join("");

  box.querySelectorAll("input[type=checkbox]").forEach(chk => {
    chk.addEventListener("change", e => {
      const num = e.target.parentElement.querySelector("input[type=number]");
      if (num) num.disabled = !e.target.checked;
    });
  });

  // Use helper to show dialog (cross-browser)
  showDialog($("#dlgKit"));
}

/* Save Kit from Editor */
function saveKitFromEditor() {
  const id = $("#kitEditId").value || uid();
  const name = $("#kitEditName").value.trim();
  const sku = $("#kitEditSku").value.trim();
  const photo = $("#kitEditPhoto").value.trim();
  if (!name) return alert("Kit name required.");

  const comps = [];
  $("#kitEditComponents").querySelectorAll("div").forEach(row => {
    const chk = row.querySelector("input[type=checkbox]");
    const num = row.querySelector("input[type=number]");
    if (chk.checked) {
      comps.push({ id: chk.dataset.id, qty: Math.max(1, +num.value||1) });
    }
  });
  if (!comps.length) return alert("Select at least one component.");

  let totalCost = 0;
  comps.forEach(c => {
    const it = data.find(d => d.id === c.id);
    if (it) totalCost += (+it.cost || 0) * c.qty;
  });

  const existing = kits.find(k => k.id === id);
  if (existing) {
    existing.name = name;
    existing.sku = sku;
    existing.photo = photo;
    existing.components = comps;
    existing.cost = totalCost;
  } else {
    kits.push({ id, name, sku, photo, components: comps, cost: totalCost });
  }

  saveAll();
  renderKits();
  // Close the Kit dialog
  hideDialog($("#dlgKit"));
}

/* Cancel */
$("#btnKitCancel").addEventListener("click", () => hideDialog($("#dlgKit")));
$("#btnKitSave").addEventListener("click", saveKitFromEditor);


/* Craft Kit */
function craftKit(kitId) {
  const kit = kits.find(k => k.id === kitId);
  if (!kit) return;

  // Check component stock first
  for (const c of kit.components) {
    const it = data.find(d => d.id === c.id);
    if (!it) return alert("Missing component: " + c.id);
    const totalUnits = Math.floor(((+it.qty||0) * (+it.packageQty||0)) + (+it.unitsLoose||0));
    if (totalUnits < c.qty) {
      return alert("Not enough stock for " + (it.name || it.sku));
    }
  }

  // Deduct stock
  for (const c of kit.components) {
    const it = data.find(d => d.id === c.id);
    const used = consumeUnitsByUnits(it, c.qty);
    if (used < c.qty) {
      return alert("Warning: shortage for " + (it.name || it.sku));
    }
  }

  // Ask user if they want to add crafted kit into inventory
  if (!confirm(`Components consumed. Do you want to add "${kit.name}" as an inventory item?`)) {
    saveAll();
    render();
    renderKits();
    return;
  }

  // Calculate cost and suggested price
  const cost = kit.cost || 0;
  const markupPct = settings.kitMarkup ?? 50;
  const suggestedPrice = +(cost * (1 + markupPct/100)).toFixed(2);

  // Either update or insert crafted kit into inventory
  const ex = data.find(d => d.sku === kit.sku);
  if (ex) {
    ex.qty++;
    ex.updated = nowISO();
  } else {
    data.push({
      id: uid(),
      name: kit.name,
      sku: kit.sku,
      qty: 1,
      cost: cost,
      price: suggestedPrice,   // ✅ auto-suggested price
      packageQty: 1,
      unitsLoose: 0,
      singleOnly: true,
      measurable: false,
      forSale: true,
      restockOnly: false,
      notes: "Crafted Kit",
      photo: kit.photo || "",
      updated: nowISO()
    });
  }

  saveAll();
  render();
  renderKits();
}

/* Add Kit to Order */
function addKitToOrder(kitId) {
  const kit = kits.find(k => k.id === kitId);
  if (!kit) return alert("Kit not found.");

  let it = data.find(d => d.sku === kit.sku);
  if (!it) {
    it = {
      id: uid(),
      name: kit.name,
      sku: kit.sku,
      qty: 0,
      cost: kit.cost || 0,
      price: 0,
      packageQty: 1,
      unitsLoose: 0,
      singleOnly: true,
      measurable: false,
      forSale: true,
      restockOnly: false,
      notes: "Kit Item",
      photo: kit.photo || "",
      updated: nowISO()
    };
    data.push(it);
  }

  addToOrder(it.id, 1);
  saveAll();
  render();
}

/* Delete Kit */
function delKit(kitId) {
  if (!confirm("Delete this kit?")) return;
  kits = kits.filter(k => k.id !== kitId);
  saveAll();
  renderKits();
}

    /* ================= Rentals & Subscriptions management ================== */
    // Load rentals from localStorage
    function loadRentals() {
      try {
        const saved = LS.get('inv.rentals');
        rentals = Array.isArray(saved) ? saved : [];
      } catch (ex) {
        rentals = [];
      }
    }
    // Save rentals to localStorage
    function saveRentals() {
      LS.set('inv.rentals', rentals);
    }
    // Load subscriptions from localStorage
    function loadSubscriptions() {
      try {
        const saved = LS.get('inv.subs');
        subscriptions = Array.isArray(saved) ? saved : [];
      } catch (ex) {
        subscriptions = [];
      }
    }
    // Save subscriptions to localStorage
    function saveSubscriptions() {
      LS.set('inv.subs', subscriptions);
    }

    // Load shipments from localStorage
    function loadShipments() {
      try {
        const saved = LS.get('inv.shipments');
        shipments = Array.isArray(saved) ? saved : [];
      } catch (ex) {
        shipments = [];
      }
    }
    // Save shipments to localStorage
    function saveShipments() {
      LS.set('inv.shipments', shipments);
    }
    // Render rentals table
    function renderRentals() {
      const tbody = document.getElementById('rentalsBody');
      if (!tbody) return;
      if (!Array.isArray(rentals) || rentals.length === 0) {
        // 14 columns: ID, Customer, Equipment, Qty, Start, Due, Return, Fee, Deposit, Paid, Status, Recurring, Alert, Actions
        tbody.innerHTML = '<tr><td colspan="14" class="muted">No rentals defined.</td></tr>';
        return;
      }
      let html = '';
      const now = new Date().toISOString().slice(0,10);
      rentals.forEach(r => {
        const overdue = r.due && (!r.returnDate || r.returnDate === '') && r.due < now;
        const trStyle = overdue ? 'style="color:#dc3545"' : '';
        // Determine status
        let status = 'Active';
        if (r.returnDate) status = 'Returned';
        else if (r.due && r.due < now) status = 'Overdue';
        // Determine recurring (currently rentals do not recur; treat as No unless property set)
        const recurring = r.recurring ? 'Yes' : 'No';
        // Determine alert: overdue or due soon within 3 days if not returned
        let alert = '';
        if (!r.returnDate && r.due) {
          const dueDate = new Date(r.due);
          const diff = (dueDate - new Date(now)) / (1000*60*60*24);
          if (diff < 0) alert = 'Overdue';
          else if (diff <= 3) alert = 'Due soon';
        }
        html += `<tr ${trStyle}>`+
          `<td>${htmlEsc(r.id||'')}</td>`+
          `<td>${htmlEsc(r.customer||'')}</td>`+
          `<td>${htmlEsc(r.equipment||'')}</td>`+
          `<td class="right">${r.qty||0}</td>`+
          `<td>${htmlEsc(r.start||'')}</td>`+
          `<td>${htmlEsc(r.due||'')}</td>`+
          `<td>${htmlEsc(r.returnDate||'')}</td>`+
          `<td class="right">${fmt(r.fee||0)}</td>`+
          `<td class="right">${fmt(r.deposit||0)}</td>`+
          `<td class="right">${fmt(r.paid||0)}</td>`+
          `<td>${htmlEsc(status)}</td>`+
          `<td>${htmlEsc(recurring)}</td>`+
          `<td>${htmlEsc(alert)}</td>`+
          `<td class="center"><button class="btn small" data-act="editRental" data-id="${htmlEsc(r.id||'')}">Edit</button> <button class="btn small danger" data-act="delRental" data-id="${htmlEsc(r.id||'')}">Delete</button> <button class="btn small" data-act="invoiceRental" data-id="${htmlEsc(r.id||'')}">Invoice</button></td>`+
          `</tr>`;
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        btn.addEventListener('click', function() {
          if (act === 'editRental') {
            const r = rentals.find(x => x.id === id);
            openRentalDialog(r);
          } else if (act === 'delRental') {
            delRental(id);
          } else if (act === 'invoiceRental') {
            generateRentalInvoice(id);
          }
        });
      });
    }
    // Render subscriptions table
    function renderSubscriptions() {
      const tbody = document.getElementById('subsBody');
      if (!tbody) return;
      if (!Array.isArray(subscriptions) || subscriptions.length === 0) {
        // 12 columns: ID, Customer, Plan, Amount, Cycle, Start, Next Pay, Prev Pay, Status, Recurring, Alert, Actions
        tbody.innerHTML = '<tr><td colspan="12" class="muted">No subscriptions defined.</td></tr>';
        return;
      }
      let html = '';
      const now = new Date().toISOString().slice(0,10);
      subscriptions.forEach(s => {
        const overdue = s.status === 'overdue' || (s.nextPay && s.nextPay < now);
        const trStyle = overdue ? 'style="color:#dc3545"' : '';
        // Determine recurring and alert values
        const recurring = s.autoRenew !== false ? 'Yes' : 'No';
        let alert = '';
        if (s.status === 'overdue' || (s.nextPay && s.nextPay < now)) {
          alert = 'Overdue';
        } else if (s.nextPay) {
          const diff = (new Date(s.nextPay) - new Date(now)) / (1000*60*60*24);
          if (diff >= 0 && diff <= 7) alert = 'Due soon';
        }
        html += `<tr ${trStyle}>`+
          `<td>${htmlEsc(s.id||'')}</td>`+
          `<td>${htmlEsc(s.customer||'')}</td>`+
          `<td>${htmlEsc(s.plan||'')}</td>`+
          `<td class="right">${fmt(s.amount||0)}</td>`+
          `<td>${htmlEsc(s.cycle||'')}</td>`+
          `<td>${htmlEsc(s.start||'')}</td>`+
          `<td>${htmlEsc(s.nextPay||'')}</td>`+
          `<td>${htmlEsc(s.prevPay||'')}</td>`+
          `<td>${htmlEsc(s.status||'')}</td>`+
          `<td>${htmlEsc(recurring)}</td>`+
          `<td>${htmlEsc(alert)}</td>`+
          `<td class="center"><button class="btn small" data-act="editSub" data-id="${htmlEsc(s.id||'')}">Edit</button> <button class="btn small danger" data-act="delSub" data-id="${htmlEsc(s.id||'')}">Delete</button> <button class="btn small" data-act="invoiceSub" data-id="${htmlEsc(s.id||'')}">Invoice</button></td>`+
          `</tr>`;
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        btn.addEventListener('click', function() {
          if (act === 'editSub') {
            const s = subscriptions.find(x => x.id === id);
            openSubscriptionDialog(s);
          } else if (act === 'delSub') {
            delSubscription(id);
          } else if (act === 'invoiceSub') {
            generateSubscriptionInvoice(id);
          }
        });
      });
    }

    // Render saved shipments table
    function renderShipments() {
      const tbody = document.getElementById('shipRows');
      if (!tbody) return;
      if (!Array.isArray(shipments) || shipments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">No shipments saved.</td></tr>';
        return;
      }
      let html = '';
      shipments.forEach(sh => {
        html += `<tr>`+
          `<td><button class="btn small" data-act="trackShip" data-id="${htmlEsc(sh.id)}">${htmlEsc(sh.number)}</button></td>`+
          `<td>${htmlEsc(sh.carrier||'')}</td>`+
          `<td>${htmlEsc(new Date(sh.date).toLocaleDateString())}</td>`+
          `<td class="center"><button class="btn small danger" data-act="delShip" data-id="${htmlEsc(sh.id)}">Delete</button></td>`+
          `</tr>`;
      });
      tbody.innerHTML = html;
      tbody.querySelectorAll('button[data-act]').forEach(btn => {
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        btn.addEventListener('click', function(){
          if (act === 'trackShip') {
            const sh = shipments.find(x => x.id === id);
            if (sh) {
              const url = getTrackingURL(sh.carrier, sh.number);
              if (url) window.open(url, '_blank');
            }
          } else if (act === 'delShip') {
            shipments = shipments.filter(x => x.id !== id);
            saveShipments();
            renderShipments();
          }
        });
      });
    }
    // Open rental dialog (new or edit)
    function openRentalDialog(r) {
      const dlg = document.getElementById('dlgRental');
      if (!dlg) return;
      document.getElementById('rentalTitle').textContent = r ? 'Edit Rental' : 'New Rental';
      $('#rentalId').value = r?.id || '';
      $('#rentalCustomer').value = r?.customer || '';
      $('#rentalEquipment').value = r?.equipment || '';
      $('#rentalQty').value = r?.qty || 1;
      $('#rentalStart').value = r?.start || '';
      $('#rentalDue').value = r?.due || '';
      $('#rentalReturn').value = r?.returnDate || '';
      $('#rentalFee').value = r?.fee || 0;
      $('#rentalDeposit').value = r?.deposit || 0;
      $('#rentalPaid').value = r?.paid || 0;
      $('#rentalPayDate').value = r?.payDate || '';
      $('#rentalNotes').value = r?.notes || '';
      showDialog(dlg);
    }
    // Save rental from dialog
    function saveRentalDialog() {
      const id = $('#rentalId').value || uid();
      const rental = {
        id: id,
        customer: $('#rentalCustomer').value.trim(),
        equipment: $('#rentalEquipment').value.trim(),
        qty: +$('#rentalQty').value || 1,
        start: $('#rentalStart').value,
        due: $('#rentalDue').value,
        returnDate: $('#rentalReturn').value,
        fee: +$('#rentalFee').value || 0,
        deposit: +$('#rentalDeposit').value || 0,
        paid: +$('#rentalPaid').value || 0,
        payDate: $('#rentalPayDate').value,
        notes: $('#rentalNotes').value.trim()
      };
      if (!rental.customer || !rental.equipment) {
        alert('Customer and Equipment are required.');
        return;
      }
      const idx = rentals.findIndex(x => x.id === id);
      if (idx >= 0) rentals[idx] = rental;
      else rentals.push(rental);
      saveRentals();
      renderRentals();
      hideDialog(document.getElementById('dlgRental'));
    }
    // Delete a rental
    function delRental(id) {
      const r = rentals.find(x => x.id === id);
      if (!r) return;
      if (!confirm('Delete rental ' + (r.id || '') + '?')) return;
      rentals = rentals.filter(x => x.id !== id);
      saveRentals();
      renderRentals();
    }
    // Generate invoice for rental
    function generateRentalInvoice(id) {
      const r = rentals.find(x => x.id === id);
      if (!r) return;
      const items = [];
      items.push({ name: 'Rental - ' + (r.equipment || ''), sku: '', qty: r.qty || 1, price: r.fee || 0 });
      if ((r.deposit || 0) > 0) {
        items.push({ name: 'Deposit for ' + (r.equipment || ''), sku: '', qty: 1, price: r.deposit || 0 });
      }
      const inv = buildInvoice({
        from: settings?.companyName || 'Your Company',
        billTo: r.customer || '',
        items: items,
        taxRate: 0,
        notes: r.notes || '',
        footerNotes: settings.footerNotes || '',
        footerImage: settings.footerImage || ''
      });
      openInvoiceWindow(inv);
    }
    // Open subscription dialog (new or edit)
    function openSubscriptionDialog(s) {
      const dlg = document.getElementById('dlgSubscription');
      if (!dlg) return;
      document.getElementById('subTitle').textContent = s ? 'Edit Subscription' : 'New Subscription';
      $('#subId').value = s?.id || '';
      $('#subCustomer').value = s?.customer || '';
      $('#subPlan').value = s?.plan || '';
      $('#subAmount').value = s?.amount || 0;
      $('#subCycle').value = s?.cycle || 'monthly';
      $('#subStart').value = s?.start || '';
      $('#subNextPay').value = s?.nextPay || '';
      $('#subPrevPay').value = s?.prevPay || '';
      $('#subStatus').value = s?.status || 'active';
      document.getElementById('subAutoRenew').checked = s?.autoRenew !== false;
      $('#subNotes').value = s?.notes || '';
      showDialog(dlg);
    }
    // Save subscription from dialog
    function saveSubscriptionDialog() {
      const id = $('#subId').value || uid();
      const sub = {
        id: id,
        customer: $('#subCustomer').value.trim(),
        plan: $('#subPlan').value.trim(),
        amount: +$('#subAmount').value || 0,
        cycle: $('#subCycle').value,
        start: $('#subStart').value,
        nextPay: $('#subNextPay').value,
        prevPay: $('#subPrevPay').value,
        status: $('#subStatus').value,
        autoRenew: !!document.getElementById('subAutoRenew').checked,
        notes: $('#subNotes').value.trim()
      };
      if (!sub.customer || !sub.plan) {
        alert('Customer and Plan are required.');
        return;
      }
      const idx = subscriptions.findIndex(x => x.id === id);
      if (idx >= 0) subscriptions[idx] = sub;
      else subscriptions.push(sub);
      saveSubscriptions();
      renderSubscriptions();
      hideDialog(document.getElementById('dlgSubscription'));
    }
    // Delete a subscription
    function delSubscription(id) {
      const s = subscriptions.find(x => x.id === id);
      if (!s) return;
      if (!confirm('Delete subscription ' + (s.id || '') + '?')) return;
      subscriptions = subscriptions.filter(x => x.id !== id);
      saveSubscriptions();
      renderSubscriptions();
    }
    // Generate invoice for subscription
    function generateSubscriptionInvoice(id) {
      const s = subscriptions.find(x => x.id === id);
      if (!s) return;
      const inv = buildInvoice({
        from: settings?.companyName || 'Your Company',
        billTo: s.customer || '',
        items: [
          { name: 'Subscription - ' + (s.plan || ''), sku: '', qty: 1, price: s.amount || 0 }
        ],
        taxRate: 0,
        notes: s.notes || '',
        footerNotes: settings.footerNotes || '',
        footerImage: settings.footerImage || ''
      });
      openInvoiceWindow(inv);
    }
    // Switch between rentals and subscriptions subviews
    function switchRentalSubView(view) {
      document.querySelectorAll('aside[data-view="rentals"] [data-subview]').forEach(function(el) {
        if (el.getAttribute('data-subview') === view) {
          el.style.display = '';
        } else {
          el.style.display = 'none';
        }
      });
      document.querySelectorAll('#rentalsSubTabs [data-subview]').forEach(function(el) {
        if (el.getAttribute('data-subview') === view) el.classList.add('active');
        else el.classList.remove('active');
      });
    }

    /* =========================
       Shipment Tracking helpers
       ========================= */
    function detectCarrier(num) {
      const n = String(num || '').trim();
      if (/^1Z/i.test(n)) return 'UPS';
      // FedEx: 12–15 digits
      if (/^\d{12,15}$/.test(n)) return 'FedEx';
      // USPS: 2 letters + 9 digits + 2 letters
      if (/^[A-Z]{2}\d{9}[A-Z]{2}$/i.test(n)) return 'USPS';
      // DHL: 10–14 digits
      if (/^\d{10,14}$/.test(n)) return 'DHL';
      return 'Other';
    }
    function getTrackingURL(carrier, num) {
      const encoded = encodeURIComponent(num);
      switch(carrier){
        case 'UPS': return `https://wwwapps.ups.com/WebTracking/track?track=yes&trackNums=${encoded}`;
        case 'FedEx': return `https://www.fedex.com/fedextrack/?trknbr=${encoded}`;
        case 'USPS': return `https://tools.usps.com/go/TrackConfirmAction?qtc_tLabels1=${encoded}`;
        case 'DHL': return `https://www.dhl.com/en/express/tracking.html?AWB=${encoded}&brand=DHL`;
        case 'Other': return '';
        default: return '';
      }
    }
    function trackPackage() {
      const num = document.getElementById('trackNumber')?.value.trim();
      if(!num){ alert('Please enter a tracking number'); return; }
      let carrier = document.getElementById('trackCarrier')?.value || 'auto';
      if(!carrier || carrier === 'auto'){ carrier = detectCarrier(num); }
      const url = getTrackingURL(carrier, num);
      if(url){
        // Save shipment to history
        try {
          const sh = { id: (typeof uid === 'function' ? uid() : (Date.now().toString(36))), number: num, carrier: carrier, date: new Date().toISOString() };
          shipments.push(sh);
          saveShipments();
          renderShipments();
        } catch(ex){}
        window.open(url, '_blank');
      } else {
        alert('Unable to determine carrier for this tracking number.');
      }
    }
    /* End rentals & subscriptions management */

/* Wire */
$("#btnAddKit").addEventListener("click", saveKit);
renderKits();




/* end of file */
</script>

<!-- ============================================ -->
<!-- LOCATION DIALOG (Day 12) -->
<!-- ============================================ -->
<div id="locationDialog" class="dialog" style="display: none;">
  <div class="dialogContent">
    <div class="dialog-header">
      <h2 class="dialog-title">New Location</h2>
      <button class="btn" onclick="LocationUI.closeLocationDialog()" title="Close">✕</button>
    </div>

    <form id="locationForm" onsubmit="event.preventDefault(); LocationUI.saveLocation();">
      <div class="form-group">
        <label for="locationName">Location Name *</label>
        <input type="text" id="locationName" class="field" required maxlength="100" placeholder="e.g., Main Warehouse">
      </div>

      <div class="form-group">
        <label for="locationType">Type</label>
        <select id="locationType" class="field">
          <option value="warehouse">Warehouse</option>
          <option value="store">Store</option>
          <option value="vehicle">Vehicle</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="locationAddress">Address</label>
        <input type="text" id="locationAddress" class="field" placeholder="Optional address">
      </div>

      <div class="form-group">
        <label for="locationNotes">Notes</label>
        <textarea id="locationNotes" class="field" rows="3" placeholder="Optional notes"></textarea>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="locationActive" checked>
          Active
        </label>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" id="locationDefault">
          Set as default location
        </label>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn" style="background: var(--accent)">Save</button>
        <button type="button" class="btn" onclick="LocationUI.closeLocationDialog()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- ============================================ -->
<!-- TRANSFER DIALOG (Day 12) -->
<!-- ============================================ -->
<div id="transferDialog" class="dialog" style="display: none;">
  <div class="dialogContent">
    <div class="dialog-header">
      <h2 class="dialog-title">New Transfer</h2>
      <button class="btn" onclick="TransferUI.closeTransferDialog()" title="Close">✕</button>
    </div>

    <form id="transferForm" onsubmit="event.preventDefault(); TransferUI.saveTransfer();">
      <div class="form-group">
        <label for="transferProduct">Product *</label>
        <select id="transferProduct" class="field" required onchange="TransferUI.updateTransferAvailableStock()">
          <option value="">-- Select Product --</option>
          <!-- Will be populated by JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex: 1">
          <label for="transferFrom">From Location *</label>
          <select id="transferFrom" class="field" required onchange="TransferUI.updateTransferAvailableStock()">
            <option value="">-- Select Location --</option>
            <!-- Will be populated by JavaScript -->
          </select>
        </div>

        <div class="form-group" style="flex: 1">
          <label for="transferTo">To Location *</label>
          <select id="transferTo" class="field" required>
            <option value="">-- Select Location --</option>
            <!-- Will be populated by JavaScript -->
          </select>
        </div>
      </div>

      <div class="form-group">
        <label>Available Stock at Source</label>
        <div id="transferAvailableStock" style="padding: 8px; background: var(--bg2); border-radius: 4px; color: var(--accent)">-</div>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex: 1">
          <label for="transferQty">Quantity (Cases) *</label>
          <input type="number" id="transferQty" class="field" min="0" value="0" required>
        </div>

        <div class="form-group" style="flex: 1">
          <label for="transferLoose">Loose Units</label>
          <input type="number" id="transferLoose" class="field" min="0" value="0">
        </div>
      </div>

      <div class="form-group">
        <label for="transferDate">Transfer Date *</label>
        <input type="date" id="transferDate" class="field" required>
      </div>

      <div class="form-group">
        <label for="transferReason">Reason</label>
        <select id="transferReason" class="field">
          <option value="Restock">Restock</option>
          <option value="Sale">Sale</option>
          <option value="Damaged">Damaged</option>
          <option value="Adjustment">Adjustment</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="transferNotes">Notes</label>
        <textarea id="transferNotes" class="field" rows="3" placeholder="Optional notes"></textarea>
      </div>

      <div class="btn-group">
        <button type="submit" class="btn" style="background: var(--accent)">Save Transfer</button>
        <button type="button" class="btn" onclick="TransferUI.closeTransferDialog()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Order Dialog -->
<div id="orderDialog" class="dialog" style="display: none;">
  <div class="dialogContent" style="max-width: 1200px;">
    <div class="dialog-header">
      <h2 id="orderDialogTitle" class="dialog-title">New Order</h2>
      <button class="btn" onclick="OrderUI.closeOrderDialog()" title="Close">✕</button>
    </div>

    <form id="orderForm" onsubmit="event.preventDefault(); ActionRegistry.execute('save-order');">
      <!-- Hidden ID field -->
      <input type="hidden" id="order_id">
      <input type="hidden" id="order_orderNumber">

      <!-- Customer Information -->
      <fieldset style="border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
        <legend style="padding: 0 0.5rem; font-weight: bold;">Customer Information</legend>

        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label for="order_customerName">Customer Name *</label>
            <input type="text" id="order_customerName" class="field" placeholder="Customer name" required>
          </div>

          <div class="form-group" style="flex: 1">
            <label for="order_customerId">Customer ID</label>
            <input type="text" id="order_customerId" class="field" placeholder="Optional customer ID">
          </div>
        </div>

        <div class="form-group">
          <label for="order_shippingAddress">Shipping Address</label>
          <textarea id="order_shippingAddress" class="field" rows="2" placeholder="Optional shipping address"></textarea>
        </div>
      </fieldset>

      <!-- Order Information -->
      <fieldset style="border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
        <legend style="padding: 0 0.5rem; font-weight: bold;">Order Information</legend>

        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label for="order_orderDate">Order Date *</label>
            <input type="date" id="order_orderDate" class="field" required>
          </div>

          <div class="form-group" style="flex: 1">
            <label for="order_status">Status</label>
            <select id="order_status" class="field">
              <option value="draft">Draft</option>
              <option value="pending">Pending</option>
              <option value="fulfilled">Fulfilled</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label for="order_paymentMethod">Payment Method</label>
            <select id="order_paymentMethod" class="field">
              <option value="">-- Select --</option>
              <option value="Cash">Cash</option>
              <option value="Credit Card">Credit Card</option>
              <option value="Debit Card">Debit Card</option>
              <option value="Check">Check</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group" style="flex: 1">
            <label for="order_paymentStatus">Payment Status</label>
            <select id="order_paymentStatus" class="field">
              <option value="unpaid">Unpaid</option>
              <option value="partial">Partial</option>
              <option value="paid">Paid</option>
              <option value="refunded">Refunded</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="order_notes">Order Notes</label>
          <textarea id="order_notes" class="field" rows="2" placeholder="Optional notes"></textarea>
        </div>
      </fieldset>

      <!-- Line Items -->
      <fieldset style="border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
        <legend style="padding: 0 0.5rem; font-weight: bold;">Line Items</legend>

        <div style="margin-bottom: 1rem;">
          <button type="button" id="btnAddLineItem" class="btn" style="background: var(--accent)">➕ Add Product</button>
        </div>

        <div style="overflow-x: auto;">
          <table class="table" style="min-width: 100%;">
            <thead>
              <tr>
                <th style="min-width: 150px;">Product</th>
                <th style="min-width: 80px;">SKU</th>
                <th style="min-width: 60px;">Qty</th>
                <th style="min-width: 80px;">Price</th>
                <th style="min-width: 80px;">Subtotal</th>
                <th style="min-width: 120px;">Discount</th>
                <th style="min-width: 80px;">Tax</th>
                <th style="min-width: 80px;">Total</th>
                <th style="min-width: 50px;"></th>
              </tr>
            </thead>
            <tbody id="orderLineItemsBody">
              <tr><td colspan="9" style="text-align:center;padding:1rem;color:#999">No items added</td></tr>
            </tbody>
          </table>
        </div>
      </fieldset>

      <!-- Order Totals -->
      <fieldset style="border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; border-radius: 4px;">
        <legend style="padding: 0 0.5rem; font-weight: bold;">Order Totals & Discounts</legend>

        <div class="form-row">
          <div class="form-group" style="flex: 1">
            <label for="order_discount">Order Discount</label>
            <input type="number" id="order_discount" class="field" min="0" step="0.01" value="0">
          </div>

          <div class="form-group" style="flex: 1">
            <label for="order_discountType">Discount Type</label>
            <select id="order_discountType" class="field">
              <option value="percentage">Percentage (%)</option>
              <option value="fixed">Fixed Amount ($)</option>
            </select>
          </div>

          <div class="form-group" style="flex: 1">
            <label for="order_taxRate">Tax Rate (%)</label>
            <input type="number" id="order_taxRate" class="field" min="0" max="100" step="0.01" value="0">
          </div>
        </div>

        <div style="background: var(--bg2); padding: 1rem; border-radius: 4px; margin-top: 1rem;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Subtotal:</span>
            <strong id="orderSubtotal">$0.00</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Discount:</span>
            <strong id="orderDiscountAmount">$0.00</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>Tax:</span>
            <strong id="orderTaxAmount">$0.00</strong>
          </div>
          <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid var(--border); font-size: 1.2em;">
            <span>Total:</span>
            <strong id="orderTotal" style="color: var(--accent)">$0.00</strong>
          </div>
        </div>
      </fieldset>

      <div class="btn-group">
        <button type="submit" class="btn" style="background: var(--accent)">Save Order</button>
        <button type="button" class="btn" onclick="OrderUI.closeOrderDialog()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" class="toast-container"></div>

</body>
</html>
